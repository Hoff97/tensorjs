(this.webpackJsonpstyle=this.webpackJsonpstyle||[]).push([[0],{101:function(e,t,n){"use strict";n.r(t);var a=n(15),i=n(2),r=n.n(i),s=n(20),o=n.n(s),u=(n(77),n(5)),c=n.n(u),h=n(10),l=n(21),p=n(60),f=n(0),d=n(1),v=n(4),m=n(3),y=(n(79),n(55)),g=n.n(y),w=n(8),k=n(7),b=n(16),x=n(13);function O(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0===e.length)return t;for(var n=1,a=0;a<e.length;a+=1)n*=e[a];return n}function j(e){var t=e.length;if(0===t)return[];if(1===t)return 1===e[0]?[0]:[1];var n=new Array(t);n[t-1]=1,1===e[t-1]&&(n[t-1]=0);for(var a=1,i=t-2;i>=0;i-=1)a=e[i+1]*a,1===e[i]?n[i]=0:n[i]=a;return n}function S(e,t,n){for(var a=0,i=0;i<e.length;i+=1){if(n&&(e[i]<0||e[i]>=n[i]&&1!==n[i]))throw new Error("Invalid index");a+=e[i]*t[i]}return a}function A(e,t){for(var n=e,a=t.length,i=new Array(a),r=0;r<i.length;r+=1)i[r]=Math.floor(n/t[r]),n%=t[r];return i}function M(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n+=1)if(e[n]!==t[n])return!1;return!0}function I(e,t){for(var n=e.length-1;n>=0&&(e[n]+=1,e[n]>=t[n]);n--)e[n]=0}var T=function(e,t,n,a){return new(n||(n=Promise))((function(i,r){function s(e){try{u(a.next(e))}catch(t){r(t)}}function o(e){try{u(a.throw(e))}catch(t){r(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}u((a=a.apply(e,t||[])).next())}))},V={float64:Float64Array,float32:Float32Array,float16:Float32Array,int32:Int32Array,int16:Int16Array,int8:Int8Array,uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array},D=function(){function e(t){Object(f.a)(this,e),this.dtype=t}return Object(d.a)(e,[{key:"compare",value:function(e,t){return T(this,void 0,void 0,c.a.mark((function n(){var a,i,r,s;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(M(this.getShape(),e.getShape())){n.next=2;break}return n.abrupt("return",!1);case 2:return n.next=4,this.getValues();case 4:return a=n.sent,n.next=7,e.getValues();case 7:if(i=n.sent,void 0===t){n.next=18;break}r=0;case 10:if(!(r<a.length)){n.next=16;break}if(!(Math.abs(a[r]-i[r])>t)){n.next=13;break}return n.abrupt("return",!1);case 13:r+=1,n.next=10;break;case 16:n.next=25;break;case 18:s=0;case 19:if(!(s<a.length)){n.next=25;break}if(a[s]===i[s]){n.next=22;break}return n.abrupt("return",!1);case 22:s+=1,n.next=19;break;case 25:return n.abrupt("return",!0);case 26:case"end":return n.stop()}}),n,this)})))}},{key:"getAxes",value:function(e){var t,n=this.getShape();if(void 0===e){t=[];for(var a=0;a<n.length;a++)t.push(a)}else if(e instanceof Array){t=e;for(var i=0;i<t.length;i++)t[i]<0&&(t[i]+=this.getShape().length)}else t=[e];return t}},{key:"sum",value:function(e,t){var n=this.getAxes(e);return t=t||!1,this.sum_impl(n,t)}},{key:"sumSquare",value:function(e,t){var n=this.getAxes(e);return t=t||!1,this.sumSquare_impl(n,t)}},{key:"product",value:function(e,t){var n=this.getAxes(e);return t=t||!1,this.product_impl(n,t)}},{key:"max",value:function(e,t){var n=this.getAxes(e);return t=t||!1,this.max_impl(n,t)}},{key:"min",value:function(e,t){var n=this.getAxes(e);return t=t||!1,this.min_impl(n,t)}},{key:"reduceMean",value:function(e,t){var n=this.getAxes(e);return t=t||!1,this.reduceMean_impl(n,t)}},{key:"reduceLogSum",value:function(e,t){var n=this.getAxes(e);return t=t||!1,this.reduceLogSum_impl(n.sort(),t)}},{key:"reduceLogSumExp",value:function(e,t){var n=this.getAxes(e);return t=t||!1,this.reduceLogSumExp_impl(n,t)}},{key:"reduceMeanSquare",value:function(e,t){var n=this.getAxes(e);return t=t||!1,this.reduceMeanSquare_impl(n,t)}},{key:"conv",value:function(e,t,n,a,i,r,s){var o=this.getShape().length-2;return n=n||new Array(o).fill(1),a=a||1,i=i||new Array(2*o).fill(0),r=r||new Array(o).fill(1),void 0===s&&(s="id"),this.conv_impl(e,n,a,i,r,s,t)}},{key:"convTranspose",value:function(e,t,n,a,i){var r=this.getShape().length-2;return t=t||new Array(r).fill(1),n=n||1,a=a||new Array(2*r).fill(0),i=i||new Array(r).fill(1),this.convTranspose_impl(e,t,n,a,i)}},{key:"pad",value:function(e,t,n){return void 0===t&&(t="constant"),void 0===n&&(n=0),this.pad_impl(e,t,n)}},{key:"averagePool",value:function(e,t,n,a){var i=this.getShape().length-2;return t=t||new Array(2*i).fill(0),n=n||new Array(i).fill(1),a=a||!1,this.averagePool_impl(e,t,n,a)}},{key:"reshape",value:function(e,t){for(var n=1,a=-1,i=0;i<e.length;i++)-1===e[i]?a=i:n*=e[i];if(void 0===t&&(t=!0),-1!==a){var r=O(this.getShape()),s=Object(h.a)(e);return s[a]=r/n,this.reshape_impl(s,t)}return this.reshape_impl(e,t)}},{key:"alignShapes",value:function(e,t){if(M(e,t))return[e,t,e];if(e.length<t.length){var n;e=Object(h.a)(e);var a=t.length-e.length;(n=e).unshift.apply(n,Object(h.a)(new Array(a).fill(1)))}else if(t.length<e.length){var i;t=Object(h.a)(t);var r=e.length-t.length;(i=t).unshift.apply(i,Object(h.a)(new Array(r).fill(1)))}for(var s=new Array(e.length).fill(1),o=0;o<e.length;o++)s[o]=Math.max(e[o],t[o]);return[e,t,s]}},{key:"alignTensor",value:function(e){var t=this.getShape(),n=e.getShape();if(M(t,n))return[this,e,t];var a=this;if(t.length<n.length){var i;t=Object(h.a)(t);var r=n.length-t.length;(i=t).unshift.apply(i,Object(h.a)(new Array(r).fill(1))),a=this.reshape(t,!1)}else if(n.length<t.length){var s;n=Object(h.a)(n);var o=t.length-n.length;(s=n).unshift.apply(s,Object(h.a)(new Array(o).fill(1))),e=e.reshape(n,!1)}for(var u=new Array(t.length).fill(1),c=0;c<t.length;c++)u[c]=Math.max(t[c],n[c]);return[a,e,u]}},{key:"add",value:function(e,t,n){void 0===t&&(t=1),void 0===n&&(n=1);var a=this.alignTensor(e),i=Object(x.a)(a,3),r=i[0],s=i[1],o=i[2];return this.add_impl(r,s,o,t,n)}},{key:"subtract",value:function(e,t,n){void 0===t&&(t=1),void 0===n&&(n=1);var a=this.alignTensor(e),i=Object(x.a)(a,3),r=i[0],s=i[1],o=i[2];return this.subtract_impl(r,s,o,t,n)}},{key:"multiply",value:function(e,t){void 0===t&&(t=1);var n=this.alignTensor(e),a=Object(x.a)(n,3),i=a[0],r=a[1],s=a[2];return this.multiply_impl(i,r,s,t)}},{key:"multiplyScalar",value:function(e){return this.addMultiplyScalar(e,0)}},{key:"addScalar",value:function(e){return this.addMultiplyScalar(1,e)}},{key:"divide",value:function(e,t){void 0===t&&(t=1);var n=this.alignTensor(e),a=Object(x.a)(n,3),i=a[0],r=a[1],s=a[2];return this.divide_impl(i,r,s,t)}},{key:"power",value:function(e){var t=this.alignTensor(e),n=Object(x.a)(t,3),a=n[0],i=n[1],r=n[2];return this.power_impl(a,i,r)}},{key:"transpose",value:function(e){if(void 0===e){var t=this.getShape().length;e=[];for(var n=0;n<t;n++)e.push(t-n-1)}return this.transpose_impl(e)}},{key:"softmax",value:function(e){var t=this.max(e,!0),n=this.subtract(t),a=n.exp(),i=a.sum(e,!0),r=a.divide(i);return t.delete(),n.delete(),a.delete(),i.delete(),r}},{key:"gemm",value:function(e,t,n,a,i,r){if(t=t||!1,n=n||!1,a=void 0!==a?a:1,r=void 0!==r?r:1,void 0!==i){var s=this.getShape(),o=i.getShape(),u=s.length,c=o.length;u>c&&(o=[].concat(Object(h.a)(new Array(u-c).fill(1)),Object(h.a)(o)),i=i.reshape(o,!1))}return this.gemm_impl(e,t,n,a,r,i)}},{key:"slice",value:function(e,t,n,a){var i=this.getShape(),r=i.length;if(void 0===n){n=[];for(var s=0;s<r;s++)n.push(s)}else n=n.map((function(e){return e<0?e+r:e}));void 0===a&&(a=new Array(r).fill(1)),e=Object(h.a)(e),t=Object(h.a)(t);for(var o=0;o<n.length;o++){var u=i[n[o]];e[o]<0?e[o]+=u:e[o]>=u&&(a[o]>0?e[o]=u:e[o]=u-1),t[o]<0?t[o]+=u:t[o]>=u&&(t[o]=u)}return this.slice_impl(e,t,n,a)}},{key:"squeeze",value:function(){var e,t=this.getShape(),n=[],a=Object(b.a)(t);try{for(a.s();!(e=a.n()).done;){var i=e.value;1!==i&&n.push(i)}}catch(r){a.e(r)}finally{a.f()}return this.reshape(n)}},{key:"flatten",value:function(e){void 0===e&&(e=1);var t=this.getShape();e<0&&(e+=t.length);var n=[O(t.slice(0,e),1),O(t.slice(e),1)];return this.reshape(n)}}]),e}();function X(e,t,n,a,i,r){var s=i*(t-1)+1;return Math.floor((e+n+a-s)/r+1)}function C(e,t,n,a,i,r){for(var s=[],o=0;o<e.length;o++)s.push(X(e[o],t[o],n[o],a[o],i[o],r[o]));return s}function _(e,t){for(var n=new B(e.shape,void 0,e.dtype),a=0;a<n.size;a+=1)n.set(a,t(e.get(a)));return n}function G(e,t,n,a){if(!function(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n+=1)if(e[n]!==t[n]&&1!==e[n]&&1!==t[n])return!1;return!0}(e.shape,t.shape))throw new Error("The shapes of the two tensors should be the same for a binary operation");for(var i=new B(a,void 0,e.dtype),r=new Array(a.length).fill(0),s=0;s<i.size;s+=1)i.set(r,n(e.get(r),t.get(r))),I(r,a);return i}function E(e,t,n){return _(e,(function(e){return e*t+n}))}function R(e,t,n,a,i,r){for(var s,o,u,c,h,l=[],p=0;p<e.length;p++)l.push((s=e[p],o=t[p],u=n[p],c=a[p],h=i[p],r[p]*(s-1)+u+c-(h*(o-1)+1)+2));return l}function P(e,t,n){for(var a=[],i=[],r=[],s=0;s<e.length;s++)t.includes(s)?(n&&(a.push(1),r.push(s)),i.push(e[s])):(a.push(e[s]),r.push(s));return 0===a.length&&a.push(1),[a,r]}function U(e,t,n,a,i){for(var r=e.getShape(),s=O(r),o=P(r,t,a),u=Object(x.a)(o,2),c=u[0],h=u[1],l=O(c),p=j(c),f=new B(c,void 0,e.dtype),d=new Array(l).fill(!1),v=new Array(r.length).fill(0),m=new Array(c.length).fill(0),y=0;y<s;y++){for(var g=0;g<h.length;g++)m[g]=v[h[g]];var w=S(m,p);d[w]?f.set(m,n(e.get(y),f.get(m))):(d[w]=!0,f.set(m,n(e.get(y)))),I(v,r)}if(i)for(var k=0;k<f.size;k++)f.set(k,i(f.get(k)));return f}function z(e,t,n,a,i){if(i)return e.get(t);var r=e.shape.length;if("constant"===n)return a;if("edge"===n)for(var s=0;s<r;s++)t[s]<0?t[s]=0:t[s]>=e.shape[s]&&(t[s]=e.shape[s]-1);else for(var o=0;o<r;o++)t[o]<0?t[o]=-t[o]:t[o]>=e.shape[o]&&(t[o]=2*e.shape[o]-t[o]-2);return e.get(t)}var B=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,i||"float32")).deleted=!1,r.shape=e,r.strides=j(e),r.size=O(e),r.values=void 0!==a?a instanceof Array?new V[r.dtype](a):a:new V[r.dtype](r.size),r}return Object(d.a)(n,[{key:"getValues",value:function(){return Promise.resolve(this.values)}},{key:"getShape",value:function(){return this.shape}},{key:"constantLike",value:function(e){return new n(this.shape,new V[this.dtype](this.size).fill(e),this.dtype)}},{key:"singleConstant",value:function(e){return new n([1],[e],this.dtype)}},{key:"cast",value:function(e){return new n(this.shape,Array.from(this.values),e)}},{key:"delete",value:function(){this.values=void 0,this.deleted=!0}},{key:"copy",value:function(e){void 0===e&&(e=Object(h.a)(this.shape));for(var t=new V[this.dtype](this.size),a=0;a<this.size;a++)t[a]=this.values[a];return new n(e,t,this.dtype)}},{key:"get",value:function(e){var t;return t=Array.isArray(e)?S(e,this.strides,this.shape):e,this.values[t]}},{key:"set",value:function(e,t){var n;n=Array.isArray(e)?S(e,this.strides):e,this.values[n]=t}},{key:"setValues",value:function(e,t){if(!(e instanceof n))throw new Error("Can only set CPU values to CPU values");return function(e,t,n){for(var a=new B(e.shape,void 0,e.dtype),i=new Array(e.shape.length).fill(0),r=0;r<a.size;r+=1){for(var s=!0,o=new Array(n.length).fill(0),u=0;u<n.length;u++){if(i[u]<n[u]||i[u]>=n[u]+t.shape[u]){s=!1;break}o[u]=i[u]-n[u]}s?a.set(r,t.get(o)):a.set(r,e.get(r)),I(i,e.shape)}return a}(this,e,t)}},{key:"exp",value:function(){return _(this,(function(e){return Math.exp(e)}))}},{key:"log",value:function(){return _(this,(function(e){return Math.log(e)}))}},{key:"sqrt",value:function(){return _(this,(function(e){return Math.sqrt(e)}))}},{key:"abs",value:function(){return _(this,(function(e){return Math.abs(e)}))}},{key:"sin",value:function(){return _(this,(function(e){return Math.sin(e)}))}},{key:"cos",value:function(){return _(this,(function(e){return Math.cos(e)}))}},{key:"tan",value:function(){return _(this,(function(e){return Math.tan(e)}))}},{key:"asin",value:function(){return _(this,(function(e){return Math.asin(e)}))}},{key:"acos",value:function(){return _(this,(function(e){return Math.acos(e)}))}},{key:"atan",value:function(){return _(this,(function(e){return Math.atan(e)}))}},{key:"sinh",value:function(){return _(this,(function(e){return Math.sinh(e)}))}},{key:"cosh",value:function(){return _(this,(function(e){return Math.cosh(e)}))}},{key:"tanh",value:function(){return _(this,(function(e){return Math.tanh(e)}))}},{key:"asinh",value:function(){return _(this,(function(e){return Math.asinh(e)}))}},{key:"acosh",value:function(){return _(this,(function(e){return Math.acosh(e)}))}},{key:"atanh",value:function(){return _(this,(function(e){return Math.atanh(e)}))}},{key:"floor",value:function(){return _(this,(function(e){return Math.floor(e)}))}},{key:"ceil",value:function(){return _(this,(function(e){return Math.ceil(e)}))}},{key:"round",value:function(){return _(this,(function(e){return Math.round(e)}))}},{key:"negate",value:function(){return _(this,(function(e){return-e}))}},{key:"powerScalar",value:function(e,t){return function(e,t,n){return _(e,(function(e){return Math.pow(e,t)*n}))}(this,e,t)}},{key:"multiplyScalar",value:function(e){return E(this,e,0)}},{key:"addScalar",value:function(e){return E(this,1,e)}},{key:"addMultiplyScalar",value:function(e,t){return E(this,e,t)}},{key:"sign",value:function(){return _(this,(function(e){return e<0?-1:0===e?0:1}))}},{key:"clip",value:function(e,t){return function(e,t,n){var a=function(e){return e};return void 0!==t&&void 0!==n?a=function(e){return Math.min(n,Math.max(t,e))}:void 0!==n?a=function(e){return Math.min(n,e)}:void 0!==t&&(a=function(e){return Math.max(t,e)}),_(e,a)}(this,e,t)}},{key:"clipBackward",value:function(e,t,a){if(!(e instanceof n))throw new Error("Can only do clipBackward with CPUTensor");return function(e,t,n,a,i){return G(e,t,(function(e,t){return void 0!==a&&e<a||void 0!==i&&e>i?0:t}),n)}(this,e,this.getShape(),t,a)}},{key:"sigmoid",value:function(){return _(this,(function(e){return 1/(1+Math.exp(-e))}))}},{key:"hardSigmoid",value:function(e,t){return function(e,t,n){return _(e,(function(e){return Math.max(0,Math.min(1,t*e+n))}))}(this,e,t)}},{key:"add_impl",value:function(e,t,a,i,r){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only add CPU tensor to CPU tensor");return function(e,t,n,a,i){return G(e,t,(function(e,t){return e*a+t*i}),n)}(e,t,a,i,r)}},{key:"subtract_impl",value:function(e,t,a,i,r){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only subtract CPU tensor to CPU tensor");return function(e,t,n,a,i){return G(e,t,(function(e,t){return e*a-t*i}),n)}(e,t,a,i,r)}},{key:"multiply_impl",value:function(e,t,a,i){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only add CPU tensor to CPU tensor");return function(e,t,n,a){return G(e,t,(function(e,t){return e*t*a}),n)}(e,t,a,i)}},{key:"divide_impl",value:function(e,t,a,i){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only add CPU tensor to CPU tensor");return function(e,t,n,a){return G(e,t,(function(e,t){return e/t*a}),n)}(e,t,a,i)}},{key:"power_impl",value:function(e,t,a){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only take CPU tensor to power of CPU tensor");return function(e,t,n){return G(e,t,(function(e,t){return Math.pow(e,t)}),n)}(e,t,a)}},{key:"matMul",value:function(e){if(!(e instanceof n))throw new Error("Can only add CPU tensor to CPU tensor");return function(e,t){if(2!==e.shape.length||2!==t.shape.length)throw new Error("Matmul expects both operands to have rank 2");if(e.shape[1]!==t.shape[0])throw new Error("Matmul expects dimension 1 of operand 1 to equal dimension 0 of operand 2");for(var n=e.shape[0],a=e.shape[1],i=t.shape[1],r=new B([n,i],void 0,e.dtype),s=0;s<n;s+=1)for(var o=0;o<i;o+=1){for(var u=0,c=0;c<a;c+=1)u+=e.get([s,c])*t.get([c,o]);r.set([s,o],u)}return r}(this,e)}},{key:"gemm_impl",value:function(e,t,a,i,r,s){if(!(e instanceof n&&(void 0===s||s instanceof n)))throw new Error("Can only do gemm with CPU tensors");return function(e,t,n,a,i,r,s){var o=e.shape.length,u=n?e.shape[o-1]:e.shape[o-2],c=n?e.shape[o-2]:e.shape[o-1],l=a?t.shape[o-2]:t.shape[o-1],p=u*c,f=c*l,d=u*l,v=n?u:1,m=n?1:c,y=a?1:l,g=a?c:1,w=0,k=0,b=0;void 0!==s&&(w=s.strides[o-2],k=s.strides[o-1],O(s.shape.slice(0,o-2))>1?1===(b=s.shape[o-2]*s.shape[o-1])&&(b=0):b=0);var x=e.shape.slice(0,o-2),j=O(x);0===j&&(j=1);for(var S=[].concat(Object(h.a)(x),[u,l]),A=new B(S,void 0,e.dtype),M=0;M<j;M++)for(var I=M*p,T=M*f,V=M*d,D=M*b,X=0;X<u;X++)for(var C=0;C<l;C++){for(var _=0,G=0;G<c;G++)_+=e.get(I+X*m+G*v)*t.get(T+G*y+C*g);_*=i,void 0!==s&&(_+=r*s.get(D+X*w+C*k)),A.set(V+X*l+C,_)}return A}(this,e,t,a,i,r,s)}},{key:"sum_impl",value:function(e,t){return function(e,t,n){return U(e,t,(function(e,t){return e+(void 0!==t?t:0)}),n)}(this,e,t)}},{key:"sumSquare_impl",value:function(e,t){return function(e,t,n){return U(e,t,(function(e,t){return e*e+(void 0!==t?t:0)}),n)}(this,e,t)}},{key:"product_impl",value:function(e,t){return function(e,t,n){return U(e,t,(function(e,t){return e*(void 0!==t?t:1)}),n)}(this,e,t)}},{key:"max_impl",value:function(e,t){return function(e,t,n){return U(e,t,(function(e,t){return Math.max(e,void 0!==t?t:e)}),n)}(this,e,t)}},{key:"min_impl",value:function(e,t){return function(e,t,n){return U(e,t,(function(e,t){return Math.min(e,void 0!==t?t:e)}),n)}(this,e,t)}},{key:"reduceMean_impl",value:function(e,t){return function(e,t,n){for(var a=1,i=0;i<t.length;i++)a*=e.shape[t[i]];return U(e,t,(function(e,t){return e+(void 0!==t?t:0)}),n,(function(e){return e/a}))}(this,e,t)}},{key:"reduceMeanSquare_impl",value:function(e,t){return function(e,t,n){for(var a=1,i=0;i<t.length;i++)a*=e.shape[t[i]];return U(e,t,(function(e,t){return e*e+(void 0!==t?t:0)}),n,(function(e){return e/a}))}(this,e,t)}},{key:"reduceLogSum_impl",value:function(e,t){return function(e,t,n){return U(e,t,(function(e,t){return e+(void 0!==t?t:0)}),n,(function(e){return Math.log(e)}))}(this,e,t)}},{key:"reduceLogSumExp_impl",value:function(e,t){return function(e,t,n){return U(e,t,(function(e,t){return Math.exp(e)+(void 0!==t?t:0)}),n,(function(e){return Math.log(e)}))}(this,e,t)}},{key:"conv_impl",value:function(e,t,a,i,r,s,o){if(!(e instanceof n)||void 0!==o&&!(o instanceof n))throw new Error("Can only do convolution of CPU tensor with CPU tensor");return function(e,t,n,a,i,r,s,o){var u=e.shape[0],c=e.shape[1],h=e.shape.slice(2),l=t.shape.slice(2),p=t.shape[0],f=c/a,d=O(l),v=C(h,l,i.slice(0,i.length/2),i.slice(i.length/2),n,r),m=O(v),y=[u,p];y=y.concat(v);for(var g=new B(y,void 0,e.dtype),w=v.length,k=0;k<u;k++)for(var b=0;b<p;b++){if(o){var x=o?o.get([b]):0,j=new Array(v.length).fill(0);j.unshift(k,b);for(var S=0;S<m;S++)g.set(j,x),I(j,g.shape)}for(var A=0;A<f;A++){var M=(b*f+A)%c,T=new Array(v.length).fill(0);T.unshift(k,b);for(var V=0;V<m;V++){var D=g.get(T),X=new Array(v.length).fill(0);X.unshift(b,A);for(var _=0;_<d;_++){for(var G=[k,M],E=!1,R=0;R<w;R++){var P=0===r.length?1:r[R],U=0===i.length?0:i[R],z=0===n.length?1:n[R],W=T[R+2]*P-U+X[R+2]*z;if(W<0||W>=h[R]){E=!0;break}G.push(W)}E||(D+=t.get(X)*e.get(G)),I(X,t.shape)}g.set(T,D),I(T,g.shape)}}if("id"!==s){var L=new Array(v.length).fill(0);L.unshift(k,b);for(var F=0;F<m;F++){var N=g.get(L);"relu"===s?N=Math.max(0,N):"relu6"===s&&(N=Math.min(Math.max(0,N),6)),g.set(L,N),I(L,g.shape)}}}return g}(this,e,t,a,i,r,s,o)}},{key:"convTranspose_impl",value:function(e,t,a,i,r){if(!(e instanceof n))throw new Error("Can only do transpose convolution of CPU tensor with CPU tensor");return function(e,t,n,a,i,r){var s=e.shape[0],o=e.shape[1],u=e.shape.slice(2),c=t.shape.slice(2),h=t.shape[0],l=o/a,p=O(c),f=R(u,c,i.slice(0,i.length/2),i.slice(i.length/2),n,r),d=O(f),v=[s,h];v=v.concat(f);for(var m=new B(v,void 0,e.dtype),y=f.length,g=0;g<s;g++)for(var w=0;w<h;w++)for(var k=0;k<l;k++){var b=(w*l+k)%o,x=new Array(f.length).fill(0);x.unshift(g,w);for(var j=0;j<d;j++){var S=m.get(x),A=new Array(f.length).fill(0);A.unshift(w,k);for(var M=0;M<p;M++){for(var T=[g,b],V=!1,D=0;D<y;D++){var X=0===r.length?1:r[D],C=0===i.length?0:i[D],_=0===n.length?1:n[D],G=x[D+2]-C+A[D+2]*_;if(0!==G%X){V=!0;break}if((G/=X)<0||G>=u[D]){V=!0;break}T.push(G)}if(!V){for(var E=[w,k],P=0;P<y;P++)E.push(c[P]-A[P+2]-1);S+=t.get(E)*e.get(T)}I(A,t.shape)}m.set(x,S),I(x,m.shape)}}return m}(this,e,t,a,i,r)}},{key:"pad_impl",value:function(e,t,n){return function(e,t,n,a){for(var i=e.shape.length,r=Object(h.a)(e.shape),s=0;s<i;s++)r[s]+=t[s]+t[s+i];for(var o=new B(r,void 0,e.dtype),u=new Array(i).fill(0),c=new Array(i).fill(0),l=0;l<o.size;l++){for(var p=!0,f=0;f<i;f++)c[f]=u[f]-t[f],(c[f]<0||c[f]>=e.shape[f])&&(p=!1);o.set(l,z(e,c,n,a,p)),I(u,r)}return o}(this,e,t,n)}},{key:"averagePool_impl",value:function(e,t,n,a){return function(e,t,n,a,i){var r=e.shape[0],s=e.shape[1],o=e.shape.slice(2),u=o.length,c=O(t),h=C(o,t,n.slice(0,n.length/2),n.slice(n.length/2),new Array(u).fill(1),a),l=O(h),p=[r,s];p=p.concat(h);for(var f=new B(p,void 0,e.dtype),d=0;d<r;d++)for(var v=0;v<s;v++){var m=new Array(h.length).fill(0);m.unshift(d,v);for(var y=0;y<l;y++){for(var g=0,w=new Array(h.length).fill(0),k=0,b=0;b<c;b++){for(var x=[d,v],j=!1,S=0;S<u;S++){var A=0===a.length?1:a[S],M=0===n.length?0:n[S],T=m[S+2]*A-M+w[S];if(T<0||T>=o[S]){j=!0;break}x.push(T)}j||(g+=e.get(x)),j&&!i||(k+=1),I(w,t)}g/=k,f.set(m,g),I(m,f.shape)}}return f}(this,e,t,n,a)}},{key:"reshape_impl",value:function(e,t){return t?this.copy(e):new n(e,this.values,this.dtype)}},{key:"concat",value:function(e,t){if(!(e instanceof n))throw new Error("Can only concat CPU tensor to CPU tensor");return t<0&&(t+=this.shape.length),function(e,t,n){var a=Object(h.a)(e.shape);a[n]+=t.shape[n];for(var i=new B(a,void 0,e.dtype),r=0,s=0,o=0,u=i.strides[n]*e.shape[n],c=i.strides[n]*t.shape[n],l=i.size/(n>0?i.strides[n-1]:i.size),p=0;p<l;p++){for(var f=0;f<u;f++)i.set(o,e.get(r)),o++,r++;for(var d=0;d<c;d++)i.set(o,t.get(s)),o++,s++}return i}(this,e,t)}},{key:"transpose_impl",value:function(e){return function(e,t){for(var n=e.shape.length,a=new Array(n),i=new Array(n),r=0;r<n;r++)a[r]=e.shape[t[r]],i[t[r]]=r;for(var s=new B(a,void 0,e.dtype),o=s.strides,u=new Array(n),c=0;c<n;c++)u[c]=o[i[c]];for(var h=new Array(n).fill(0),l=0;l<e.size;l++){for(var p=0,f=0;f<n;f++)p+=h[f]*u[f];s.set(p,e.get(l)),I(h,e.shape)}return s}(this,e)}},{key:"repeat",value:function(e){return function(e,t){for(var n=e.shape.length,a=new Array(n),i=0;i<n;i++)a[i]=e.shape[i]*t[i];for(var r=new B(a,void 0,e.dtype),s=new Array(n).fill(0),o=0;o<r.size;o++){for(var u=new Array(n),c=0;c<n;c++)u[c]=s[c]%e.shape[c];r.set(o,e.get(u)),I(s,r.shape)}return r}(this,e)}},{key:"expand",value:function(e){var t=this.alignShapes(this.shape,e),n=Object(x.a)(t,3),a=n[0],i=(n[1],n[2]);return M(this.shape,i)?this.copy():function(e,t){for(var n=e.shape.length,a=new B(t,void 0,e.dtype),i=new Array(n).fill(0),r=0;r<a.size;r++)a.set(r,e.get(i)),I(i,a.shape);return a}(this.reshape(a,!1),i)}},{key:"gather",value:function(e,t){return function(e,t,n){for(var a=e.shape.length,i=n.shape.length,r=a+i-1,s=new Array(r),o=0;o<t;o++)s[o]=e.shape[o];for(var u=0;u<i;u++)s[u+t]=n.shape[u];for(var c=t+1;c<a;c++)s[c+i-1]=e.shape[c];for(var l,p,f=new B(s,void 0,e.dtype),d=new Array(r).fill(0),v=0;v<f.size;v++){l=d.slice(t,t+i);var m=n.get(l);p=[].concat(Object(h.a)(d.slice(0,t)),[m],Object(h.a)(d.slice(t+i))),f.set(v,e.get(p)),I(d,s)}return f}(this,e,t)}},{key:"slice_impl",value:function(e,t,n,a){return function(e,t,n,a,i){for(var r=e.shape.length,s=Object(h.a)(e.shape),o=0,u=0;u<r&&o<a.length;u++)u===a[o]&&(s[u]=Math.ceil((n[o]-t[o])/i[o]),o++);for(var c,l=new B(s,void 0,e.dtype),p=new Array(r).fill(0),f=0;f<l.size;f++){c=new Array(r);for(var d=0;d<a.length;d++)c[a[d]]=p[a[d]]*i[d]+t[d];l.set(f,e.get(c)),I(p,s)}return l}(this,e,t,n,a)}},{key:"upsample",value:function(e){return function(e,t){for(var n=e.shape.length,a=Object(h.a)(e.shape),i=0;i<n;i++)a[i]=Math.floor(a[i]*t[i]);for(var r=new B(a,void 0,e.dtype),s=new Array(n).fill(0),o=new Array(n),u=0;u<r.size;u++){for(var c=0;c<n;c++)o[c]=Math.floor(s[c]/t[c]);r.set(u,e.get(o)),I(s,a)}return r}(this,e)}},{key:"normalize",value:function(e,t,a,i,r){if(!(e instanceof n)||!(t instanceof n)||!(i instanceof n)||!(r instanceof n))throw new Error("Can only normalize with CPU tensors");return function(e,t,n,a,i,r){for(var s=e.shape.length,o=Object(h.a)(e.shape),u=new B(o,void 0,e.dtype),c=new Array(s).fill(0),l=0;l<u.size;l++){var p=(e.get(c)-t.get(c))/Math.sqrt(n.get(c)+a);p=p*i.get(c)+r.get(c),u.set(l,p),I(c,o)}return u}(this,e,t,a,i,r)}}],[{key:"range",value:function(e,t,a){for(var i=Math.max(Math.ceil((t-e)/a),0),r=new Float32Array(i),s=0;s<i;s++)r[s]=e+s*a;return new n([i],r)}}]),n}(D),W=n(61),L=n.n(W),F=function(){function e(t){Object(f.a)(this,e),this.toNumber=t,this.numEntries=0,this.dict={}}return Object(d.a)(e,[{key:"betweenBoundsFirst",value:function(e){if(void 0!==e.gte){var t=this.toNumber(e.gte);return void 0!==this.dict[t]&&this.dict[t].length>0?[{key:e.gte,value:this.dict[t][this.dict[t].length-1]}]:[]}if(void 0!==e.lte){var n=this.toNumber(e.lte);return void 0!==this.dict[n]&&this.dict[n].length>0?[{key:e.lte,value:this.dict[n][this.dict[n].length-1]}]:[]}return[]}},{key:"deleteFirst",value:function(e){var t=this.toNumber(e);void 0!==this.dict[t]&&(this.dict[t].pop(),this.numEntries--)}},{key:"insert",value:function(e,t){var n=this.toNumber(e);void 0===this.dict[n]&&(this.dict[n]=[]),this.dict[n].push(t),this.numEntries++}}]),e}();function N(e){return q(e)}function q(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!Number.isInteger(e))return t;var a=Math.abs(e);if(a<2)return t;var i=Math.sqrt(a),r=2;if(a%r&&a%(r=3)){r=5;for(var s=2;a%r&&r<i;)r+=s,s=6-s}if(r=r<=i?r:a,n)t.push(r);else{var o=t.indexOf(r);o<0&&t.push(r)}return r===a?t:q(a/r,t,n)}function H(){for(var e=0,t=0;0===e;)e=Math.random();for(;0===t;)t=Math.random();return[Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*t),Math.sqrt(-2*Math.log(e))*Math.sin(2*Math.PI*t)]}var Z,Y,J,K={float32:"float",float16:"half float",int32:"float",int16:"float",int8:"float",uint32:"float",uint16:"float",uint8:"float"},Q=function(){function e(t,n,a){Object(f.a)(this,e),this.orderedDictConstructor=n,this.totalAllocations=0,this.trees={},this.regl=t,this.entryId=0,this.maxSizeFactor=a||2}return Object(d.a)(e,[{key:"getColorType",value:function(e){return K[e]}},{key:"dtypeGroup",value:function(e){return"float16"===e?"float16":"float32"}},{key:"allocate",value:function(e,t){var n=this.dtypeGroup(t),a=e*this.maxSizeFactor,i=4*Math.ceil(e/4);i<a&&(a=i);var r=void 0!==this.trees[n]?this.trees[n].betweenBoundsFirst({gte:i,lte:a}):[];if(0===r.length){var s=Math.ceil(e/4),o=this.getTextureDims(s),u=o.width,c=o.height,h={width:u,height:c,size:u*c*4,frameBuffer:this.regl.framebuffer({width:u,height:c,depthStencil:!1,colorFormat:"rgba",colorType:K[t]}),id:this.entryId++,dtype:t};return this.totalAllocations++,h}var l=r[0];return this.trees[n].deleteFirst(l.key),l.value.dtype=t,l.value}},{key:"getAllocationDimensions",value:function(e,t){var n=this.dtypeGroup(t),a=e*this.maxSizeFactor,i=4*Math.ceil(e/4);i<a&&(a=i);var r=void 0!==this.trees[n]?this.trees[n].betweenBoundsFirst({gte:e,lte:a}):[];if(0===r.length){var s=Math.ceil(e/4);return this.getTextureDims(s)}var o=r[0];return{width:o.value.width,height:o.value.height}}},{key:"deallocate",value:function(e){var t=this.dtypeGroup(e.dtype);void 0===this.trees[t]&&(this.trees[t]=this.orderedDictConstructor()),this.trees[t].insert(e.size,e)}},{key:"allocateTexture",value:function(e,t){for(var n=Math.ceil(e.length/4),a=this.getTextureDims(n),i=a.width,r=a.height,s=i*r*4,o=new Array(s),u=0;u<e.length;u++)o[u]=e[u];for(var c=e.length;c<s;c++)o[c]=0;var h=this.regl.texture({width:i,height:r,format:"rgba",type:K[t],data:o}),l=this.regl.framebuffer({color:h,width:i,height:r,depthStencil:!1});return this.totalAllocations++,{width:i,height:r,size:s,frameBuffer:l,id:this.entryId++,dtype:t}}},{key:"allocateOfDimensions",value:function(e,t,n){var a=e*t*4,i=this.regl.texture({width:e,height:t,format:"rgba",type:K[n]}),r=this.regl.framebuffer({color:i,width:e,height:t,depthStencil:!1});return this.totalAllocations++,{width:e,height:t,size:a,frameBuffer:r,id:this.entryId++,dtype:n}}},{key:"allocateFramebuffer",value:function(e,t){var n=this.regl.framebuffer({color:e,width:e.width,height:e.height,depthStencil:!1,colorType:K[t]});return this.totalAllocations++,{width:e.width,height:e.height,size:e.width*e.height*4,frameBuffer:n,id:this.entryId++,dtype:t}}},{key:"getTextureDims",value:function(e){for(var t=N(e),n=1,a=1,i=0;i<t.length;i+=2)n*=t[i],i+1<t.length&&(a*=t[i+1]);return{width:n,height:a}}},{key:"getNumEntries",value:function(){var e=0;for(var t in this.trees)e+=this.trees[t].numEntries;return e}}]),e}(),$=document.createElement("canvas");Z=$.getContext("webgl",{failIfMajorPerformanceCaveat:!1}),Y=L()({gl:Z,extensions:["OES_texture_float","WEBGL_color_buffer_float","OES_texture_half_float"]}),J=new Q(Y,(function(){return new F((function(e){return e}))}));var ee=function(){function e(t,n,a,i){Object(f.a)(this,e),this.dtype=n,this.statics=new Set,this.copyCounter=0,this.fullyStatic=!1,void 0===a&&(a=J),void 0===i&&(i=10),this.allocator=a,this.maxRank=i,this.gpuTensorConstructor=t}return Object(d.a)(e,[{key:"registerStatics",value:function(e){var t=0,n=0;for(var a in e)if(a.startsWith("shape")){var i=a.slice("shape".length);this.statics.add("shape".concat(i)),this.statics.add("size".concat(i)),this.statics.add("rank".concat(i)),this.statics.add("strides".concat(i)),t++}else this.statics.add(a),a.startsWith("width")||a.startsWith("height")||n++;t-1===this.getTextureNames().length&&n===this.getUniformAttrs().length&&(this.fullyStatic=!0,this.outputShape=e.shapeOutput)}},{key:"getVarModifier",value:function(e){return this.statics.has(e)?"":"uniform"}},{key:"pad",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.maxRank;e.length<t;)e.push(-1);return e}},{key:"copyPad",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.maxRank,n=Array.from(e);n.length<t;)n.push(-1);return n}},{key:"getVariables",value:function(){return""}},{key:"getVariableDeclarations",value:function(){var e=this,t=this.getTextureNames();return t.push("Output"),"\n      ".concat(t.map((function(t){return"\n        ".concat("Output"===t?"":"uniform sampler2D ".concat(t,";"),"\n        ").concat(e.getVarModifier("size"+t)," int size").concat(t,";\n        ").concat(e.getVarModifier("width"+t)," int width").concat(t,";\n        ").concat(e.getVarModifier("height"+t)," int height").concat(t,";\n        ").concat(e.getVarModifier("strides"+t)," int strides").concat(t,"[").concat(e.maxRank,"];\n        ").concat(e.getVarModifier("shape"+t)," int shape").concat(t,"[").concat(e.maxRank,"];\n        ").concat(e.getVarModifier("rank"+t)," int rank").concat(t,";\n        ")})).join("\n"),"\n      varying vec2 uv;\n\n      ").concat(this.getVariables())}},{key:"getVariableInitializations",value:function(e){var t=this.getTextureNames();t.push("Output");var n,a="",i=Object(b.a)(t);try{for(i.s();!(n=i.n()).done;){var r=n.value;if("shape".concat(r)in e){var s=e["shape".concat(r)],o=j(s),u=O(s),c=s.length;a+=this.getArrayInit("shape".concat(r),s),a+=this.getArrayInit("strides".concat(r),o),a+="\nsize".concat(r," = ").concat(u,";"),a+="\nrank".concat(r," = ").concat(c,";")}}}catch(l){i.e(l)}finally{i.f()}for(var h in e){if(!h.startsWith("shape"))if(Array.isArray(e[h]))a+=this.getArrayInit(h,e[h]);else a+="int"===this.getVarType(h)?"\n".concat(h," = ").concat(e[h],";"):"\n".concat(h," = ").concat(e[h].toPrecision(20),";")}return a}},{key:"getVarType",value:function(e){var t=this.getUniformAttrs().find((function(t){return t.name===e}));return void 0!==t&&t.type?t.type:"int"}},{key:"getArrayInit",value:function(e,t,n,a){void 0===n&&(n=this.maxRank);var i=this.getVarType(e);void 0===a&&("int"===i?a="-1":"float"===i&&(a="-1.0"));for(var r="",s=0;s<n;s++)s<t.length?"int"===i?r+="\n ".concat(e,"[").concat(s,"] = ").concat(t[s],";"):"float"===i&&(r+="\n ".concat(e,"[").concat(s,"] = ").concat(t[s].toPrecision(20),";")):r+="\n ".concat(e,"[").concat(s,"] = ").concat(a,";");return r}},{key:"getUtilFunctions",value:function(){return"\n    int fromFloat(float f) {\n      return int(floor(f+0.5));\n    }\n\n    int coordinateToPos(vec2 coordinate, int textureWidth, int textureHeight) {\n      int x = (fromFloat(coordinate.x*float(textureWidth*2))-1)/2;\n      int y = (fromFloat(coordinate.y*float(textureHeight*2))-1)/2;\n\n      int pos = x + y*textureWidth;\n\n      return pos*4;\n    }\n\n    vec2 posToCoordinate(int pos, int textureWidth, int textureHeight) {\n      pos = pos/4;\n\n      int y = pos/textureWidth;\n      int x = pos - y*textureWidth;\n\n      return vec2(float(x*2+1)/float(textureWidth*2), float(y*2+1)/float(textureHeight*2));\n    }\n\n    int indexToPos(int index[".concat(this.maxRank,"], int strides[").concat(this.maxRank,"]) {\n      int pos = 0;\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (strides[i] == -1) {\n          break;\n        }\n        pos += index[i]*strides[i];\n      }\n      return pos;\n    }\n\n    // TODO: Change return type based on dtype of operation\n    // TODO: Change values per texel here\n    float getValueAtPos(int pos, int textureWidth, int textureHeight, sampler2D tex) {\n      vec2 coord = posToCoordinate(pos, textureWidth, textureHeight);\n      int res = pos - (pos/4)*4;\n      vec4 val = texture2D(tex, coord);\n      if (res == 0) {\n        return val.r;\n      } else if (res == 1) {\n        return val.g;\n      } else if (res == 2) {\n        return val.b;\n      } else {\n        return val.a;\n      }\n    }\n\n    // TODO: Change return type based on dtype of operation\n    float getValueAt(int index[").concat(this.maxRank,"], int strides[").concat(this.maxRank,"], int textureWidth, int textureHeight, sampler2D tex) {\n      int pos = indexToPos(index, strides);\n      return getValueAtPos(pos, textureWidth, textureHeight, tex);\n    }")}},{key:"getTextureFunctions",value:function(){var e=this;return this.getTextureNames().map((function(t){return"\n        float _".concat(t,"(int indices[").concat(e.maxRank,"]) {\n          return getValueAt(indices, strides").concat(t,", width").concat(t,", height").concat(t,", ").concat(t,");\n        }\n      ")})).join("\n")}},{key:"getCompleteFragmentShader",value:function(e){var t=this.getFragmentShader(e),n=this.getVariableDeclarations(),a=this.getVariableInitializations(e),i=this.getUtilFunctions(),r=this.getTextureFunctions();return"\n    // TODO: Change between int/float here\n    precision ".concat(this.precisionString()," float;\n\n    ").concat(n,"\n\n    ").concat(i,"\n    ").concat(r,"\n\n    void initVars() {\n      ").concat(a,"\n    }\n\n    ").concat(t)}},{key:"getUniforms",value:function(e){var t,n=[],a=this.getUniformAttrs(),i=Object(b.a)(a);try{for(i.s();!(t=i.n()).done;){var r=t.value;void 0===e[r.name]&&n.push(r)}}catch(m){i.e(m)}finally{i.f()}var s=this.getTextureNames();s.push("Output");var o,u=Object(b.a)(s);try{for(u.s();!(o=u.n()).done;){var c=o.value;n.push({name:c}),void 0===e["shape".concat(c)]&&(n.push({name:"size".concat(c)}),n.push({name:"strides".concat(c),length:this.maxRank}),n.push({name:"shape".concat(c),length:this.maxRank}),n.push({name:"rank".concat(c)})),void 0===e["width".concat(c)]&&n.push({name:"width".concat(c)}),void 0===e["height".concat(c)]&&n.push({name:"height".concat(c)})}}catch(m){u.e(m)}finally{u.f()}for(var h={},l=0,p=n;l<p.length;l++){var f=p[l];if(void 0===e[f.name])if(void 0!==f.length)for(var d=0;d<f.length;d++){var v="".concat(f.name,"[").concat(d,"]");h[v]=Y.prop(v)}else h[f.name]=Y.prop(f.name)}return h}},{key:"posToIndex",value:function(e,t,n){var a="".concat(n,"_").concat(this.copyCounter++);return"\n    int ".concat(a," = ").concat(n,";\n    for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n      if (").concat(e,"[i] == -1) {\n        ").concat(t,"[i] = -1;\n      } else {\n        if (").concat(e,"[i] == 0) {\n          ").concat(t,"[i] = 0;\n        } else {\n          ").concat(t,"[i] = ").concat(a,"/").concat(e,"[i];\n          ").concat(a," = ").concat(a," - ").concat(e,"[i]*").concat(t,"[i]; // Stupid modulo hack\n        }\n      }\n    }")}},{key:"initIndex",value:function(e,t){return void 0===t?"\n        for (int i = 0; i < ".concat(this.maxRank,"; i++) {\n          ").concat(e,"[i] = -1;\n        }"):"\n        for (int i = 0; i < ".concat(this.maxRank,"; i++) {\n          if (i < ").concat(t,") {\n            ").concat(e,"[i] = 0;\n          } else {\n            ").concat(e,"[i] = -1;\n          }\n        }")}},{key:"incrementIndex",value:function(e,t){return"\n    for (int i = ".concat(this.maxRank," - 1; i >= 0; i--) {\n      if (").concat(t,"[i] != -1) {\n        ").concat(e,"[i] += 1;\n        if (").concat(e,"[i] >= ").concat(t,"[i]) {\n          ").concat(e,"[i] = 0;\n        } else {\n          break;\n        }\n      }\n    }\n    ")}},{key:"incrementConditional",value:function(e,t,n){return"\n    for (int i = 0; i < ".concat(this.maxRank,"; i++) {\n      if (").concat(n,"[i] == 1) {\n        ").concat(e,"[i] += 1;\n        if (").concat(e,"[i] >= ").concat(t,"[i]) {\n          ").concat(e,"[i] = 0;\n        } else {\n          break;\n        }\n      } else if (").concat(n,"[i] == -1) {\n        break;\n      }\n    }\n    ")}},{key:"getDefaultMain",value:function(){return"\n    void main() {\n      initVars();\n\n      int pos = coordinateToPos(uv, widthOutput, heightOutput);\n\n      // TODO: change number of values per pixel here\n      vec4 result = vec4(0,0,0,0);\n\n      if (pos < sizeOutput) {\n        int index[".concat(this.maxRank,"];\n        ").concat(this.posToIndex("stridesOutput","index","pos"),"\n        result.r = process(index);\n\n        pos += 1;\n\n        if (pos < sizeOutput) {\n          ").concat(this.posToIndex("stridesOutput","index","pos"),"\n          result.g = process(index);\n\n          pos += 1;\n\n          if (pos < sizeOutput) {\n            ").concat(this.posToIndex("stridesOutput","index","pos"),"\n            result.b = process(index);\n\n            pos += 1;\n\n            if (pos < sizeOutput) {\n              ").concat(this.posToIndex("stridesOutput","index","pos"),"\n              result.a = process(index);\n            }\n          }\n        }\n      }\n\n      gl_FragColor = result;\n    }")}},{key:"precisionString",value:function(){return"float16"===this.dtype?"mediump":"highp"}},{key:"getDrawCommand",value:function(e){var t=this.getCompleteFragmentShader(e),n=this.getUniforms(e);return Y({frag:t,vert:"\n        // TODO: Change between float/int\n        precision ".concat(this.precisionString()," float;\n        attribute vec2 position;\n        varying vec2 uv;\n        void main() {\n          uv = 0.5 * (position + 1.0);\n          gl_Position = vec4(position, 0, 1);\n        }"),attributes:{position:[-4,-4,4,-4,0,4]},uniforms:n,framebuffer:Y.prop("framebuffer"),depth:{enable:!1},count:3})}},{key:"compile",value:function(e){this.registerStatics(e),this.drawCommand=this.getDrawCommand(e)}},{key:"compute",value:function(e,t,n){void 0===this.drawCommand&&this.compile({});var a=O(e),i=this.allocator.allocate(a,this.dtype);for(var r in t){if(t[r].memory.id===i.id)throw new Error("Allocator returned a framebuffer that is also an input\n                         Did you delete a GPU tensor that was still used elsewhere?")}var s={};for(var o in t)s[o]=t[o].memory.frameBuffer;if(void 0===n&&(n={}),!this.fullyStatic){for(var u in t)this.statics.has("shape".concat(u))||(n["size".concat(u)]=t[u].size,n["strides".concat(u)]=this.pad(j(t[u].shape)),n["shape".concat(u)]=this.copyPad(t[u].shape),n["rank".concat(u)]=t[u].shape.length),this.statics.has("width".concat(u))||(n["width".concat(u)]=t[u].memory.width),this.statics.has("height".concat(u))||(n["height".concat(u)]=t[u].memory.height);this.statics.has("shapeOutput")||(n.sizeOutput=a,n.stridesOutput=this.pad(j(e)),n.shapeOutput=this.copyPad(e),n.rankOutput=e.length),this.statics.has("widthOutput")||(n.widthOutput=i.width),this.statics.has("heightOutput")||(n.heightOutput=i.height)}return this.drawCommand(Object.assign(Object.assign({framebuffer:i.frameBuffer},s),n)),this.gpuTensorConstructor(i,e,this.precision)}},{key:"getUniformAttrs",value:function(){return[]}}]),e}(),te=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,e,a,i)).maxIterations=1e6,r.maxRank=2,r}return Object(d.a)(n,[{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      int ix1[").concat(this.maxRank,"];\n      ").concat(this.initIndex("ix1"),"\n      ix1[0] = index[0];\n\n      int ix2[").concat(this.maxRank,"];\n      ").concat(this.initIndex("ix2"),"\n      ix2[1] = index[1];\n\n      int k = shapeA[1];\n\n      float res = 0.0;\n\n      for (int i = 0; i < ").concat(this.maxIterations,"; i++) {\n        if (i >= k) {\n          break;\n        }\n        ix1[1] = i;\n        ix2[0] = i;\n\n        float v1 = _A(ix1);\n        float v2 = _B(ix2);\n        res += v1*v2;\n      }\n\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["A","B"]}},{key:"calc",value:function(e){var t=this.getOutputShape(e);return this.compute(t,{A:e.A,B:e.B})}},{key:"getOutputShape",value:function(e){return[e.A.shape[0],e.B.shape[1]]}},{key:"compile",value:function(e){void 0!==e.shapeA?this.maxIterations=e.shapeA[1]:void 0!==e.shapeB&&(this.maxIterations=e.shapeB[0]),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeA:e.A.shape,widthA:e.A.memory.width,heightA:e.A.memory.height,shapeB:e.A.shape,widthB:e.A.memory.width,heightB:e.A.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height}}},{key:"getInputInfoString",value:function(e){return"".concat(e.A.shape,"-").concat(e.B.shape)}}]),n}(ee),ne=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getFragmentShader",value:function(e){return"\n    void main() {\n      initVars();\n\n      gl_FragColor = ".concat(this.operation("texture2D(X, uv)"),";\n    }\n    ")}},{key:"getTextureNames",value:function(){return["X"]}},{key:"calc",value:function(e){return this.compute(e.input.shape,{X:e.input})}},{key:"getOutputShape",value:function(e){return e.input.shape}},{key:"compile",value:function(e){void 0!==e.shapeX&&(this.maxRank=e.shapeX.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeX:e.input.shape,widthX:e.input.memory.width,heightX:e.input.memory.height,shapeOutput:this.getOutputShape(e),widthOutput:n.width,heightOutput:n.height}}},{key:"getInputInfoString",value:function(e){return"".concat(e.input.shape)}}]),n}(ee),ae=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"exp(".concat(e,")")}}]),n}(ne),ie=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,e,a,i)).maxIterations=1e6,r}return Object(d.a)(n,[{key:"updateInputIx",value:function(){return"\n    for (int d = 0; d < ".concat(this.maxRank-2,"; d++) {\n      int stride = strides[d];\n      int pad = pads[d];\n      int dilation = dilations[d];\n      if (stride == -1) {\n        break;\n      }\n\n      inputIx[d+2] = index[d+2]*stride - pad + kernelIx[d+2]*dilation;\n      if (inputIx[d+2] < 0 || inputIx[d+2] >= shapeX[d+2]) {\n        skip = true;\n        break;\n      }\n    }\n    ")}},{key:"getMainBody",value:function(){return"\n    int n = index[0];\n    int m = index[1];\n\n    int kernelIx[".concat(this.maxRank,"];\n    ").concat(this.initIndex("kernelIx"),"\n    for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n      if (i >= dataRank) {\n        break;\n      }\n      kernelIx[i+2] = 0;\n    }\n    kernelIx[0] = m;\n    int inputIx[").concat(this.maxRank,"];\n    ").concat(this.initIndex("inputIx"),"\n    inputIx[0] = n;\n\n    for (int cg = 0; cg < ").concat(this.maxIterations,"; cg++) {\n      if (cg >= CG) {\n        break;\n      }\n      int c = m * CG + cg;\n      int d = c/C;\n      c = c - d*C;\n      inputIx[1] = c;\n      kernelIx[1] = cg;\n      for (int kIx = 0; kIx < ").concat(this.maxIterations,"; kIx++) {\n        if (kIx >= kernelSize) {\n          break;\n        }\n\n        bool skip = false;\n\n        ").concat(this.updateInputIx(),"\n\n        if (!skip) {\n          res += _X(inputIx) * _W(kernelIx);\n        }\n\n        ").concat(this.incrementIndex("kernelIx","shapeW"),"\n      }\n    }\n    ")}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("CG")," int CG;\n    ").concat(this.getVarModifier("kernelSize")," int kernelSize;\n    ").concat(this.getVarModifier("dataRank")," int dataRank;\n    ").concat(this.getVarModifier("C")," int C;\n    ").concat(this.getVarModifier("dilations")," int dilations[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("pads")," int pads[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("strides")," int strides[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("activation")," int activation;\n    ")}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      float res = 0.0;\n\n      ").concat(this.getMainBody(),"\n\n      if (activation == 1) {\n        res = max(0.0, res);\n      } else if (activation == 2) {\n        res = max(0.0, min(res,6.0));\n      }\n\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["X","W"]}},{key:"getUniformAttrs",value:function(){return[{name:"CG"},{name:"kernelSize"},{name:"C"},{name:"dataRank"},{name:"pads",length:2*this.maxRank},{name:"strides",length:this.maxRank},{name:"dilations",length:this.maxRank},{name:"activation"}]}},{key:"getActivationFlag",value:function(e){return"id"===e?0:"relu"===e?1:2}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{X:e.X,W:e.W});var t=e.X.shape[0],n=e.X.shape[1],a=e.X.shape.slice(2),i=e.W.shape.slice(2),r=e.W.shape[0],s=e.W.shape[1],o=O(i),u=C(a,i,e.pads.slice(0,e.pads.length/2),e.pads.slice(e.pads.length/2),e.dilations,e.strides),c=[t,r];return c=c.concat(u),this.compute(c,{X:e.X,W:e.W},{CG:s,kernelSize:o,C:n,dataRank:a.length,pads:this.copyPad(e.pads,2*this.maxRank),strides:this.copyPad(e.strides),dilations:this.copyPad(e.dilations),activation:this.getActivationFlag(e.activation)})}},{key:"getOutputShape",value:function(e){var t=e.X.shape[0],n=e.X.shape.slice(2),a=e.W.shape.slice(2),i=e.W.shape[0],r=C(n,a,e.pads.slice(0,e.pads.length/2),e.pads.slice(e.pads.length/2),e.dilations,e.strides),s=[t,i];return s=s.concat(r)}},{key:"compile",value:function(e){void 0!==e.shapeW&&(e.CG=e.shapeW[1],e.kernelSize=O(e.shapeW.slice(2)),e.dataRank=e.shapeW.length-2,this.maxRank=e.shapeW.length),void 0!==e.shapeX&&(e.C=e.shapeX[1],e.dataRank=e.shapeX.length-2,this.maxRank=e.shapeX.length),void 0!==e.activation&&"string"===typeof e.activation&&(e.activation=this.getActivationFlag(e.activation)),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype),a=O(e.W.shape.slice(2)),i=e.X.shape[1],r=e.X.shape.slice(2);return{shapeX:e.X.shape,widthX:e.X.memory.width,heightX:e.X.memory.height,shapeW:e.W.shape,widthW:e.W.memory.width,heightW:e.W.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,pads:e.pads,dilations:e.dilations,strides:e.strides,CG:e.W.shape[1],kernelSize:a,dataRank:r.length,C:i,activation:this.getActivationFlag(e.activation)}}},{key:"getInputInfoString",value:function(e){return"".concat(e.X.shape,"-").concat(e.W.shape,"-").concat(e.dilations,"-").concat(e.pads,"-").concat(e.dilations,"-").concat(e.strides,"-").concat(e.activation)}}]),n}(ee),re=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,e,a,i)).maxIterations=1e6,r}return Object(d.a)(n,[{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      int biasIndex[").concat(this.maxRank,"];\n      ").concat(this.initIndex("biasIndex"),"\n      biasIndex[0] = index[1];\n      float res = _B(biasIndex);\n\n      ").concat(this.getMainBody(),"\n\n      if (activation == 1) {\n        res = max(0.0, res);\n      } else if (activation == 2) {\n        res = max(0.0, min(res,6.0));\n      }\n\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["X","W","B"]}},{key:"calc",value:function(e){var t=e.X.shape[0],n=e.X.shape[1],a=e.X.shape.slice(2),i=e.W.shape.slice(2),r=e.W.shape[0],s=e.W.shape[1],o=O(i),u=C(a,i,e.pads.slice(0,e.pads.length/2),e.pads.slice(e.pads.length/2),e.dilations,e.strides),c=[t,r];return c=c.concat(u),this.compute(c,{X:e.X,W:e.W,B:e.B},{CG:s,kernelSize:o,C:n,dataRank:a.length,pads:this.copyPad(e.pads,2*this.maxRank),strides:this.copyPad(e.strides),dilations:this.copyPad(e.dilations),activation:this.getActivationFlag(e.activation)})}},{key:"getCompilationInfo",value:function(e){var t=Object(w.a)(Object(k.a)(n.prototype),"getCompilationInfo",this).call(this,e);return Object.assign(Object.assign({},t),{shapeB:e.B.shape,widthB:e.B.memory.width,heightB:e.B.memory.height})}},{key:"getInputInfoString",value:function(e){return"".concat(Object(w.a)(Object(k.a)(n.prototype),"getInputInfoString",this).call(this,e),"-").concat(e.B.shape)}}]),n}(ie),se=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"abs(".concat(e,")")}}]),n}(ne),oe=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getFragmentShader",value:function(e){return"\n    float process(int[".concat(this.maxRank,"] index) {\n      return ").concat(this.getOp("_A(index)","_B(index)"),";\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getOutputShape",value:function(e){return e.outputShape}},{key:"getTextureNames",value:function(){return["A","B"]}},{key:"calc",value:function(e){return this.compute(e.outputShape,{A:e.A,B:e.B})}},{key:"compile",value:function(e){void 0!==e.shapeA&&(this.maxRank=e.shapeA.length),void 0!==e.shapeB&&(this.maxRank=e.shapeB.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=J.getAllocationDimensions(O(e.outputShape),this.dtype);return{shapeA:e.A.shape,widthA:e.A.memory.width,heightA:e.A.memory.height,shapeB:e.B.shape,widthB:e.B.memory.width,heightB:e.B.memory.height,shapeOutput:e.outputShape,widthOutput:t.width,heightOutput:t.height}}},{key:"getInputInfoString",value:function(e){return"".concat(e.A.shape,"-").concat(e.B.shape)}}]),n}(ee),ue=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getOp",value:function(e,t){return"alpha*".concat(e," + beta*").concat(t)}},{key:"calc",value:function(e){return this.compute(e.outputShape,{A:e.A,B:e.B},{alpha:e.alpha,beta:e.beta})}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("alpha")," float alpha;\n    ").concat(this.getVarModifier("beta")," float beta;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"alpha",type:"float"},{name:"beta",type:"float"}]}},{key:"getCompilationInfo",value:function(e){var t=Object(w.a)(Object(k.a)(n.prototype),"getCompilationInfo",this).call(this,e);return Object.assign(Object.assign({},t),{alpha:e.alpha,beta:e.beta})}},{key:"getInputInfoString",value:function(e){return"".concat(Object(w.a)(Object(k.a)(n.prototype),"getInputInfoString",this).call(this,e),"-").concat(e.alpha,"-").concat(e.beta)}}]),n}(oe),ce=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getOp",value:function(e,t){return"alpha*".concat(e," * ").concat(t)}},{key:"calc",value:function(e){return this.compute(e.outputShape,{A:e.A,B:e.B},{alpha:e.alpha})}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("alpha")," float alpha;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"alpha",type:"float"}]}},{key:"getCompilationInfo",value:function(e){var t=Object(w.a)(Object(k.a)(n.prototype),"getCompilationInfo",this).call(this,e);return Object.assign(Object.assign({},t),{alpha:e.alpha})}},{key:"getInputInfoString",value:function(e){return"".concat(Object(w.a)(Object(k.a)(n.prototype),"getInputInfoString",this).call(this,e),"-").concat(e.alpha)}}]),n}(oe),he=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getOp",value:function(e,t){return"alpha*".concat(e," - beta*").concat(t)}},{key:"calc",value:function(e){return this.compute(e.outputShape,{A:e.A,B:e.B},{alpha:e.alpha,beta:e.beta})}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("alpha")," float alpha;\n    ").concat(this.getVarModifier("beta")," float beta;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"alpha",type:"float"},{name:"beta",type:"float"}]}},{key:"getCompilationInfo",value:function(e){var t=Object(w.a)(Object(k.a)(n.prototype),"getCompilationInfo",this).call(this,e);return Object.assign(Object.assign({},t),{alpha:e.alpha,beta:e.beta})}},{key:"getInputInfoString",value:function(e){return"".concat(Object(w.a)(Object(k.a)(n.prototype),"getInputInfoString",this).call(this,e),"-").concat(e.alpha,"-").concat(e.beta)}}]),n}(oe),le=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getOp",value:function(e,t){return"alpha*".concat(e," / ").concat(t)}},{key:"calc",value:function(e){return this.compute(e.outputShape,{A:e.A,B:e.B},{alpha:e.alpha})}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("alpha")," float alpha;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"alpha",type:"float"}]}},{key:"getCompilationInfo",value:function(e){var t=Object(w.a)(Object(k.a)(n.prototype),"getCompilationInfo",this).call(this,e);return Object.assign(Object.assign({},t),{alpha:e.alpha})}},{key:"getInputInfoString",value:function(e){return"".concat(Object(w.a)(Object(k.a)(n.prototype),"getInputInfoString",this).call(this,e),"-").concat(e.alpha)}}]),n}(oe),pe=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,e,a,i)).maxIterations=1e6,r}return Object(d.a)(n,[{key:"updateInputIx",value:function(){return"\n    for (int d = 0; d < ".concat(this.maxRank-2,"; d++) {\n      int stride = strides[d];\n      int pad = pads[d];\n      if (stride == -1) {\n        break;\n      }\n\n      inputIx[d+2] = index[d+2]*stride - pad + kernelIx[d];\n      if (inputIx[d+2] < 0 || inputIx[d+2] >= shapeX[d+2]) {\n        skip = true;\n        break;\n      }\n    }\n    ")}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("kernelSize")," int kernelSize;\n    ").concat(this.getVarModifier("dataRank")," int dataRank;\n    ").concat(this.getVarModifier("includePad")," int includePad;\n    ").concat(this.getVarModifier("pads")," int pads[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("strides")," int strides[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("kernelShape")," int kernelShape[").concat(this.maxRank,"];\n    ")}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      float res = 0.0;\n      int count = 0;\n\n      int n = index[0];\n      int c = index[1];\n\n      int kernelIx[").concat(this.maxRank,"];\n      ").concat(this.initIndex("kernelIx"),"\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (i >= dataRank) {\n          break;\n        }\n        kernelIx[i] = 0;\n      }\n      int inputIx[").concat(this.maxRank,"];\n      ").concat(this.initIndex("inputIx"),"\n      inputIx[0] = n;\n      inputIx[1] = c;\n\n      for (int kIx = 0; kIx < ").concat(this.maxIterations,"; kIx++) {\n        if (kIx >= kernelSize) {\n          break;\n        }\n\n        bool skip = false;\n\n        ").concat(this.updateInputIx(),"\n\n        if (!skip) {\n          res += _X(inputIx);\n        }\n\n        if (!skip || includePad == 1) {\n          count += 1;\n        }\n\n        ").concat(this.incrementIndex("kernelIx","kernelShape"),"\n      }\n\n      res = res / float(count);\n\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["X"]}},{key:"getUniformAttrs",value:function(){return[{name:"kernelSize"},{name:"dataRank"},{name:"includePad"},{name:"pads",length:2*this.maxRank},{name:"strides",length:this.maxRank},{name:"kernelShape",length:this.maxRank}]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{X:e.X});var t=e.X.shape[0],n=e.X.shape[1],a=e.X.shape.slice(2),i=O(e.kernelShape),r=C(a,e.kernelShape,e.pads.slice(0,e.pads.length/2),e.pads.slice(e.pads.length/2),new Array(a.length).fill(1),e.strides),s=[t,n];return s=s.concat(r),this.compute(s,{X:e.X},{kernelSize:i,includePad:e.includePad?1:0,dataRank:a.length,pads:this.copyPad(e.pads,2*this.maxRank),strides:this.copyPad(e.strides),kernelShape:this.copyPad(e.kernelShape)})}},{key:"getOutputShape",value:function(e){var t=e.X.shape[0],n=e.X.shape[1],a=e.X.shape.slice(2),i=C(a,e.kernelShape,e.pads.slice(0,e.pads.length/2),e.pads.slice(e.pads.length/2),new Array(a.length).fill(1),e.strides),r=[t,n];return r=r.concat(i)}},{key:"compile",value:function(e){void 0!==e.shapeX&&(e.dataRank=e.shapeX.length-2,this.maxRank=e.shapeX.length),!0===e.includePad?e.includePad=1:!1===e.includePad&&(e.includePad=0),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype),a=O(e.kernelShape);return{shapeX:e.X.shape,widthX:e.X.memory.width,heightX:e.X.memory.height,kernelShape:e.kernelShape,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,pads:e.pads,strides:e.strides,kernelSize:a,dataRank:e.X.shape.length-2,includePad:e.includePad?1:0}}},{key:"getInputInfoString",value:function(e){return"".concat(e.X.shape,"-").concat(e.kernelShape,"-").concat(e.pads,"-").concat(e.strides,"-").concat(e.includePad)}}]),n}(ee),fe=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,e,a,i)).maxIterations=1e6,r}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("mappedInputStrides")," int mappedInputStrides[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("mappedInputStrides")," int sumDims[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("mappedInputStrides")," int sumSize;\n    ")}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      int inputIx[").concat(this.maxRank,"];\n      ").concat(this.initIndex("inputIx"),"\n\n      int inputPos = 0;\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (mappedInputStrides[i] == -1 || index[i] == -1) {\n          break;\n        }\n        inputPos += mappedInputStrides[i]*index[i];\n      }\n\n      ").concat(this.posToIndex("stridesX","inputIx","inputPos"),"\n\n      float res = 0.0;\n\n      for (int i = 0; i < ").concat(this.maxIterations,"; i++) {\n        if (i >= sumSize) {\n          break;\n        }\n        float curr = _X(inputIx);\n        if (i == 0) {\n          res = ").concat(this.init("curr"),";\n        } else {\n          res = ").concat(this.update("curr","res"),";\n        }\n\n        ").concat(this.incrementConditional("inputIx","shapeX","sumDims"),"\n      }\n\n      ").concat(this.post("res"),"\n\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"post",value:function(e){return""}},{key:"init",value:function(e){return e}},{key:"getTextureNames",value:function(){return["X"]}},{key:"getUniformAttrs",value:function(){return[{name:"mappedInputStrides",length:this.maxRank},{name:"sumDims",length:this.maxRank},{name:"sumSize"}]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{X:e.X});var t,n=P(e.X.shape,e.axes,e.keepDims),a=Object(x.a)(n,2),i=a[0],r=a[1],s=j(e.X.shape),o=[],u=Object(b.a)(r);try{for(u.s();!(t=u.n()).done;){var c=t.value;o.push(s[c])}}catch(f){u.e(f)}finally{u.f()}for(var h=1,l=new Array(e.X.shape.length).fill(0),p=0;p<e.axes.length;p++)l[e.axes[p]]=1,h*=e.X.shape[e.axes[p]];return this.compute(i,{X:e.X},{mappedInputStrides:this.pad(o),sumDims:this.pad(l),sumSize:h})}},{key:"getOutputShape",value:function(e){var t=P(e.X.shape,e.axes,e.keepDims),n=Object(x.a)(t,2),a=n[0];n[1];return a}},{key:"compile",value:function(e){if(void 0!==e.shapeX&&void 0!==e.axes&&void 0!==e.keepDims){var t,a=P(e.shapeX,e.axes,e.keepDims),i=Object(x.a)(a,2),r=i[0],s=i[1],o=j(e.shapeX),u=[],c=Object(b.a)(s);try{for(c.s();!(t=c.n()).done;){var h=t.value;u.push(o[h])}}catch(d){c.e(d)}finally{c.f()}for(var l=1,p=new Array(e.shapeX.length).fill(0),f=0;f<e.axes.length;f++)p[e.axes[f]]=1,l*=e.shapeX[e.axes[f]];e.sumDims=p,e.shapeOutput=r,e.mappedInputStrides=u,e.sumSize=l,delete e.keepDims,delete e.axes,this.maxRank=e.shapeX.length}Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t,n=P(e.X.shape,e.axes,e.keepDims),a=Object(x.a)(n,2),i=a[0],r=a[1],s=j(e.X.shape),o=[],u=Object(b.a)(r);try{for(u.s();!(t=u.n()).done;){var c=t.value;o.push(s[c])}}catch(d){u.e(d)}finally{u.f()}for(var h=1,l=new Array(e.X.shape.length).fill(0),p=0;p<e.axes.length;p++)l[e.axes[p]]=1,h*=e.X.shape[e.axes[p]];var f=J.getAllocationDimensions(O(i),this.dtype);return{shapeX:e.X.shape,widthX:e.X.memory.width,heightX:e.X.memory.height,shapeOutput:i,widthOutput:f.width,heightOutput:f.height,mappedInputStrides:o,sumDims:l,sumSize:h}}},{key:"getInputInfoString",value:function(e){return"".concat(e.X.shape,"-").concat(e.axes,"-").concat(e.keepDims)}}]),n}(ee),de=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"update",value:function(e,t){return"".concat(e," + ").concat(t)}},{key:"post",value:function(e){return"".concat(e," = ").concat(e,"/float(sumSize);")}}]),n}(fe),ve=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"update",value:function(e,t){return"(".concat(e,"*").concat(e,") + ").concat(t)}},{key:"post",value:function(e){return"".concat(e," = ").concat(e,"/float(sumSize);")}},{key:"init",value:function(e){return"".concat(e,"*").concat(e)}}]),n}(fe),me=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"update",value:function(e,t){return"(".concat(e,"*").concat(e,") + ").concat(t)}},{key:"init",value:function(e){return"".concat(e,"*").concat(e)}}]),n}(fe),ye=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"update",value:function(e,t){return"".concat(e," + ").concat(t)}}]),n}(fe),ge=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"update",value:function(e,t){return"".concat(e," * ").concat(t)}}]),n}(fe),we=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"update",value:function(e,t){return"max(".concat(e,", ").concat(t,")")}}]),n}(fe),ke=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"update",value:function(e,t){return"min(".concat(e,", ").concat(t,")")}}]),n}(fe),be=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"ceil(".concat(e,")")}}]),n}(ne),xe=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getFragmentShader",value:function(e){return"\n    void main() {\n      initVars();\n\n      vec4 maxVec = vec4(maxVal,maxVal,maxVal,maxVal);\n      vec4 minVec = vec4(minVal,minVal,minVal,minVal);\n\n      vec4 res = texture2D(X, uv);\n      if (doMin == 1) {\n        res = max(minVec, res);\n      }\n      if (doMax == 1) {\n        res = min(maxVec, res);\n      }\n\n      gl_FragColor = res;\n    }\n    "}},{key:"getTextureNames",value:function(){return["X"]}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("minVal")," float minVal;\n    ").concat(this.getVarModifier("maxVal")," float maxVal;\n    ").concat(this.getVarModifier("doMin")," int doMin;\n    ").concat(this.getVarModifier("doMax")," int doMax;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"minVal",type:"float"},{name:"maxVal",type:"float"},{name:"doMin"},{name:"doMax"}]}},{key:"calc",value:function(e){return this.fullyStatic&&void 0!==this.outputShape?this.compute(this.outputShape,{X:e.input}):this.compute(e.input.shape,{X:e.input},{minVal:void 0!==e.minVal?e.minVal:0,maxVal:void 0!==e.maxVal?e.maxVal:0,doMin:void 0!==e.minVal?1:0,doMax:void 0!==e.maxVal?1:0})}},{key:"getOutputShape",value:function(e){return e.input.shape}},{key:"compile",value:function(e){void 0!==e.shapeX&&(this.maxRank=e.shapeX.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=J.getAllocationDimensions(e.input.size,this.dtype);return{shapeX:e.input.shape,widthX:e.input.memory.width,heightX:e.input.memory.height,shapeOutput:e.input.shape,widthOutput:t.width,heightOutput:t.height,minVal:void 0!==e.minVal?e.minVal:0,maxVal:void 0!==e.maxVal?e.maxVal:0,doMin:void 0!==e.minVal?1:0,doMax:void 0!==e.maxVal?1:0}}},{key:"getInputInfoString",value:function(e){return"".concat(e.input.shape,"-").concat(e.minVal,"-").concat(e.maxVal)}}]),n}(ee),Oe=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"floor(".concat(e,")")}}]),n}(ne),je=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("axis")," int axis;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"axis"}]}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      float res = 0.0;\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (i == axis) {\n          if (index[i] >= shapeA[i]) {\n            index[i] = index[i] - shapeA[i];\n            res = _B(index);\n          } else {\n            res = _A(index);\n          }\n          break;\n        }\n      }\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["A","B"]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{A:e.A,B:e.B});var t=this.getOutputShape(e);return this.compute(t,{A:e.A,B:e.B},{axis:e.axis})}},{key:"getOutputShape",value:function(e){var t=Object(h.a)(e.A.shape);return t[e.axis]+=e.B.shape[e.axis],t}},{key:"compile",value:function(e){void 0!==e.shapeA&&(this.maxRank=e.shapeA.length),void 0!==e.shapeB&&(this.maxRank=e.shapeB.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeA:e.A.shape,widthA:e.A.memory.width,heightA:e.A.memory.height,shapeB:e.B.shape,widthB:e.B.memory.width,heightB:e.B.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,axis:e.axis}}},{key:"getInputInfoString",value:function(e){return"".concat(e.A.shape,"-").concat(e.B.shape,"-").concat(e.axis)}}]),n}(ee),Se=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getFragmentShader",value:function(e){return"\n    void main() {\n      initVars();\n\n      gl_FragColor = texture2D(X, uv);\n    }\n    "}},{key:"getTextureNames",value:function(){return["X"]}},{key:"calc",value:function(e){var t=this.getOutputShape(e);return this.compute(t,{X:e.input})}},{key:"getOutputShape",value:function(e){var t=e.outputShape;return void 0===t&&(t=e.input.shape),t}},{key:"compile",value:function(e){void 0!==e.shapeX&&(this.maxRank=e.shapeX.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeX:e.input.shape,widthX:e.input.memory.width,heightX:e.input.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height}}},{key:"getInputInfoString",value:function(e){return"".concat(e.input,"-").concat(this.getOutputShape(e))}}]),n}(ee),Ae=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      return _X(index);\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["X"]}},{key:"calc",value:function(e){return this.compute(e.outputShape,{X:e.input})}},{key:"getOutputShape",value:function(e){return e.outputShape}},{key:"compile",value:function(e){void 0!==e.shapeX&&(this.maxRank=e.shapeX.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeX:e.input.shape,widthX:e.input.memory.width,heightX:e.input.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height}}},{key:"getInputInfoString",value:function(e){return"".concat(e.input.shape,"-").concat(e.outputShape)}}]),n}(ee),Me=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,e,a,i)).gatherMaxIxSize=10,r}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("axis")," int axis;\n    ").concat(this.getVarModifier("indexValues")," int indexValues[").concat(this.gatherMaxIxSize,"];\n    ").concat(this.getVarModifier("mappedIndexStrides")," int mappedIndexStrides[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("mappedInputStrides")," int mappedInputStrides[").concat(this.maxRank,"];\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"axis"},{name:"indexValues",length:this.gatherMaxIxSize},{name:"mappedInputStrides",length:this.maxRank},{name:"mappedIndexStrides",length:this.maxRank}]}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      int inputPos = 0;\n      int indexPos = 0;\n\n      int strideAxis = 0;\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (index[i] == -1) {\n          break;\n        }\n        if (i == axis) {\n          strideAxis = stridesX[i];\n        }\n        inputPos += mappedInputStrides[i]*index[i];\n        indexPos += mappedIndexStrides[i]*index[i];\n      }\n\n      for (int i = 0; i < ").concat(this.gatherMaxIxSize,"; i++) {\n        if (i == indexPos) {\n          inputPos += indexValues[i]*strideAxis;\n          break;\n        }\n      }\n\n      return getValueAtPos(inputPos, widthX, heightX, X);\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["X"]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{X:e.X});if(e.indices.size>this.gatherMaxIxSize)throw new Error("Gather on GPU can deal with at most ".concat(this.gatherMaxIxSize," indices, input had ").concat(e.indices.size));for(var t=e.X.shape.length,n=e.indices.shape.length,a=j(e.X.shape),i=j(e.indices.shape),r=t+n-1,s=new Array(r),o=new Array(r).fill(0),u=new Array(r).fill(0),c=0;c<e.axis;c++)s[c]=e.X.shape[c],o[c]=a[c],u[c]=0;for(var h=0;h<n;h++)s[h+e.axis]=e.indices.shape[h],u[h+e.axis]=i[h],o[h+e.axis]=0;for(var l=e.axis+1;l<t;l++)s[l+n-1]=e.X.shape[l],o[l+n-1]=a[l],u[l+n-1]=0;return this.compute(s,{X:e.X},{axis:e.axis,indexValues:this.pad(Array.from(e.indices.values),this.gatherMaxIxSize),mappedInputStrides:this.pad(o),mappedIndexStrides:this.pad(u)})}},{key:"getOutputShape",value:function(e){for(var t=e.X.shape.length,n=e.indices.shape.length,a=new Array(t+n-1),i=0;i<e.axis;i++)a[i]=e.X.shape[i];for(var r=0;r<n;r++)a[r+e.axis]=e.indices.shape[r];for(var s=e.axis+1;s<t;s++)a[s+n-1]=e.X.shape[s];return a}},{key:"compile",value:function(e){if(void 0!==e.shapeX&&(this.maxRank=e.shapeX.length,void 0!==e.indices&&void 0!==e.axis)){for(var t=e.shapeX.length,a=e.indices.shape.length,i=j(e.shapeX),r=j(e.indices.shape),s=t+a-1,o=new Array(s),u=new Array(s).fill(0),c=new Array(s).fill(0),h=0;h<e.axis;h++)o[h]=e.shapeX[h],u[h]=i[h],c[h]=0;for(var l=0;l<a;l++)o[l+e.axis]=e.indices.shape[l],c[l+e.axis]=r[l],u[l+e.axis]=0;for(var p=e.axis+1;p<t;p++)o[p+a-1]=e.shapeX[p],u[p+a-1]=i[p],c[p+a-1]=0;e.mappedIndexStrides=c,e.mappedInputStrides=u,e.indexValues=Array.from(e.indices.values),delete e.indices}Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){for(var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype),a=e.X.shape.length,i=e.indices.shape.length,r=j(e.X.shape),s=j(e.indices.shape),o=a+i-1,u=new Array(o),c=new Array(o).fill(0),h=new Array(o).fill(0),l=0;l<e.axis;l++)u[l]=e.X.shape[l],c[l]=r[l],h[l]=0;for(var p=0;p<i;p++)u[p+e.axis]=e.indices.shape[p],h[p+e.axis]=s[p],c[p+e.axis]=0;for(var f=e.axis+1;f<a;f++)u[f+i-1]=e.X.shape[f],c[f+i-1]=r[f],h[f+i-1]=0;return{shapeX:e.X.shape,widthX:e.X.memory.width,heightX:e.X.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,axis:e.axis,indexValues:Array.from(e.indices.values),mappedIndexStrides:h,mappedInputStrides:c}}},{key:"getInputInfoString",value:function(e){return"".concat(e.X.shape,"-").concat(e.axis,"-").concat(Array.from(e.indices.values),"-").concat(e.indices.shape)}}]),n}(ee),Ie=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,e,a,i)).maxIterations=1e6,r}return Object(d.a)(n,[{key:"getMainBody",value:function(){return"\n      int ixA[".concat(this.maxRank,"];\n      ").concat(this.initIndex("ixA"),"\n      int ixB[").concat(this.maxRank,"];\n      ").concat(this.initIndex("ixA"),"\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (i >= rank - 2) {\n          break;\n        }\n        ixA[i] = index[i];\n        ixB[i] = index[i];\n      }\n\n      int m = 0;\n      int o = 0;\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (i == rank-2) {\n          m = index[i];\n          o = index[i+1];\n\n          if (aTranspose == 0) {\n            ixA[i] = m;\n          } else {\n            ixA[i+1] = m;\n          }\n\n          if (bTranspose == 0) {\n            ixB[i+1] = o;\n          } else {\n            ixB[i] = o;\n          }\n\n          break;\n        }\n      }\n\n      float res = 0.0;\n\n      for (int n = 0; n < ").concat(this.maxIterations,"; n++) {\n        if (n >= N) {\n          break;\n        }\n        for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n          if (i == rank-2) {\n            if (aTranspose == 0) {\n              ixA[i+1] = n;\n            } else {\n              ixA[i] = n;\n            }\n\n            if (bTranspose == 0) {\n              ixB[i] = n;\n            } else {\n              ixB[i+1] = n;\n            }\n\n            break;\n          }\n        }\n        res += _A(ixA) * _B(ixB);\n      }\n\n      res = res*alpha;\n    ")}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("M")," int M;\n    ").concat(this.getVarModifier("N")," int N;\n    ").concat(this.getVarModifier("O")," int O;\n    ").concat(this.getVarModifier("rank")," int rank;\n    ").concat(this.getVarModifier("aTranspose")," int aTranspose;\n    ").concat(this.getVarModifier("bTranspose")," int bTranspose;\n    ").concat(this.getVarModifier("alpha")," float alpha;\n    ").concat(this.getVarModifier("beta")," float beta;\n    ")}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      ").concat(this.getMainBody(),"\n\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["A","B"]}},{key:"getUniformAttrs",value:function(){return[{name:"M"},{name:"N"},{name:"O"},{name:"rank"},{name:"aTranspose"},{name:"bTranspose"},{name:"alpha",type:"float"},{name:"beta",type:"float"}]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{A:e.a,B:e.b});var t=e.a.shape.length,n=e.aTranspose?e.a.shape[t-1]:e.a.shape[t-2],a=e.aTranspose?e.a.shape[t-2]:e.a.shape[t-1],i=e.bTranspose?e.b.shape[t-2]:e.b.shape[t-1],r=e.a.shape.slice(0,t-2),s=[].concat(Object(h.a)(r),[n,i]),o={M:n,N:a,O:i,rank:t,aTranspose:e.aTranspose?1:0,bTranspose:e.bTranspose?1:0,alpha:e.alpha,beta:e.beta};return this.compute(s,{A:e.a,B:e.b},o)}},{key:"getOutputShape",value:function(e){var t=e.a.shape.length,n=e.aTranspose?e.a.shape[t-1]:e.a.shape[t-2],a=e.bTranspose?e.b.shape[t-2]:e.b.shape[t-1],i=e.a.shape.slice(0,t-2);return[].concat(Object(h.a)(i),[n,a])}},{key:"compile",value:function(e){if(void 0!==e.shapeA){var t=e.shapeA.length;if(e.rank=t,this.maxRank=t,void 0!==e.aTranspose){var a=e.aTranspose?e.shapeA[t-1]:e.shapeA[t-2],i=e.aTranspose?e.shapeA[t-2]:e.shapeA[t-1];e.M=a,e.N=i,e.aTranspose=e.aTranspose?1:0}}if(void 0!==e.shapeB&&void 0!==e.bTranspose){var r=e.shapeB.length,s=e.bTranspose?e.shapeB[r-2]:e.shapeB[r-1];e.O=s,e.bTranspose=e.bTranspose?1:0}Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype),a=e.a.shape.length,i=e.aTranspose?e.a.shape[a-1]:e.a.shape[a-2],r=e.aTranspose?e.a.shape[a-2]:e.a.shape[a-1],s=e.bTranspose?e.b.shape[a-2]:e.b.shape[a-1];return{shapeA:e.a.shape,widthA:e.a.memory.width,heightA:e.a.memory.height,shapeB:e.b.shape,widthB:e.b.memory.width,heightB:e.b.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,M:i,N:r,O:s,aTranspose:e.aTranspose?1:0,bTranspose:e.bTranspose?1:0,alpha:e.alpha,beta:e.beta,rank:a}}},{key:"getInputInfoString",value:function(e){return"".concat(e.a.shape,"-").concat(e.b.shape,"-").concat(e.aTranspose,"-").concat(e.bTranspose,"-").concat(e.alpha,"-").concat(e.beta)}}]),n}(ee),Te=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"getTextureNames",value:function(){return["A","B","C"]}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      ").concat(this.getMainBody(),"\n\n      res += beta*_C(index);\n\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{A:e.a,B:e.b,C:e.c});var t=e.a.shape.length,n=e.aTranspose?e.a.shape[t-1]:e.a.shape[t-2],a=e.aTranspose?e.a.shape[t-2]:e.a.shape[t-1],i=e.bTranspose?e.b.shape[t-2]:e.b.shape[t-1],r=e.a.shape.slice(0,t-2),s=[].concat(Object(h.a)(r),[n,i]),o={M:n,N:a,O:i,rank:t,aTranspose:e.aTranspose?1:0,bTranspose:e.bTranspose?1:0,alpha:e.alpha,beta:e.beta};return this.compute(s,{A:e.a,B:e.b,C:e.c},o)}},{key:"getCompilationInfo",value:function(e){var t=Object(w.a)(Object(k.a)(n.prototype),"getCompilationInfo",this).call(this,e);return Object.assign(Object.assign({},t),{shapeC:e.c.shape,widthC:e.c.memory.width,heightC:e.c.memory.height})}},{key:"getInputInfoString",value:function(e){return"".concat(Object(w.a)(Object(k.a)(n.prototype),"getInputInfoString",this).call(this,e),"-").concat(e.c.shape)}}]),n}(Ie),Ve=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getOp",value:function(e,t){return"pow(".concat(e,", ").concat(t,")")}}]),n}(oe),De=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"sqrt(".concat(e,")")}}]),n}(ne),Xe=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"log(".concat(e,")")}}]),n}(ne),Ce=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("mappedStrides")," int mappedStrides[").concat(this.maxRank,"];\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"mappedStrides",length:this.maxRank}]}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      return getValueAt(index, mappedStrides, widthA, heightA, A);\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["A"]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{A:e.A});for(var t=e.A.shape.length,n=this.getOutputShape(e),a=j(e.A.shape),i=new Array(t),r=0;r<t;r++)i[r]=a[e.permutation[r]];return this.compute(n,{A:e.A},{mappedStrides:this.pad(i)})}},{key:"getOutputShape",value:function(e){for(var t=e.A.shape.length,n=new Array(t),a=0;a<t;a++)n[a]=e.A.shape[e.permutation[a]];return n}},{key:"compile",value:function(e){if(void 0!==e.shapeA&&(this.maxRank=e.shapeA.length,void 0!==e.permutation)){for(var t=e.shapeA.length,a=j(e.shapeA),i=new Array(t),r=0;r<t;r++)i[r]=a[e.permutation[r]];e.mappedStrides=i,delete e.permutation}Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){for(var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype),a=e.A.shape.length,i=j(e.A.shape),r=new Array(a),s=0;s<a;s++)r[s]=i[e.permutation[s]];return{shapeA:e.A.shape,widthA:e.A.memory.width,heightA:e.A.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,mappedStrides:r}}},{key:"getInputInfoString",value:function(e){return"".concat(e.A.shape,"-").concat(e.permutation)}}]),n}(ee),_e=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("repeats")," int repeats[").concat(this.maxRank,"];\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"repeats",length:this.maxRank}]}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      int inIndex[").concat(this.maxRank,"];\n      ").concat(this.initIndex("inIndex"),"\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (repeats[i] == -1) {\n          break;\n        }\n        int d = index[i] / shapeA[i];\n        inIndex[i] = index[i] - d*shapeA[i];\n      }\n\n      return _A(inIndex);\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getOutputShape",value:function(e){for(var t=e.A.shape.length,n=new Array(t),a=0;a<t;a++)n[a]=e.A.shape[a]*e.repeats[a];return n}},{key:"getTextureNames",value:function(){return["A"]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{A:e.A});var t=this.getOutputShape(e);return this.compute(t,{A:e.A},{repeats:this.copyPad(e.repeats)})}},{key:"compile",value:function(e){void 0!==e.shapeA&&(this.maxRank=e.shapeA.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeA:e.A.shape,widthA:e.A.memory.width,heightA:e.A.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,repeats:e.repeats}}},{key:"getInputInfoString",value:function(e){return"".concat(e.A.shape,"-").concat(e.repeats)}}]),n}(ee),Ge=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      int inputIx[").concat(this.maxRank,"];\n      ").concat(this.initIndex("inputIx"),"\n      if (mode == 0) {\n        float res = value;\n\n        int outOfBounds = 0;\n        for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n          if (index[i] == -1) {\n            break;\n          }\n          inputIx[i] = index[i] - pads[i];\n          if (inputIx[i] < 0 || inputIx[i] >= shapeX[i]) {\n            outOfBounds = 1;\n            break;\n          }\n        }\n\n        if (outOfBounds == 0) {\n          res = _X(inputIx);\n        }\n\n        return res;\n      } else if (mode == 1) {\n        for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n          if (index[i] == -1) {\n            break;\n          }\n          inputIx[i] = index[i] - pads[i];\n          if (inputIx[i] < 0) {\n            inputIx[i] = -inputIx[i];\n          } else if (inputIx[i] >= shapeX[i]) {\n            inputIx[i] = 2*shapeX[i] - inputIx[i] - 2;\n          }\n        }\n\n        return _X(inputIx);\n      } else {\n        for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n          if (index[i] == -1) {\n            break;\n          }\n          inputIx[i] = index[i] - pads[i];\n          if (inputIx[i] < 0) {\n            inputIx[i] = 0;\n          } else if (inputIx[i] >= shapeX[i]) {\n            inputIx[i] = shapeX[i] - 1;\n          }\n        }\n\n        return _X(inputIx);\n      }\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["X"]}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("pads")," int pads[").concat(2*this.maxRank,"];\n    ").concat(this.getVarModifier("value")," float value;\n    ").concat(this.getVarModifier("mode")," int mode;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"value",type:"float"},{name:"pads",length:2*this.maxRank},{name:"mode"}]}},{key:"getModeFlag",value:function(e){return"constant"===e?0:"reflect"===e?1:2}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{X:e.input});var t=this.getOutputShape(e);return this.compute(t,{X:e.input},{pads:this.copyPad(e.pads,2*this.maxRank),value:e.value,mode:this.getModeFlag(e.mode)})}},{key:"getOutputShape",value:function(e){for(var t=e.input.shape.length,n=Object(h.a)(e.input.shape),a=0;a<t;a++)n[a]+=e.pads[a]+e.pads[a+t];return n}},{key:"compile",value:function(e){void 0!==e.shapeX&&(this.maxRank=e.shapeX.length),void 0!==e.mode&&"string"===typeof e.mode&&(e.mode=this.getModeFlag(e.mode)),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeX:e.input.shape,widthX:e.input.memory.width,heightX:e.input.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,pads:e.pads,mode:this.getModeFlag(e.mode),value:e.value}}},{key:"getInputInfoString",value:function(e){return"".concat(e.input.shape,"-").concat(e.pads,"-").concat(e.mode,"-").concat(e.value)}}]),n}(ee),Ee=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      int inIx[").concat(this.maxRank,"];\n      ").concat(this.initIndex("inIx"),"\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (index[i] == -1) {\n          break;\n        }\n\n        inIx[i] = index[i]*steps[i] + offsets[i];\n      }\n\n      return _X(inIx);\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["X"]}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("offsets")," int offsets[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("steps")," int steps[").concat(this.maxRank,"];\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"offsets",length:this.maxRank},{name:"steps",length:this.maxRank}]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{X:e.X});for(var t=e.X.shape.length,n=Object(h.a)(e.X.shape),a=new Array(t).fill(0),i=new Array(t).fill(1),r=0,s=0;s<t&&r<e.axes.length;s++)s===e.axes[r]&&(n[s]=Math.ceil((e.ends[r]-e.starts[r])/e.steps[r]),a[s]=e.starts[r],i[s]=e.steps[r],r++);return this.compute(n,{X:e.X},{offsets:this.pad(a),steps:this.pad(i)})}},{key:"getOutputShape",value:function(e){for(var t=e.X.shape.length,n=Object(h.a)(e.X.shape),a=0,i=0;i<t&&a<e.axes.length;i++)i===e.axes[a]&&(n[i]=Math.ceil((e.ends[a]-e.starts[a])/e.steps[a]),a++);return n}},{key:"compile",value:function(e){if(void 0!==e.shapeX&&(this.maxRank=e.shapeX.length,void 0!==e.axes&&void 0!==e.starts&&void 0!==e.ends&&void 0!==e.steps)){for(var t=e.shapeX.length,a=new Array(t).fill(0),i=new Array(t).fill(1),r=0,s=0;s<t&&r<e.axes.length;s++)s===e.axes[r]&&(a[s]=e.starts[r],i[s]=e.steps[r],r++);e.offsets=a,e.steps=i,delete e.starts,delete e.ends,delete e.axes}Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){for(var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype),a=e.X.shape.length,i=Object(h.a)(e.X.shape),r=new Array(a).fill(0),s=new Array(a).fill(1),o=0,u=0;u<a&&o<e.axes.length;u++)u===e.axes[o]&&(i[u]=Math.ceil((e.ends[o]-e.starts[o])/e.steps[o]),r[u]=e.starts[o],s[u]=e.steps[o],o++);return{shapeX:e.X.shape,widthX:e.X.memory.width,heightX:e.X.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,offsets:r,steps:s}}},{key:"getInputInfoString",value:function(e){return"".concat(e.X.shape,"-").concat(e.axes,"-").concat(e.starts,"-").concat(e.ends,"-").concat(e.steps)}}]),n}(ee),Re=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      int inIx[").concat(this.maxRank,"];\n      ").concat(this.initIndex("inIx"),"\n\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (index[i] == -1) {\n          break;\n        }\n\n        inIx[i] = int(floor(float(index[i]) / scales[i]));\n      }\n\n      return _X(inIx);\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["X"]}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("scales")," float scales[").concat(this.maxRank,"];\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"scales",length:this.maxRank,type:"float"}]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{X:e.X});var t=this.getOutputShape(e);return this.compute(t,{X:e.X},{scales:this.copyPad(e.scales)})}},{key:"getOutputShape",value:function(e){for(var t=e.X.shape.length,n=Object(h.a)(e.X.shape),a=0;a<t;a++)n[a]=Math.floor(n[a]*e.scales[a]);return n}},{key:"compile",value:function(e){void 0!==e.shapeX&&(this.maxRank=e.shapeX.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeX:e.X.shape,widthX:e.X.memory.width,heightX:e.X.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,scales:e.scales}}},{key:"getInputInfoString",value:function(e){return"".concat(e.X.shape,"-").concat(e.scales)}}]),n}(ee),Pe=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("epsilon")," float epsilon;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"epsilon",type:"float"}]}},{key:"getFragmentShader",value:function(e){return"\n    float process(int[".concat(this.maxRank,"] index) {\n      float result = _X(index) - _Mean(index);\n      result = result / sqrt(_Variance(index) + epsilon);\n      result = result * _Scale(index) + _Bias(index);\n      return result;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getOutputShape",value:function(e){return e.X.shape}},{key:"getTextureNames",value:function(){return["X","Mean","Variance","Scale","Bias"]}},{key:"calc",value:function(e){return this.compute(e.X.shape,{X:e.X,Mean:e.Mean,Variance:e.Variance,Scale:e.Scale,Bias:e.Bias},{epsilon:e.epsilon})}},{key:"compile",value:function(e){void 0!==e.shapeX&&(this.maxRank=e.shapeX.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeX:e.X.shape,widthX:e.X.memory.width,heightX:e.X.memory.height,shapeBias:e.Bias.shape,widthBias:e.Bias.memory.width,heightBias:e.Bias.memory.height,shapeMean:e.Mean.shape,widthMean:e.Mean.memory.width,heightMean:e.Mean.memory.height,shapeScale:e.Scale.shape,widthScale:e.Scale.memory.width,heightScale:e.Scale.memory.height,shapeVariance:e.Variance.shape,widthVariance:e.Variance.memory.width,heightVariance:e.Variance.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,epsilon:e.epsilon}}},{key:"getInputInfoString",value:function(e){return"".concat(e.X.shape,"-").concat(e.Mean.shape,"-").concat(e.Variance.shape,"-").concat(e.Scale.shape,"-").concat(e.Bias.shape,"-").concat(e.epsilon)}}]),n}(ee),Ue=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;Object(f.a)(this,e),this.getOp=t,this.minCallsToCompile=n,this.opDict={}}return Object(d.a)(e,[{key:"getDefault",value:function(e){var t="default-".concat(e);if(void 0===this.opDict[t]){var n=this.getOp(e);n.compile({}),this.opDict[t]={infoString:t,numCalls:0,operation:n}}return this.opDict[t]}},{key:"calc",value:function(e,t){var n=this.getDefault(t),a=n.operation.getInputInfoString(e);void 0===this.opDict[a]&&(this.opDict[a]={infoString:a,numCalls:0});var i=this.opDict[a];if(i.numCalls++,i.numCalls>=this.minCallsToCompile){if(void 0===i.operation){i.operation=this.getOp(t);var r=n.operation.getCompilationInfo(e);i.operation.compile(r)}return i.operation.calc(e)}return n.numCalls++,n.operation.calc(e)}}]),e}(),ze=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"sign(".concat(e,")")}}]),n}(ne),Be=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"-".concat(e)}}]),n}(ne),We=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      float val = _X(index);\n      if (doMin == 1 && val < minVal) {\n        return 0.0;\n      }\n      if (doMax == 1 && val > maxVal) {\n        return 0.0;\n      }\n      return _Grad(index);\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["X","Grad"]}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("minVal")," float minVal;\n    ").concat(this.getVarModifier("maxVal")," float maxVal;\n    ").concat(this.getVarModifier("doMin")," int doMin;\n    ").concat(this.getVarModifier("doMax")," int doMax;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"minVal",type:"float"},{name:"maxVal",type:"float"},{name:"doMin"},{name:"doMax"}]}},{key:"calc",value:function(e){return this.fullyStatic&&void 0!==this.outputShape?this.compute(this.outputShape,{X:e.input,Grad:e.grad}):this.compute(e.input.shape,{X:e.input,Grad:e.grad},{minVal:void 0!==e.minVal?e.minVal:0,maxVal:void 0!==e.maxVal?e.maxVal:0,doMin:void 0!==e.minVal?1:0,doMax:void 0!==e.maxVal?1:0})}},{key:"getOutputShape",value:function(e){return e.input.shape}},{key:"compile",value:function(e){void 0!==e.shapeX&&(this.maxRank=e.shapeX.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=J.getAllocationDimensions(e.input.size,this.dtype);return{shapeX:e.input.shape,widthX:e.input.memory.width,heightX:e.input.memory.height,shapeGrad:e.grad.shape,widthGrad:e.grad.memory.width,heightGrad:e.grad.memory.height,shapeOutput:e.input.shape,widthOutput:t.width,heightOutput:t.height,minVal:void 0!==e.minVal?e.minVal:0,maxVal:void 0!==e.maxVal?e.maxVal:0,doMin:void 0!==e.minVal?1:0,doMax:void 0!==e.maxVal?1:0}}},{key:"getInputInfoString",value:function(e){return"".concat(e.input.shape,"-").concat(e.minVal,"-").concat(e.maxVal)}}]),n}(ee),Le=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,e,a,i)).maxIterations=1e6,r}return Object(d.a)(n,[{key:"updateInputIx",value:function(){return"\n    for (int d = 0; d < ".concat(this.maxRank-2,"; d++) {\n      int stride = strides[d];\n      int pad = pads[d];\n      int dilation = dilations[d];\n      if (stride == -1) {\n        break;\n      }\n\n      int trans_kernel_ix = shapeW[d + 2] - kernelIx[d + 2] - 1;\n\n      inputIx[d+2] = index[d + 2] - pad + trans_kernel_ix * dilation;\n\n      int divS = inputIx[d+2] / stride;\n      int resS = inputIx[d+2] - divS*stride;\n\n      if (resS != 0) {\n        skip = true;\n        break;\n      }\n      inputIx[d+2] = divS;\n\n      if (inputIx[d+2] < 0 || inputIx[d+2] >= shapeX[d+2]) {\n        skip = true;\n        break;\n      }\n    }\n    ")}},{key:"getMainBody",value:function(){return"\n    int n = index[0];\n    int m = index[1];\n\n    int kernelIx[".concat(this.maxRank,"];\n    ").concat(this.initIndex("kernelIx"),"\n    for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n      if (i >= dataRank) {\n        break;\n      }\n      kernelIx[i+2] = 0;\n    }\n    kernelIx[0] = m;\n    int inputIx[").concat(this.maxRank,"];\n    ").concat(this.initIndex("inputIx"),"\n    inputIx[0] = n;\n\n    for (int cg = 0; cg < ").concat(this.maxIterations,"; cg++) {\n      if (cg >= CG) {\n        break;\n      }\n      int c = m * CG + cg;\n      int d = c/C;\n      c = c - d*C;\n      inputIx[1] = c;\n      kernelIx[1] = cg;\n      for (int kIx = 0; kIx < ").concat(this.maxIterations,"; kIx++) {\n        if (kIx >= kernelSize) {\n          break;\n        }\n\n        bool skip = false;\n\n        ").concat(this.updateInputIx(),"\n\n        if (!skip) {\n          res += _X(inputIx) * _W(kernelIx);\n        }\n\n        ").concat(this.incrementIndex("kernelIx","shapeW"),"\n      }\n    }\n    ")}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("CG")," int CG;\n    ").concat(this.getVarModifier("kernelSize")," int kernelSize;\n    ").concat(this.getVarModifier("dataRank")," int dataRank;\n    ").concat(this.getVarModifier("C")," int C;\n    ").concat(this.getVarModifier("dilations")," int dilations[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("pads")," int pads[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("strides")," int strides[").concat(this.maxRank,"];\n    ")}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      float res = 0.0;\n\n      ").concat(this.getMainBody(),"\n\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["X","W"]}},{key:"getUniformAttrs",value:function(){return[{name:"CG"},{name:"kernelSize"},{name:"C"},{name:"dataRank"},{name:"pads",length:2*this.maxRank},{name:"strides",length:this.maxRank},{name:"dilations",length:this.maxRank}]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{X:e.X,W:e.W});var t=e.X.shape[0],n=e.X.shape[1],a=e.X.shape.slice(2),i=e.W.shape.slice(2),r=e.W.shape[0],s=e.W.shape[1],o=O(i),u=R(a,i,e.pads.slice(0,e.pads.length/2),e.pads.slice(e.pads.length/2),e.dilations,e.strides),c=[t,r];return c=c.concat(u),this.compute(c,{X:e.X,W:e.W},{CG:s,kernelSize:o,C:n,dataRank:a.length,pads:this.copyPad(e.pads,2*this.maxRank),strides:this.copyPad(e.strides),dilations:this.copyPad(e.dilations)})}},{key:"getOutputShape",value:function(e){var t=e.X.shape[0],n=e.X.shape.slice(2),a=e.W.shape.slice(2),i=e.W.shape[0],r=R(n,a,e.pads.slice(0,e.pads.length/2),e.pads.slice(e.pads.length/2),e.dilations,e.strides),s=[t,i];return s=s.concat(r)}},{key:"compile",value:function(e){void 0!==e.shapeW&&(e.CG=e.shapeW[1],e.kernelSize=O(e.shapeW.slice(2)),e.dataRank=e.shapeW.length-2,this.maxRank=e.shapeW.length),void 0!==e.shapeX&&(e.C=e.shapeX[1],e.dataRank=e.shapeX.length-2,this.maxRank=e.shapeX.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype),a=O(e.W.shape.slice(2)),i=e.X.shape[1],r=e.X.shape.slice(2);return{shapeX:e.X.shape,widthX:e.X.memory.width,heightX:e.X.memory.height,shapeW:e.W.shape,widthW:e.W.memory.width,heightW:e.W.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,pads:e.pads,dilations:e.dilations,strides:e.strides,CG:e.W.shape[1],kernelSize:a,dataRank:r.length,C:i}}},{key:"getInputInfoString",value:function(e){return"".concat(e.X.shape,"-").concat(e.W.shape,"-").concat(e.dilations,"-").concat(e.pads,"-").concat(e.dilations,"-").concat(e.strides)}}]),n}(ee),Fe=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"1.0/(1.0 + exp(-".concat(e,"))")}}]),n}(ne),Ne=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"factor*".concat(e," + add")}},{key:"calc",value:function(e){return this.compute(e.input.shape,{X:e.input},{factor:e.factor,add:e.add})}},{key:"getCompilationInfo",value:function(e){var t=Object(w.a)(Object(k.a)(n.prototype),"getCompilationInfo",this).call(this,e);return Object.assign(Object.assign({},t),{factor:e.factor,add:e.add})}},{key:"getInputInfoString",value:function(e){return"".concat(Object(w.a)(Object(k.a)(n.prototype),"getInputInfoString",this).call(this,e),"-").concat(e.factor,"-").concat(e.add)}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("factor")," float factor;\n    ").concat(this.getVarModifier("add")," float add;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"factor",type:"float"},{name:"add",type:"float"}]}}]),n}(ne),qe=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("starts")," int starts[").concat(this.maxRank,"];\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"starts",length:this.maxRank}]}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      int valueIx[").concat(this.maxRank,"];\n      ").concat(this.initIndex("valueIx"),"\n\n      int inValues = 1;\n\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (index[i] == -1) {\n          break;\n        }\n\n        if (index[i] < starts[i] || index[i] >= (starts[i] + shapeValues[i])) {\n          inValues = 0;\n          break;\n        } else {\n          valueIx[i] = index[i] - starts[i];\n        }\n      }\n\n      if (inValues == 1) {\n        return _Values(valueIx);\n      } else {\n        return _A(index);\n      }\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["A","Values"]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{A:e.A,Values:e.Values});var t=this.getOutputShape(e);return this.compute(t,{A:e.A,Values:e.Values},{starts:this.pad(e.starts)})}},{key:"getOutputShape",value:function(e){return e.A.shape}},{key:"compile",value:function(e){void 0!==e.shapeA&&(this.maxRank=e.shapeA.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeA:e.A.shape,widthA:e.A.memory.width,heightA:e.A.memory.height,shapeValues:e.Values.shape,widthValues:e.Values.memory.width,heightValues:e.Values.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,starts:e.starts}}},{key:"getInputInfoString",value:function(e){return"".concat(e.A.shape,"-").concat(e.Values.shape,"-").concat(e.starts)}}]),n}(ee),He=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"sin(".concat(e,")")}}]),n}(ne),Ze=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"asin(".concat(e,")")}}]),n}(ne),Ye=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"(exp(".concat(e,") - exp(-").concat(e,"))/2.0")}}]),n}(ne),Je=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"cos(".concat(e,")")}}]),n}(ne),Ke=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"acos(".concat(e,")")}}]),n}(ne),Qe=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"(1.0 + exp(-2.0*".concat(e,"))/(2.0*exp(-").concat(e,"))")}}]),n}(ne),$e=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"tan(".concat(e,")")}}]),n}(ne),et=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"atan(".concat(e,")")}}]),n}(ne),tt=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"(exp(2.0*".concat(e,") - 1.0)/(exp(2.0*").concat(e,") + 1.0)")}}]),n}(ne),nt=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"update",value:function(e,t){return"".concat(e," + ").concat(t)}},{key:"post",value:function(e){return"".concat(e," = log(").concat(e,");")}},{key:"init",value:function(e){return"".concat(e)}}]),n}(fe),at=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"update",value:function(e,t){return"exp(".concat(e,") + ").concat(t)}},{key:"post",value:function(e){return"".concat(e," = log(").concat(e,");")}},{key:"init",value:function(e){return"exp(".concat(e,")")}}]),n}(fe),it=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"max(vec4(0.0,0.0,0.0,0.0), min(vec4(1.0,1.0,1.0,1.0), alpha*".concat(e," + beta))")}},{key:"calc",value:function(e){return this.compute(e.input.shape,{X:e.input},{alpha:e.alpha,beta:e.beta})}},{key:"getCompilationInfo",value:function(e){var t=Object(w.a)(Object(k.a)(n.prototype),"getCompilationInfo",this).call(this,e);return Object.assign(Object.assign({},t),{alpha:e.alpha,beta:e.beta})}},{key:"getInputInfoString",value:function(e){return"".concat(Object(w.a)(Object(k.a)(n.prototype),"getInputInfoString",this).call(this,e),"-").concat(e.alpha,"-").concat(e.beta)}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("alpha")," float alpha;\n    ").concat(this.getVarModifier("beta")," float beta;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"alpha",type:"float"},{name:"beta",type:"float"}]}}]),n}(ne),rt=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){throw new Error("Method not implemented.")}},{key:"getFragmentShader",value:function(e){return"\n    void main() {\n      initVars();\n\n      if (power < 0.0) {\n        gl_FragColor = vec4(factor,factor,factor,factor) / pow(texture2D(X, uv), vec4(-power,-power,-power,-power));\n      } else {\n        gl_FragColor = pow(texture2D(X, uv), vec4(power,power,power,power)) * factor;\n      }\n    }\n    "}},{key:"calc",value:function(e){return this.compute(e.input.shape,{X:e.input},{factor:e.factor,power:e.power})}},{key:"getCompilationInfo",value:function(e){var t=Object(w.a)(Object(k.a)(n.prototype),"getCompilationInfo",this).call(this,e);return Object.assign(Object.assign({},t),{factor:e.factor,power:e.power})}},{key:"getInputInfoString",value:function(e){return"".concat(Object(w.a)(Object(k.a)(n.prototype),"getInputInfoString",this).call(this,e),"-").concat(e.factor,"-").concat(e.power)}},{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("factor")," float factor;\n    ").concat(this.getVarModifier("power")," float power;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"factor",type:"float"},{name:"power",type:"float"}]}}]),n}(ne),st=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"operation",value:function(e){return"floor(".concat(e,"+vec4(0.5))")}}]),n}(ne),ot=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,i||"float32")).shape=a,r.deleted=!1,r.size=O(a),r.memory=e instanceof Array?J.allocateTexture(e,r.dtype):e,r}return Object(d.a)(n,[{key:"cast",value:function(e){if("float64"===e)throw new Error("The WebGL backend does not support float64 tensors");return dn.calc({input:this},e)}},{key:"getValues",value:function(){var e=this;if("float16"!==this.dtype)return new Promise((function(t){Y({framebuffer:e.memory.frameBuffer})((function(){var n=new Float32Array(e.memory.size);if(n=Y.read(n),"float32"===e.dtype)t(n.subarray(0,e.size));else{for(var a=new V[e.dtype](e.size),i=0;i<e.size;i++)a[i]=n[i];t(a)}}))}));throw new Error("Reading values not supported for data type float16")}},{key:"getShape",value:function(){return this.shape}},{key:"constantLike",value:function(e){return new n(new Array(this.size).fill(e),this.shape,this.dtype)}},{key:"singleConstant",value:function(e){return new n([e],[1],this.dtype)}},{key:"delete",value:function(){this.deleted||(this.deleted=!0,J.deallocate(this.memory),this.memory=void 0)}},{key:"copy",value:function(){return dn.calc({input:this},this.dtype)}},{key:"exp",value:function(){return bt.calc({input:this},this.dtype)}},{key:"log",value:function(){return zt.calc({input:this},this.dtype)}},{key:"sqrt",value:function(){return Ut.calc({input:this},this.dtype)}},{key:"abs",value:function(){return xt.calc({input:this},this.dtype)}},{key:"sin",value:function(){return Ot.calc({input:this},this.dtype)}},{key:"cos",value:function(){return jt.calc({input:this},this.dtype)}},{key:"tan",value:function(){return St.calc({input:this},this.dtype)}},{key:"asin",value:function(){return At.calc({input:this},this.dtype)}},{key:"acos",value:function(){return Mt.calc({input:this},this.dtype)}},{key:"atan",value:function(){return It.calc({input:this},this.dtype)}},{key:"sinh",value:function(){return Tt.calc({input:this},this.dtype)}},{key:"cosh",value:function(){return Vt.calc({input:this},this.dtype)}},{key:"tanh",value:function(){return Dt.calc({input:this},this.dtype)}},{key:"asinh",value:function(){throw new Error("Method not implemented")}},{key:"acosh",value:function(){throw new Error("Method not implemented")}},{key:"atanh",value:function(){throw new Error("Method not implemented")}},{key:"sigmoid",value:function(){return Xt.calc({input:this},this.dtype)}},{key:"hardSigmoid",value:function(e,t){return Ct.calc({input:this,alpha:e,beta:t},this.dtype)}},{key:"floor",value:function(){return Gt.calc({input:this},this.dtype)}},{key:"ceil",value:function(){return _t.calc({input:this},this.dtype)}},{key:"round",value:function(){return Et.calc({input:this},this.dtype)}},{key:"negate",value:function(){return Bt.calc({input:this},this.dtype)}},{key:"addMultiplyScalar",value:function(e,t){return Wt.calc({input:this,factor:e,add:t},this.dtype)}},{key:"powerScalar",value:function(e,t){return Lt.calc({input:this,factor:t,power:e},this.dtype)}},{key:"sign",value:function(){return Ft.calc({input:this},this.dtype)}},{key:"setValues",value:function(e,t){if(!(e instanceof n))throw new Error("Can only set GPU values to GPU tensor");return fn.calc({A:this,Values:e,starts:t},this.dtype)}},{key:"add_impl",value:function(e,t,a,i,r){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only add GPU tensor to GPU tensor");return Kt.calc({A:e,B:t,outputShape:a,alpha:i,beta:r},this.dtype)}},{key:"subtract_impl",value:function(e,t,a,i,r){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only subtract GPU tensor from GPU tensor");return Qt.calc({A:e,B:t,outputShape:a,alpha:i,beta:r},this.dtype)}},{key:"multiply_impl",value:function(e,t,a,i){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only multiply GPU tensor with GPU tensor");return $t.calc({A:e,B:t,outputShape:a,alpha:i},this.dtype)}},{key:"divide_impl",value:function(e,t,a,i){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only divide GPU tensor by GPU tensor");return en.calc({A:e,B:t,outputShape:a,alpha:i},this.dtype)}},{key:"power_impl",value:function(e,t,a){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only take GPU tensor to power of GPU tensor");return tn.calc({A:e,B:t,outputShape:a},this.dtype)}},{key:"matMul",value:function(e){if(!(e instanceof n))throw new Error("Can only matrix multiply GPU tensor to GPU tensor");return gt.calc({A:this,B:e},this.dtype)}},{key:"gemm_impl",value:function(e,t,a,i,r,s){if(!(e instanceof n&&(void 0===s||s instanceof n)))throw new Error("Can only do gemm with CPU tensors");return void 0===s?wt.calc({a:this,b:e,aTranspose:t,bTranspose:a,alpha:i,beta:r},this.dtype):kt.calc({a:this,b:e,c:s,aTranspose:t,bTranspose:a,alpha:i,beta:r},this.dtype)}},{key:"sum_impl",value:function(e,t){return sn.calc({X:this,axes:e,keepDims:t},this.dtype)}},{key:"sumSquare_impl",value:function(e,t){return rn.calc({X:this,axes:e,keepDims:t},this.dtype)}},{key:"reduceMean_impl",value:function(e,t){return nn.calc({X:this,axes:e,keepDims:t},this.dtype)}},{key:"reduceMeanSquare_impl",value:function(e,t){return an.calc({X:this,axes:e,keepDims:t},this.dtype)}},{key:"reduceLogSum_impl",value:function(e,t){return hn.calc({X:this,axes:e,keepDims:t},this.dtype)}},{key:"reduceLogSumExp_impl",value:function(e,t){return ln.calc({X:this,axes:e,keepDims:t},this.dtype)}},{key:"product_impl",value:function(e,t){return on.calc({X:this,axes:e,keepDims:t},this.dtype)}},{key:"max_impl",value:function(e,t){return un.calc({X:this,axes:e,keepDims:t},this.dtype)}},{key:"min_impl",value:function(e,t){return cn.calc({X:this,axes:e,keepDims:t},this.dtype)}},{key:"conv_impl",value:function(e,t,a,i,r,s,o){if(!(e instanceof n)||void 0!==o&&!(o instanceof n))throw new Error("Can only do convolution of GPU tensor with GPU tensor");return void 0===o?Nt.calc({X:this,W:e,pads:i,dilations:t,strides:r,activation:s},this.dtype):Ht.calc({X:this,W:e,B:o,pads:i,dilations:t,strides:r,activation:s},this.dtype)}},{key:"convTranspose_impl",value:function(e,t,a,i,r){if(!(e instanceof n))throw new Error("Can only do transpose convolution of GPU tensor with GPU tensor");return Zt.calc({X:this,W:e,pads:i,dilations:t,strides:r},this.dtype)}},{key:"averagePool_impl",value:function(e,t,n,a){return qt.calc({X:this,includePad:a,kernelShape:e,pads:t,strides:n},this.dtype)}},{key:"reshape_impl",value:function(e,t){return t?dn.calc({input:this,outputShape:e},this.dtype):new n(this.memory,e,this.dtype)}},{key:"concat",value:function(e,t){if(!(e instanceof n))throw new Error("Can only concat GPU tensor to GPU tensor");return t<0&&(t+=this.shape.length),pn.calc({A:this,B:e,axis:t},this.dtype)}},{key:"transpose_impl",value:function(e){return yn.calc({A:this,permutation:e},this.dtype)}},{key:"clip",value:function(e,t){return Rt.calc({input:this,minVal:e,maxVal:t},this.dtype)}},{key:"clipBackward",value:function(e,t,n){return Pt.calc({input:this,minVal:t,maxVal:n,grad:e},this.dtype)}},{key:"repeat",value:function(e){return gn.calc({A:this,repeats:e},this.dtype)}},{key:"expand",value:function(e){var t=this.alignShapes(this.shape,e),n=Object(x.a)(t,3),a=n[0],i=(n[1],n[2]);return M(this.shape,i)?this.copy():vn.calc({input:this.reshape(a,!1),outputShape:i},this.dtype)}},{key:"pad_impl",value:function(e,t,n){return Yt.calc({input:this,pads:e,mode:t,value:n},this.dtype)}},{key:"gather",value:function(e,t){return mn.calc({X:this,axis:e,indices:t},this.dtype)}},{key:"slice_impl",value:function(e,t,n,a){return wn.calc({X:this,starts:e,ends:t,axes:n,steps:a},this.dtype)}},{key:"upsample",value:function(e){return Jt.calc({X:this,scales:e},this.dtype)}},{key:"normalize",value:function(e,t,a,i,r){if(!(e instanceof n)||!(t instanceof n)||!(i instanceof n)||!(r instanceof n))throw new Error("Can only normalize with CPU tensors");return kn.calc({X:this,Mean:e,Variance:t,Scale:i,Bias:r,epsilon:a},this.dtype)}}],[{key:"range",value:function(e,t,a,i){for(var r=Math.max(Math.ceil((t-e)/a),0),s=new Array(r),o=0;o<r;o++)s[o]=e+o*a;return new n(s,[r],i)}},{key:"fromData",value:function(e){var t=Y.texture({data:e,format:"rgba",type:J.getColorType("float32")}),a=J.allocateFramebuffer(t,"float32"),i=t.width;return new n(a,[t.height,i,4],"float32")}}]),n}(D);function ut(e,t,n){return new ot(e,t,n)}var ct,ht,lt,pt,ft,dt,vt,mt,yt,gt=new Ue((function(e){return new te(ut,e)})),wt=new Ue((function(e){return new Ie(ut,e)})),kt=new Ue((function(e){return new Te(ut,e)})),bt=new Ue((function(e){return new ae(ut,e)})),xt=new Ue((function(e){return new se(ut,e)})),Ot=new Ue((function(e){return new He(ut,e)})),jt=new Ue((function(e){return new Je(ut,e)})),St=new Ue((function(e){return new $e(ut,e)})),At=new Ue((function(e){return new Ze(ut,e)})),Mt=new Ue((function(e){return new Ke(ut,e)})),It=new Ue((function(e){return new et(ut,e)})),Tt=new Ue((function(e){return new Ye(ut,e)})),Vt=new Ue((function(e){return new Qe(ut,e)})),Dt=new Ue((function(e){return new tt(ut,e)})),Xt=new Ue((function(e){return new Fe(ut,e)})),Ct=new Ue((function(e){return new it(ut,e)})),_t=new Ue((function(e){return new be(ut,e)})),Gt=new Ue((function(e){return new Oe(ut,e)})),Et=new Ue((function(e){return new st(ut,e)})),Rt=new Ue((function(e){return new xe(ut,e)})),Pt=new Ue((function(e){return new We(ut,e)})),Ut=new Ue((function(e){return new De(ut,e)})),zt=new Ue((function(e){return new Xe(ut,e)})),Bt=new Ue((function(e){return new Be(ut,e)})),Wt=new Ue((function(e){return new Ne(ut,e)})),Lt=new Ue((function(e){return new rt(ut,e)})),Ft=new Ue((function(e){return new ze(ut,e)})),Nt=new Ue((function(e){return new ie(ut,e)})),qt=new Ue((function(e){return new pe(ut,e)})),Ht=new Ue((function(e){return new re(ut,e)})),Zt=new Ue((function(e){return new Le(ut,e)})),Yt=new Ue((function(e){return new Ge(ut,e)})),Jt=new Ue((function(e){return new Re(ut,e)})),Kt=new Ue((function(e){return new ue(ut,e)})),Qt=new Ue((function(e){return new he(ut,e)})),$t=new Ue((function(e){return new ce(ut,e)})),en=new Ue((function(e){return new le(ut,e)})),tn=new Ue((function(e){return new Ve(ut,e)})),nn=new Ue((function(e){return new de(ut,e)})),an=new Ue((function(e){return new ve(ut,e)})),rn=new Ue((function(e){return new me(ut,e)})),sn=new Ue((function(e){return new ye(ut,e)})),on=new Ue((function(e){return new ge(ut,e)})),un=new Ue((function(e){return new we(ut,e)})),cn=new Ue((function(e){return new ke(ut,e)})),hn=new Ue((function(e){return new nt(ut,e)})),ln=new Ue((function(e){return new at(ut,e)})),pn=new Ue((function(e){return new je(ut,e)})),fn=new Ue((function(e){return new qe(ut,e)})),dn=new Ue((function(e){return new Se(ut,e)})),vn=new Ue((function(e){return new Ae(ut,e)})),mn=new Ue((function(e){return new Me(ut,e)})),yn=new Ue((function(e){return new Ce(ut,e)})),gn=new Ue((function(e){return new _e(ut,e)})),wn=new Ue((function(e){return new Ee(ut,e)})),kn=new Ue((function(e){return new Pe(ut,e)})),bn=(new Promise((function(e){n.e(3).then(n.bind(null,146)).then((function(t){ct=t.TensorF32,ht=t.TensorF64,lt=t.TensorI32,pt=t.TensorI16,ft=t.TensorI8,dt=t.TensorU32,vt=t.TensorU16,mt=t.TensorU8,yt={float64:ht,float32:ct,int32:lt,int16:pt,int8:ft,uint32:dt,uint16:vt,uint8:mt},e()}))})),function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;if(Object(f.a)(this,n),r=t.call(this,i||"float32"),e instanceof Array){if(void 0===a)throw new Error("Need the shape when creating a Wasm tensor from values");var s=new V[r.dtype](e);r.wasmTensor=yt[r.dtype].create(a,s)}else r.wasmTensor=e;return r}return Object(d.a)(n,[{key:"cast",value:function(e){throw new Error("Method not implemented.")}},{key:"getValues",value:function(){return Promise.resolve(this.wasmTensor.get_vals())}},{key:"getShape",value:function(){return Array.from(this.wasmTensor.get_shape())}},{key:"constantLike",value:function(e){return new n([e],this.wasmTensor.get_shape(),this.dtype)}},{key:"singleConstant",value:function(e){return new n([e],new Uint32Array([1]),this.dtype)}},{key:"delete",value:function(){void 0!==this.wasmTensor&&(this.wasmTensor.free(),this.wasmTensor=void 0)}},{key:"copy",value:function(){return new n(this.wasmTensor.copy(),void 0,this.dtype)}},{key:"exp",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Exp can only be called on float tensors");return new n(this.wasmTensor.exp())}},{key:"log",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Log can only be called on float tensors");return new n(this.wasmTensor.log())}},{key:"sqrt",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Sqrt can only be called on float tensors");return new n(this.wasmTensor.sqrt())}},{key:"abs",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct)&&!(this.wasmTensor instanceof lt)&&!(this.wasmTensor instanceof pt)&&!(this.wasmTensor instanceof ft))throw new Error("Abs can only be called on signed tensors");return new n(this.wasmTensor.abs())}},{key:"sin",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Sin can only be called on float tensors");return new n(this.wasmTensor.sin())}},{key:"cos",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Cos can only be called on float tensors");return new n(this.wasmTensor.cos())}},{key:"tan",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Tan can only be called on float tensors");return new n(this.wasmTensor.tan())}},{key:"asin",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Asin can only be called on float tensors");return new n(this.wasmTensor.asin())}},{key:"acos",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Acos can only be called on float tensors");return new n(this.wasmTensor.acos())}},{key:"atan",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Atan can only be called on float tensors");return new n(this.wasmTensor.atan())}},{key:"sinh",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Sinh can only be called on float tensors");return new n(this.wasmTensor.sinh())}},{key:"cosh",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Cosh can only be called on float tensors");return new n(this.wasmTensor.cosh())}},{key:"tanh",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Tanh can only be called on float tensors");return new n(this.wasmTensor.tanh())}},{key:"asinh",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Asinh can only be called on float tensors");return new n(this.wasmTensor.asinh())}},{key:"acosh",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Acosh can only be called on float tensors");return new n(this.wasmTensor.acosh())}},{key:"atanh",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Atanh can only be called on float tensors");return new n(this.wasmTensor.atanh())}},{key:"sigmoid",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Sigmoid can only be called on float tensors");return new n(this.wasmTensor.sigmoid())}},{key:"hardSigmoid",value:function(e,t){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("HardSigmoid can only be called on float tensors");return new n(this.wasmTensor.hard_sigmoid(e,t))}},{key:"negate",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct)&&!(this.wasmTensor instanceof lt)&&!(this.wasmTensor instanceof pt)&&!(this.wasmTensor instanceof ft))throw new Error("Negate can only be called on signed tensors");return new n(this.wasmTensor.negate())}},{key:"powerScalar",value:function(e,t){return new n(this.wasmTensor.power_scalar(e,t))}},{key:"addMultiplyScalar",value:function(e,t){return new n(this.wasmTensor.add_multiply_scalar(e,t))}},{key:"sign",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct)&&!(this.wasmTensor instanceof lt)&&!(this.wasmTensor instanceof pt)&&!(this.wasmTensor instanceof ft))throw new Error("Sign can only be called on signed tensors");return new n(this.wasmTensor.sign())}},{key:"setValues",value:function(e,t){if(!(e instanceof n))throw new Error("Can only set WASM values to WASM values");return new n(this.wasmTensor.set_values(e.wasmTensor,new Uint32Array(t)))}},{key:"add_impl",value:function(e,t,a,i,r){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only add WASM tensor to WASM tensor");return new n(e.wasmTensor.addition(t.wasmTensor,i,r))}},{key:"subtract_impl",value:function(e,t,a,i,r){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only subtract WASM tensor from WASM tensor");return new n(e.wasmTensor.subtraction(t.wasmTensor,i,r))}},{key:"multiply_impl",value:function(e,t,a,i){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only multiply WASM tensor with WASM tensor");return new n(e.wasmTensor.multiply(t.wasmTensor,i))}},{key:"divide_impl",value:function(e,t,a,i){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only divide WASM tensor by WASM tensor");return new n(e.wasmTensor.divide(t.wasmTensor,i))}},{key:"power_impl",value:function(e,t,a){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only take WASM tensor to power of WASM tensor");return new n(e.wasmTensor.power(t.wasmTensor))}},{key:"matMul",value:function(e){if(!(e instanceof n))throw new Error("Can only add WASM tensor to WASM tensor");return new n(this.wasmTensor.matmul(e.wasmTensor))}},{key:"gemm_impl",value:function(e,t,a,i,r,s){if(!(e instanceof n&&(void 0===s||s instanceof n)))throw new Error("Can only do gemm with CPU tensors");return new n(void 0!==s?this.wasmTensor.gemm_with_c(e.wasmTensor,t,a,i,s.wasmTensor,r):this.wasmTensor.gemm(e.wasmTensor,t,a,i))}},{key:"sum_impl",value:function(e,t){return new n(this.wasmTensor.sum(new Uint32Array(e),t))}},{key:"sumSquare_impl",value:function(e,t){return new n(this.wasmTensor.sum_square(new Uint32Array(e),t))}},{key:"product_impl",value:function(e,t){return new n(this.wasmTensor.product(new Uint32Array(e),t))}},{key:"max_impl",value:function(e,t){return new n(this.wasmTensor.max(new Uint32Array(e),t))}},{key:"min_impl",value:function(e,t){return new n(this.wasmTensor.min(new Uint32Array(e),t))}},{key:"reduceMean_impl",value:function(e,t){return new n(this.wasmTensor.reduce_mean(new Uint32Array(e),t))}},{key:"reduceMeanSquare_impl",value:function(e,t){return new n(this.wasmTensor.reduce_mean_square(new Uint32Array(e),t))}},{key:"reduceLogSum_impl",value:function(e,t){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("ReduceLogSum can only be called on float tensors");return new n(this.wasmTensor.reduce_log_sum(new Uint32Array(e),t))}},{key:"reduceLogSumExp_impl",value:function(e,t){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("ReduceLogSumExp can only be called on float tensors");return new n(this.wasmTensor.reduce_log_sum_exp(new Uint32Array(e),t))}},{key:"getActivationFlag",value:function(e){return"id"===e?0:"relu"===e?1:2}},{key:"conv_impl",value:function(e,t,a,i,r,s,o){if(!(e instanceof n)||void 0!==o&&!(o instanceof n))throw new Error("Can only do convolution of WASM tensor with WASM tensor");var u=this.getActivationFlag(s);return new n(void 0!==o?this.wasmTensor.conv_with_bias(e.wasmTensor,o.wasmTensor,new Uint32Array(t),a,new Uint32Array(i),new Uint32Array(r),u):this.wasmTensor.conv(e.wasmTensor,new Uint32Array(t),a,new Uint32Array(i),new Uint32Array(r),u))}},{key:"convTranspose_impl",value:function(e,t,a,i,r){if(!(e instanceof n))throw new Error("Can only do transpose convolution of WASM tensor with WASM tensor");return new n(this.wasmTensor.conv_transpose(e.wasmTensor,new Uint32Array(t),a,new Uint32Array(i),new Uint32Array(r)))}},{key:"averagePool_impl",value:function(e,t,a,i){return new n(this.wasmTensor.average_pool(new Uint32Array(e),new Uint32Array(t),new Uint32Array(a),i))}},{key:"reshape_impl",value:function(e){var t=new Uint32Array(e);return new n(this.wasmTensor.reshape(t),t)}},{key:"concat",value:function(e,t){if(!(e instanceof n))throw new Error("Can only concat WASM tensor to WASM tensor");return t<0&&(t+=this.getShape().length),new n(this.wasmTensor.concat(e.wasmTensor,t))}},{key:"transpose_impl",value:function(e){return new n(this.wasmTensor.transpose(new Uint32Array(e)))}},{key:"clip",value:function(e,t){return void 0!==e&&void 0!==t?new n(this.wasmTensor.clip(e,t)):void 0!==e?new n(this.wasmTensor.clip_min(e)):void 0!==t?new n(this.wasmTensor.clip_max(t)):this.copy()}},{key:"clipBackward",value:function(e,t,a){if(!(e instanceof n))throw new Error("Can only do grad backward with Wasm tensor");return void 0!==t&&void 0!==a?new n(this.wasmTensor.clip_backward(t,a,e.wasmTensor)):void 0!==t?new n(this.wasmTensor.clip_min_backward(t,e.wasmTensor)):void 0!==a?new n(this.wasmTensor.clip_max_backward(a,e.wasmTensor)):this.copy()}},{key:"repeat",value:function(e){return new n(this.wasmTensor.repeat(new Uint32Array(e)))}},{key:"expand",value:function(e){var t=this.getShape(),a=this.alignShapes(t,e),i=Object(x.a)(a,3),r=i[0],s=(i[1],i[2]);return M(t,s)?this.copy():new n(this.reshape(r,!1).wasmTensor.expand(new Uint32Array(s)))}},{key:"pad_impl",value:function(e,t,a){return new n(this.wasmTensor.pad(new Uint32Array(e),n.padModeToInt[t],a))}},{key:"gather",value:function(e,t){return new n(this.wasmTensor.gather(e,t.values,new Uint32Array(t.shape)))}},{key:"floor",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Floor can only be called on float tensors");return new n(this.wasmTensor.floor())}},{key:"ceil",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Ceil can only be called on float tensors");return new n(this.wasmTensor.ceil())}},{key:"round",value:function(){if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Round can only be called on float tensors");return new n(this.wasmTensor.round())}},{key:"slice_impl",value:function(e,t,a,i){return new n(this.wasmTensor.slice(new Uint32Array(e),new Uint32Array(t),new Uint32Array(a),new Int32Array(i)))}},{key:"upsample",value:function(e){return new n(this.wasmTensor.upsample(new Float32Array(e)))}},{key:"normalize",value:function(e,t,a,i,r){if(!(e instanceof n)||!(t instanceof n)||!(i instanceof n)||!(r instanceof n))throw new Error("Can only normalize with WASM tensors");if(!(this.wasmTensor instanceof ht)&&!(this.wasmTensor instanceof ct))throw new Error("Normalize can only be called on float tensors");return new n(this.wasmTensor.normalize(e.wasmTensor,t.wasmTensor,a,i.wasmTensor,r.wasmTensor))}}],[{key:"range",value:function(e,t,a){for(var i=Math.max(Math.ceil((t-e)/a),0),r=new Array(i),s=0;s<i;s++)r[s]=e+s*a;return new n(r,new Uint32Array([i]))}}]),n}(D));function xn(e,t,n,a,i,r){var s,o=P(e.shape,t,n),u=Object(x.a)(o,2),c=u[0],l=u[1],p=new B(c,void 0,e.values.dtype),f=e.getDenseShape(),d=O(f,1);void 0===i&&void 0===r||(s=new Array(p.size).fill(0));for(var v=e.indices,m=e.values,y=0;y<e.nnz;y++){for(var g=new Array(e.sparseDims),w=0;w<e.sparseDims;w++)g[w]=v.get(y*e.sparseDims+w);for(var k=new Array(e.denseDims).fill(0),b=0;b<d;b++){for(var j=[].concat(g,Object(h.a)(k)),A=new Array(l.length),M=0;M<l.length;M++)A[M]=j[l[M]];var T=S(A,p.strides);void 0!==i&&void 0!==s&&0===s[T]?p.set(T,i(m.get(y*d+b))):p.set(T,a(p.get(T),m.get(y*d+b))),void 0!==s&&s[T]++,I(k,f)}}if(void 0!==r&&void 0!==s)for(var V=0;V<p.size;V++)p.set(V,r(p.get(V),s[V]));return p}function On(e,t,n){if(void 0!==t.find((function(t){return t<e.sparseDims})))return function(e,t,n){if(e.values instanceof B)return function(e,t,n){return xn(e,t,n,(function(e,t){return Math.max(e,t)}),(function(e){return e}))}(e,t,n);if(e.values instanceof bn)return function(e,t,n){return new bn(e.values.wasmTensor.max_sparse(new Uint32Array(e.getShape()),e.indices.wasmTensor,new Uint32Array(t),n),void 0,e.dtype)}(e,t,n);throw new Error("Maximum over sparse dimensions not implemented in WebGL yet")}(e,t,n);var a=P(e.shape,t,n),i=Object(x.a)(a,2),r=i[0];i[1];return new Yn(e.values.max(t.map((function(t){return t-e.sparseDims+1})),n),e.indices.copy(),r,n?e.denseDims:e.denseDims-t.length)}function jn(e,t,n){if(void 0!==t.find((function(t){return t<e.sparseDims})))return function(e,t,n){if(e.values instanceof B)return function(e,t,n){return xn(e,t,n,(function(e,t){return Math.min(e,t)}),(function(e){return e}))}(e,t,n);if(e.values instanceof bn)return function(e,t,n){return new bn(e.values.wasmTensor.min_sparse(new Uint32Array(e.getShape()),e.indices.wasmTensor,new Uint32Array(t),n),void 0,e.dtype)}(e,t,n);throw new Error("Minimum over sparse dimensions not implemented in WebGL yet")}(e,t,n);var a=P(e.shape,t,n),i=Object(x.a)(a,2),r=i[0];i[1];return new Yn(e.values.min(t.map((function(t){return t-e.sparseDims+1})),n),e.indices.copy(),r,n?e.denseDims:e.denseDims-t.length)}function Sn(e,t,n){if(void 0!==t.find((function(t){return t<e.sparseDims})))return function(e,t,n){if(e.values instanceof B)return function(e,t,n){return xn(e,t,n,(function(e,t){return e*t}),(function(e){return e}))}(e,t,n);if(e.values instanceof bn)return function(e,t,n){return new bn(e.values.wasmTensor.product_sparse(new Uint32Array(e.getShape()),e.indices.wasmTensor,new Uint32Array(t),n),void 0,e.dtype)}(e,t,n);throw new Error("Product over sparse dimensions not implemented in WebGL yet")}(e,t,n);var a=P(e.shape,t,n),i=Object(x.a)(a,2),r=i[0];i[1];return new Yn(e.values.product(t.map((function(t){return t-e.sparseDims+1})),n),e.indices.copy(),r,n?e.denseDims:e.denseDims-t.length)}function An(e,t,n){if(void 0!==t.find((function(t){return t<e.sparseDims})))return function(e,t,n){if(e.values instanceof B)return function(e,t,n){return xn(e,t,n,(function(e,t){return e+t}),void 0,(function(e,t){return Math.log(e)}))}(e,t,n);if(e.values instanceof bn)return function(e,t,n){if("float32"!==e.dtype&&"float64"===e.dtype)throw new Error("Reduce log sum expects tensor datatype to be float, but found "+e.dtype);return new bn(e.values.wasmTensor.reduce_log_sum_sparse(new Uint32Array(e.getShape()),e.indices.wasmTensor,new Uint32Array(t),n),void 0,e.dtype)}(e,t,n);throw new Error("Reduce log sum over sparse dimensions not implemented in WebGL yet")}(e,t,n);var a=P(e.shape,t,n),i=Object(x.a)(a,2),r=i[0];i[1];return new Yn(e.values.reduceLogSum(t.map((function(t){return t-e.sparseDims+1})),n),e.indices.copy(),r,n?e.denseDims:e.denseDims-t.length)}function Mn(e,t,n){if(void 0!==t.find((function(t){return t<e.sparseDims})))return function(e,t,n){if(e.values instanceof B)return function(e,t,n){return xn(e,t,n,(function(e,t){return e+Math.exp(t)}),(function(e){return Math.exp(e)}),(function(e,t){return Math.log(e)}))}(e,t,n);if(e.values instanceof bn)return function(e,t,n){if("float32"!==e.dtype&&"float64"===e.dtype)throw new Error("Reduce log sum exp expects tensor datatype to be float, but found "+e.dtype);return new bn(e.values.wasmTensor.reduce_log_sum_exp_sparse(new Uint32Array(e.getShape()),e.indices.wasmTensor,new Uint32Array(t),n),void 0,e.dtype)}(e,t,n);throw new Error("Reduce log sum exp over sparse dimensions not implemented in WebGL yet")}(e,t,n);var a=P(e.shape,t,n),i=Object(x.a)(a,2),r=i[0];i[1];return new Yn(e.values.reduceLogSumExp(t.map((function(t){return t-e.sparseDims+1})),n),e.indices.copy(),r,n?e.denseDims:e.denseDims-t.length)}function In(e,t,n){if(void 0!==t.find((function(t){return t<e.sparseDims})))return function(e,t,n){if(e.values instanceof B)return function(e,t,n){return xn(e,t,n,(function(e,t){return e+t}),void 0,(function(e,t){return e/t}))}(e,t,n);if(e.values instanceof bn)return function(e,t,n){return new bn(e.values.wasmTensor.reduce_mean_sparse(new Uint32Array(e.getShape()),e.indices.wasmTensor,new Uint32Array(t),n),void 0,e.dtype)}(e,t,n);throw new Error("Reduce mean over sparse dimensions not implemented in WebGL yet")}(e,t,n);var a=P(e.shape,t,n),i=Object(x.a)(a,2),r=i[0];i[1];return new Yn(e.values.reduceMean(t.map((function(t){return t-e.sparseDims+1})),n),e.indices.copy(),r,n?e.denseDims:e.denseDims-t.length)}function Tn(e,t,n){if(void 0!==t.find((function(t){return t<e.sparseDims})))return function(e,t,n){if(e.values instanceof B)return function(e,t,n){return xn(e,t,n,(function(e,t){return e+t*t}),(function(e){return e*e}),(function(e,t){return e/t}))}(e,t,n);if(e.values instanceof bn)return function(e,t,n){return new bn(e.values.wasmTensor.reduce_mean_squared_sparse(new Uint32Array(e.getShape()),e.indices.wasmTensor,new Uint32Array(t),n),void 0,e.dtype)}(e,t,n);throw new Error("Reduce mean squared over sparse dimensions not implemented in WebGL yet")}(e,t,n);var a=P(e.shape,t,n),i=Object(x.a)(a,2),r=i[0];i[1];return new Yn(e.values.reduceMeanSquare(t.map((function(t){return t-e.sparseDims+1})),n),e.indices.copy(),r,n?e.denseDims:e.denseDims-t.length)}function Vn(e,t,n){if(void 0!==t.find((function(t){return t<e.sparseDims})))return function(e,t,n){if(e.values instanceof B)return function(e,t,n){return xn(e,t,n,(function(e,t){return e+t}))}(e,t,n);if(e.values instanceof bn)return function(e,t,n){return new bn(e.values.wasmTensor.sum_sparse(new Uint32Array(e.getShape()),e.indices.wasmTensor,new Uint32Array(t),n),void 0,e.dtype)}(e,t,n);throw new Error("Sum over sparse dimensions not implemented in WebGL yet")}(e,t,n);var a=P(e.shape,t,n),i=Object(x.a)(a,2),r=i[0];i[1];return new Yn(e.values.sum(t.map((function(t){return t-e.sparseDims+1})),n),e.indices.copy(),r,n?e.denseDims:e.denseDims-t.length)}function Dn(e,t,n){if(void 0!==t.find((function(t){return t<e.sparseDims})))return function(e,t,n){if(e.values instanceof B)return function(e,t,n){return xn(e,t,n,(function(e,t){return e+t*t}),(function(e){return e*e}))}(e,t,n);if(e.values instanceof bn)return function(e,t,n){return new bn(e.values.wasmTensor.sum_square_sparse(new Uint32Array(e.getShape()),e.indices.wasmTensor,new Uint32Array(t),n),void 0,e.dtype)}(e,t,n);throw new Error("Squared sum over sparse dimensions not implemented in WebGL yet")}(e,t,n);var a=P(e.shape,t,n),i=Object(x.a)(a,2),r=i[0];i[1];return new Yn(e.values.sumSquare(t.map((function(t){return t-e.sparseDims+1})),n),e.indices.copy(),r,n?e.denseDims:e.denseDims-t.length)}function Xn(e,t,n,a){for(var i=e.sparseDims,r=n.slice(0,i),s=n.slice(i),o=O(s,1),u=e.values,c=e.indices,l=new B([e.nnz].concat(Object(h.a)(s)),void 0,e.dtype),p=e.indices.copy(),f=0;f<e.nnz;f++){for(var d=new Array(r.length),v=0;v<r.length;v++)d[v]=c.get(f*i+v);for(var m=new Array(s.length).fill(0),y=0;y<o;y++){var g=u.get([f].concat(Object(h.a)(m))),w=t.get([].concat(d,Object(h.a)(m)));l.set(f*o+y,a(g,w)),I(m,s)}}return new Yn(l,p,n,e.denseDims)}function Cn(e,t,n,a){for(var i=e.sparseDims,r=n.slice(0,i),s=n.slice(i),o=O(s,1),u=e.values,c=e.indices,l=t.values,p=t.indices,f=j(r),d={},v=0;v<t.nnz;v++){for(var m=0,y=0;y<i;y++)m+=p.get(v*i+y)*f[y];d[m]=v}for(var g=new B([e.nnz].concat(Object(h.a)(s)),void 0,e.dtype),w=e.indices.copy(),k=0;k<e.nnz;k++){for(var b=0,x=0;x<i;x++)b+=c.get(k*i+x)*f[x];for(var S=d[b],A=new Array(s.length).fill(0),M=0;M<o;M++){var T=u.get([k].concat(Object(h.a)(A))),V=l.get([S].concat(Object(h.a)(A)));g.set(k*o+M,a(T,V)),I(A,s)}}return new Yn(g,w,n,e.denseDims)}function _n(e,t,n,a,i){return t instanceof Yn?function(e,t,n,a,i){if(e.nnz!==t.nnz)throw new Error("Addition with two sparse tensors expects the same sparsity pattern, and thus the same number of nonzero entries in both tensors");if(e.denseDims!==t.denseDims)throw new Error("Addition with two sparse tensors expects the same number of sparse and dense dimensions in both tensors");if(e.values instanceof B)return function(e,t,n,a,i){return Cn(e,t,n,(function(e,t){return a*e+i*t}))}(e,t,n,a,i);if(e.values instanceof bn)return function(e,t,n,a,i){var r=new bn(e.values.wasmTensor.add_sparse_sparse(e.indices.wasmTensor,t.indices.wasmTensor,t.values.wasmTensor,new Uint32Array(n),a,i),void 0,e.dtype);return new Yn(r,e.indices.copy(),n,e.denseDims)}(e,t,n,a,i);throw new Error("Sparse-sparse matrix addition not supported on WebGL backend")}(e,t,n,a,i):function(e,t,n,a,i){if(t instanceof B)return function(e,t,n,a,i){return Xn(e,t,n,(function(e,t){return a*e+i*t}))}(e,t,n,a,i);if(t instanceof bn)return function(e,t,n,a,i){var r=new bn(e.values.wasmTensor.add_sparse_dense(e.indices.wasmTensor,t.wasmTensor,new Uint32Array(n),a,i),void 0,e.dtype);return new Yn(r,e.indices.copy(),n,e.denseDims)}(e,t,n,a,i);throw new Error("Sparse-dense matrix addition not supported on WebGL backend")}(e,t,n,a,i)}function Gn(e,t,n,a){return t instanceof Yn?function(e,t,n,a){if(e.nnz!==t.nnz)throw new Error("Element wise division with two sparse tensors expects the same sparsity pattern, and thus the same number of nonzero entries in both tensors");if(e.denseDims!==t.denseDims)throw new Error("Element wise division with two sparse tensors expects the same number of sparse and dense dimensions in both tensors");if(e.values instanceof B)return function(e,t,n,a){return Cn(e,t,n,(function(e,t){return a*e/t}))}(e,t,n,a);if(e.values instanceof bn)return function(e,t,n,a){var i=new bn(e.values.wasmTensor.divide_sparse_sparse(e.indices.wasmTensor,t.indices.wasmTensor,t.values.wasmTensor,new Uint32Array(n),a),void 0,e.dtype);return new Yn(i,e.indices.copy(),n,e.denseDims)}(e,t,n,a);throw new Error("Sparse-sparse matrix division not supported on WebGL backend")}(e,t,n,a):function(e,t,n,a){if(t instanceof B)return function(e,t,n,a){return Xn(e,t,n,(function(e,t){return a*e/t}))}(e,t,n,a);if(t instanceof bn)return function(e,t,n,a){var i=new bn(e.values.wasmTensor.divide_sparse_dense(e.indices.wasmTensor,t.wasmTensor,new Uint32Array(n),a),void 0,e.dtype);return new Yn(i,e.indices.copy(),n,e.denseDims)}(e,t,n,a);throw new Error("Sparse-dense matrix element wise division not supported on WebGL backend")}(e,t,n,a)}function En(e,t,n,a){return t instanceof Yn?function(e,t,n,a){if(e.nnz!==t.nnz)throw new Error("Element wise multiplication with two sparse tensors expects the same sparsity pattern, and thus the same number of nonzero entries in both tensors");if(e.denseDims!==t.denseDims)throw new Error("Element wise multiplication with two sparse tensors expects the same number of sparse and dense dimensions in both tensors");if(e.values instanceof B)return function(e,t,n,a){return Cn(e,t,n,(function(e,t){return a*e*t}))}(e,t,n,a);if(e.values instanceof bn)return function(e,t,n,a){var i=new bn(e.values.wasmTensor.multiply_sparse_sparse(e.indices.wasmTensor,t.indices.wasmTensor,t.values.wasmTensor,new Uint32Array(n),a),void 0,e.dtype);return new Yn(i,e.indices.copy(),n,e.denseDims)}(e,t,n,a);throw new Error("Sparse-sparse matrix addition not supported on WebGL backend")}(e,t,n,a):function(e,t,n,a){if(t instanceof B)return function(e,t,n,a){return Xn(e,t,n,(function(e,t){return a*e*t}))}(e,t,n,a);if(t instanceof bn)return function(e,t,n,a){var i=new bn(e.values.wasmTensor.multiply_sparse_dense(e.indices.wasmTensor,t.wasmTensor,new Uint32Array(n),a),void 0,e.dtype);return new Yn(i,e.indices.copy(),n,e.denseDims)}(e,t,n,a);throw new Error("Sparse-dense matrix element wise multiplication not supported on WASM/WebGL backend")}(e,t,n,a)}function Rn(e,t,n,a,i){return t instanceof Yn?function(e,t,n,a,i){if(e.nnz!==t.nnz)throw new Error("Subtraction with two sparse tensors expects the same sparsity pattern, and thus the same number of nonzero entries in both tensors");if(e.denseDims!==t.denseDims)throw new Error("Subtraction with two sparse tensors expects the same number of sparse and dense dimensions in both tensors");if(e.values instanceof B)return function(e,t,n,a,i){return Cn(e,t,n,(function(e,t){return a*e-i*t}))}(e,t,n,a,i);if(e.values instanceof bn)return function(e,t,n,a,i){var r=new bn(e.values.wasmTensor.subtract_sparse_sparse(e.indices.wasmTensor,t.indices.wasmTensor,t.values.wasmTensor,new Uint32Array(n),a,i),void 0,e.dtype);return new Yn(r,e.indices.copy(),n,e.denseDims)}(e,t,n,a,i);throw new Error("Sparse-sparse matrix subtraction not supported on WebGL backend")}(e,t,n,a,i):function(e,t,n,a,i){if(t instanceof B)return function(e,t,n,a,i){return Xn(e,t,n,(function(e,t){return a*e-i*t}))}(e,t,n,a,i);if(t instanceof bn)return function(e,t,n,a,i){var r=new bn(e.values.wasmTensor.subtract_sparse_dense(e.indices.wasmTensor,t.wasmTensor,new Uint32Array(n),a,i),void 0,e.dtype);return new Yn(r,e.indices.copy(),n,e.denseDims)}(e,t,n,a,i);throw new Error("Sparse-dense matrix addition not supported on WASM/WebGL backend")}(e,t,n,a,i)}bn.padModeToInt={constant:0,reflect:1,edge:2};var Pn=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("axis")," int axis;\n    ").concat(this.getVarModifier("count")," int count;\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"axis"},{name:"count"}]}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      float res = _A(index);\n\n      if (index[1] == axis) {\n        res += float(count);\n      }\n\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["A"]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{A:e.A});var t=this.getOutputShape(e),n=this.getCompilationInfo(e);return this.compute(t,{A:e.A},{axis:n.axis,count:n.count})}},{key:"getOutputShape",value:function(e){return Object(h.a)(e.A.shape)}},{key:"compile",value:function(e){Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeA:e.A.shape,widthA:e.A.memory.width,heightA:e.A.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,axis:e.axis,count:e.count}}},{key:"getInputInfoString",value:function(e){return"".concat(e.A.shape,"-").concat(e.axis,"-").concat(e.count)}}]),n}(ee),Un=new Ue((function(e){return new Pn(ut,e)}));function zn(e,t,n){if(!M(e.shape,t.shape)||e.sparseDims!==t.sparseDims)throw new Error("Sparse tensors can only be concatenated with the same shape and number of sparse dims");if(n>e.sparseDims)throw new Error("Concatenation along dense axis of sparse tensor not supported yet");var a=e.values.concat(t.values,0),i=function(e,t,n){return e instanceof B?function(e,t,n){for(var a=e.copy(),i=t;i<a.size;i+=e.shape[1])a.set(i,a.get(i)+n);return a}(e,t,n):e instanceof bn?function(e,t,n){return new bn(e.wasmTensor.add_index(t,n))}(e,t,n):function(e,t,n){return Un.calc({A:e,axis:t,count:n},"uint32")}(e,t,n)}(t.indices,n,e.shape[n]),r=e.indices.concat(i,0);i.delete();var s=Object(h.a)(e.shape);return s[n]+=t.shape[n],new Yn(a,r,s,e.denseDims)}function Bn(e,t){if(t instanceof Yn)throw new Error("Sparse-sparse matrix multiplication not yet implemented");return function(e,t){if(1===e.denseDims)return new Yn(e.values.matMul(t),e.indices.copy(),[e.shape[0],t.getShape()[1]],1);if(t instanceof B)return function(e,t){for(var n=e.shape[0],a=t.shape[1],i=new B([n,a],void 0,t.dtype),r=e.indices,s=e.values,o=0;o<e.nnz;o++)for(var u=r.get(2*o),c=r.get(2*o+1),h=s.get(o),l=0;l<a;l++)i.set(u*a+l,i.get(u*a+l)+h*t.get(c*a+l));return i}(e,t);if(t instanceof bn)return function(e,t){return new bn(e.values.wasmTensor.matmul_sparse_dense(e.indices.wasmTensor,t.wasmTensor,e.shape[0]),void 0,e.dtype)}(e,t);throw new Error("Sparse-dense matrix multiplication not yet supported on WebGL")}(e,t)}var Wn=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("sparseShape")," int sparseShape[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("repeatStrides")," int repeatStrides[").concat(this.maxRank,"];\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"sparseShape",length:this.maxRank},{name:"repeatStrides",length:this.maxRank}]}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      int newPos = index[0];\n      int nnz = shapeA[0];\n\n      int repeatPos = newPos / nnz;\n      int oldPos = newPos - repeatPos*nnz;\n\n      int oldIx[").concat(this.maxRank,"];\n      ").concat(this.initIndex("oldIx"),"\n      oldIx[0] = oldPos;\n      oldIx[1] = index[1];\n\n      int repeatIx[").concat(this.maxRank,"];\n      ").concat(this.initIndex("repeatIx"),"\n      ").concat(this.posToIndex("repeatStrides","repeatIx","repeatPos"),"\n\n      float res = _A(oldIx);\n      for (int i = 0; i < ").concat(this.maxRank,"; i++) {\n        if (i == index[1]) {\n          res += float(repeatIx[i]*sparseShape[i]);\n          break;\n        }\n      }\n\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["A"]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{A:e.A});var t=this.getOutputShape(e),n=this.getCompilationInfo(e);return this.compute(t,{A:e.A},{sparseShape:this.pad(n.sparseShape),repeatStrides:this.pad(n.repeatStrides)})}},{key:"getOutputShape",value:function(e){return[e.A.shape[0]*e.repeatsProd,e.A.shape[1]]}},{key:"compile",value:function(e){void 0!==e.sparseShape&&(this.maxRank=e.sparseShape.length),void 0!==e.repeatStrides&&(this.maxRank=e.repeatStrides.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeA:e.A.shape,widthA:e.A.memory.width,heightA:e.A.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,sparseShape:e.shape,repeatStrides:j(e.repeats)}}},{key:"getInputInfoString",value:function(e){return"".concat(e.A.shape,"-").concat(e.repeats,"-").concat(e.shape)}}]),n}(ee),Ln=new Ue((function(e){return new Wn(ut,e)}));function Fn(e,t){var n,a=t.slice(0,e.sparseDims),i=t.slice(e.sparseDims),r=a.reduce((function(e,t){return e*t}),1),s=e.values.repeat([r].concat(Object(h.a)(i)));n=r>1?function(e,t,n,a){return e instanceof B?function(e,t,n,a){for(var i=e.shape[0],r=i*a,s=e.shape[1],o=new B([i*a,s],void 0,"uint32"),u=j(t),c=0;c<r;c++)for(var h=c%i,l=A(Math.floor(c/i),u).map((function(e,t){return e*n[t]})),p=0;p<s;p++)o.set(c*s+p,l[p]+e.get(h*s+p));return o}(e,t,n,a):e instanceof bn?function(e,t,n,a){return new bn(e.wasmTensor.repeat_sparse_indices(new Uint32Array(t),new Uint32Array(n),a))}(e,t,n,a):function(e,t,n,a){return Ln.calc({A:e,repeats:t,shape:n,repeatsProd:a},"uint32")}(e,t,n,a)}(e.indices,a,e.getSparseShape(),r):e.indices.copy();var o=e.shape.map((function(e,n){return e*t[n]}));return new Yn(s,n,o,e.denseDims)}var Nn=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("nnzFraction")," int nnzFraction;\n    ").concat(this.getVarModifier("sparseDims")," int sparseDims;\n    ").concat(this.getVarModifier("oldSparseStrides")," int oldSparseStrides[").concat(this.maxRank,"];\n    ").concat(this.getVarModifier("newSparseStrides")," int newSparseStrides[").concat(this.maxRank,"];\n    ")}},{key:"getUniformAttrs",value:function(){return[{name:"nnzFraction"},{name:"sparseDims"},{name:"oldSparseStrides",length:this.maxRank},{name:"newSparseStrides",length:this.maxRank}]}},{key:"getFragmentShader",value:function(e){return"\n    float process(int index[".concat(this.maxRank,"]) {\n      float res = 0.0;\n\n      int newNNZ = int(index[0]);\n      int oldNnzIx = newNNZ / nnzFraction;\n      int residualNNZ = newNNZ - oldNnzIx*nnzFraction;\n\n      int oldSparseIx[").concat(this.maxRank,"];\n      ").concat(this.initIndex("oldSparseIx"),"\n      for (int j = 0; j < ").concat(this.maxRank,"; j++) {\n        if (j >= sparseDims) {\n          break;\n        }\n        oldSparseIx[j] = int(getValueAtPos(oldNnzIx * sparseDims + j, widthA, heightA, A));\n      }\n\n      int oldSparsePos = indexToPos(oldSparseIx, oldSparseStrides);\n      int newSparsePos = oldSparsePos * nnzFraction + residualNNZ;\n      int newSparseIx[").concat(this.maxRank,"];\n      ").concat(this.initIndex("newSparseIx"),"\n      ").concat(this.posToIndex("newSparseStrides","newSparseIx","newSparsePos"),"\n\n      int ax = int(index[1]);\n\n      for (int j = 0; j < ").concat(this.maxRank,"; j++) {\n        if (j == ax) {\n          res = float(newSparseIx[j]);\n          break;\n        }\n      }\n\n      return res;\n    }\n\n    ").concat(this.getDefaultMain(),"\n    ")}},{key:"getTextureNames",value:function(){return["A"]}},{key:"calc",value:function(e){if(this.fullyStatic&&void 0!==this.outputShape)return this.compute(this.outputShape,{A:e.A});var t=this.getOutputShape(e),n=this.getCompilationInfo(e);return this.compute(t,{A:e.A},{nnzFraction:n.nnzFraction,sparseDims:n.sparseDims,oldSparseStrides:this.pad(n.oldSparseStrides),newSparseStrides:this.pad(n.newSparseStrides)})}},{key:"getOutputShape",value:function(e){for(var t=O(e.sparseShape),n=[],a=1,i=0;i<e.shape.length&&a<t;i++)a*=e.shape[i],n.push(e.shape[i]);var r=a/t;return[e.nnz*r,n.length]}},{key:"compile",value:function(e){Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){for(var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype),a=O(e.sparseShape),i=[],r=[],s=1,o=0;o<e.shape.length;o++)s<a?(s*=e.shape[o],i.push(e.shape[o])):r.push(e.shape[o]);var u=j(e.sparseShape),c=j(i),h=s/a;return{shapeA:e.A.shape,widthA:e.A.memory.width,heightA:e.A.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,sparseDims:e.sparseShape.length,newSparseStrides:c,oldSparseStrides:u,nnzFraction:h}}},{key:"getInputInfoString",value:function(e){return"".concat(e.A.shape,"-").concat(e.nnz,"-").concat(e.shape,"-").concat(e.sparseShape)}}]),n}(ee),qn=new Ue((function(e){return new Nn(ut,e)}));function Hn(e,t,n){return e.values instanceof B?function(e,t,n,a,i){for(var r=O(e.getSparseShape()),s=[],o=[],u=1,c=0;c<a.length;c++)u<r?(u*=a[c],s.push(a[c])):o.push(a[c]);var h,l=j(e.getSparseShape()),p=j(s),f=u/r,d=e.nnz*f,v=t.reshape([d].concat(o),i);if(!i&&M(s,e.getSparseShape()))h=n;else{h=new B([d,s.length],void 0,"uint32");for(var m=0;m<d;m++){for(var y=Math.floor(m/f),g=[],w=0;w<e.sparseDims;w++)g.push(n.get(y*e.sparseDims+w));for(var k=A(S(g,l)*f+m%f,p),b=0;b<s.length;b++)h.set(m*s.length+b,k[b])}}return new Yn(v,h,a,o.length)}(e,e.values,e.indices,t,n):e.values instanceof bn?function(e,t,n,a,i){for(var r=O(e.getSparseShape()),s=[],o=[],u=1,c=0;c<a.length;c++)u<r?(u*=a[c],s.push(a[c])):o.push(a[c]);var h,l=u/r,p=e.nnz*l,f=t.reshape([p].concat(o),i);return h=!i&&M(s,e.getSparseShape())?n:new bn(n.wasmTensor.reshape_sparse_indices(new Uint32Array(e.getSparseShape()),new Uint32Array(a)),void 0,"uint32"),new Yn(f,h,a,o.length)}(e,e.values,e.indices,t,n):function(e,t,n,a,i){for(var r=O(e.getSparseShape()),s=[],o=[],u=1,c=0;c<a.length;c++)u<r?(u*=a[c],s.push(a[c])):o.push(a[c]);var h,l=u/r,p=e.nnz*l,f=t.reshape([p].concat(o),i);return h=!i&&M(s,e.getSparseShape())?n:qn.calc({A:n,sparseShape:e.getSparseShape(),shape:a,nnz:e.nnz},"uint32"),new Yn(f,h,a,o.length)}(e,e.values,e.indices,t,n)}var Zn=function(e,t,n,a){return new(n||(n=Promise))((function(i,r){function s(e){try{u(a.next(e))}catch(t){r(t)}}function o(e){try{u(a.throw(e))}catch(t){r(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}u((a=a.apply(e,t||[])).next())}))},Yn=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return Object(f.a)(this,n),(r=t.call(this,e.dtype)).values=e,r.indices=a,r.shape=i,r.denseDims=s,r.size=O(i),r.strides=j(i),r.nnz=r.indices.getShape()[0],r.sparseDims=r.shape.length-r.denseDims,r}return Object(d.a)(n,[{key:"getValues",value:function(){return Zn(this,void 0,void 0,c.a.mark((function e(){var t,n,a,i,r,s,o,u,h,l;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.values.getValues();case 2:return t=e.sent,e.next=5,this.indices.getValues();case 5:for(n=e.sent,a=O(this.getDenseShape(),1),i=j(this.getSparseShape()),r=new V[this.values.dtype](this.size),s=0;s<this.nnz;s++){for(o=[],u=0;u<this.sparseDims;u++)o.push(n[s*this.sparseDims+u]);for(h=S(o,i),l=0;l<a;l++)r[h*a+l]=t[s*a+l]}return e.abrupt("return",r);case 11:case"end":return e.stop()}}),e,this)})))}},{key:"getSparseShape",value:function(){return this.shape.slice(0,this.shape.length-this.denseDims)}},{key:"getDenseShape",value:function(){return this.shape.slice(this.shape.length-this.denseDims)}},{key:"getShape",value:function(){return this.shape}},{key:"constantLike",value:function(e){return new n(this.values.constantLike(e),this.indices.copy(),this.shape,this.denseDims)}},{key:"singleConstant",value:function(e){throw new Error("Method not implemented.")}},{key:"cast",value:function(e){return new n(this.values.cast(e),this.indices.copy(),this.shape,this.denseDims)}},{key:"delete",value:function(){this.values.delete(),this.indices.delete()}},{key:"reshape_impl",value:function(e,t){return Hn(this,e,t)}},{key:"exp",value:function(){return new n(this.values.exp(),this.indices.copy(),this.shape,this.denseDims)}},{key:"log",value:function(){return new n(this.values.log(),this.indices.copy(),this.shape,this.denseDims)}},{key:"sqrt",value:function(){return new n(this.values.sqrt(),this.indices.copy(),this.shape,this.denseDims)}},{key:"abs",value:function(){return new n(this.values.abs(),this.indices.copy(),this.shape,this.denseDims)}},{key:"sin",value:function(){return new n(this.values.sin(),this.indices.copy(),this.shape,this.denseDims)}},{key:"cos",value:function(){return new n(this.values.cos(),this.indices.copy(),this.shape,this.denseDims)}},{key:"tan",value:function(){return new n(this.values.tan(),this.indices.copy(),this.shape,this.denseDims)}},{key:"asin",value:function(){return new n(this.values.asin(),this.indices.copy(),this.shape,this.denseDims)}},{key:"acos",value:function(){return new n(this.values.acos(),this.indices.copy(),this.shape,this.denseDims)}},{key:"atan",value:function(){return new n(this.values.atan(),this.indices.copy(),this.shape,this.denseDims)}},{key:"sinh",value:function(){return new n(this.values.sinh(),this.indices.copy(),this.shape,this.denseDims)}},{key:"cosh",value:function(){return new n(this.values.cosh(),this.indices.copy(),this.shape,this.denseDims)}},{key:"tanh",value:function(){return new n(this.values.tanh(),this.indices.copy(),this.shape,this.denseDims)}},{key:"asinh",value:function(){return new n(this.values.asinh(),this.indices.copy(),this.shape,this.denseDims)}},{key:"acosh",value:function(){return new n(this.values.acosh(),this.indices.copy(),this.shape,this.denseDims)}},{key:"atanh",value:function(){return new n(this.values.atanh(),this.indices.copy(),this.shape,this.denseDims)}},{key:"negate",value:function(){return new n(this.values.negate(),this.indices.copy(),this.shape,this.denseDims)}},{key:"powerScalar",value:function(e,t){return new n(this.values.powerScalar(e,t),this.indices.copy(),this.shape,this.denseDims)}},{key:"sigmoid",value:function(){return new n(this.values.sigmoid(),this.indices.copy(),this.shape,this.denseDims)}},{key:"hardSigmoid",value:function(e,t){return new n(this.values.hardSigmoid(e,t),this.indices.copy(),this.shape,this.denseDims)}},{key:"sign",value:function(){return new n(this.values.sign(),this.indices.copy(),this.shape,this.denseDims)}},{key:"addMultiplyScalar",value:function(e,t){return new n(this.values.addMultiplyScalar(e,t),this.indices.copy(),this.shape,this.denseDims)}},{key:"matMul",value:function(e){return Bn(this,e)}},{key:"concat",value:function(e,t){if(!(e instanceof n))throw new Error("Can only concatenate sparse tensors!");return zn(this,e,t)}},{key:"clip",value:function(e,t){return new n(this.values.clip(e,t),this.indices.copy(),this.shape,this.denseDims)}},{key:"clipBackward",value:function(e,t,n){throw new Error("Method not implemented.")}},{key:"repeat",value:function(e){return Fn(this,e)}},{key:"expand",value:function(e){throw new Error("Method not implemented.")}},{key:"copy",value:function(){return new n(this.values.copy(),this.indices.copy(),this.shape,this.denseDims)}},{key:"gather",value:function(e,t){throw new Error("Method not implemented.")}},{key:"setValues",value:function(e,t){throw new Error("Method not implemented.")}},{key:"floor",value:function(){return new n(this.values.floor(),this.indices.copy(),this.shape,this.denseDims)}},{key:"ceil",value:function(){return new n(this.values.ceil(),this.indices.copy(),this.shape,this.denseDims)}},{key:"round",value:function(){return new n(this.values.round(),this.indices.copy(),this.shape,this.denseDims)}},{key:"upsample",value:function(e){throw new Error("Method not implemented.")}},{key:"normalize",value:function(e,t,n,a,i){throw new Error("Method not implemented.")}},{key:"add",value:function(e,t,a){return Object(w.a)(Object(k.a)(n.prototype),"add",this).call(this,e,t,a)}},{key:"subtract",value:function(e,t,a){return Object(w.a)(Object(k.a)(n.prototype),"subtract",this).call(this,e,t,a)}},{key:"multiply",value:function(e,t){return Object(w.a)(Object(k.a)(n.prototype),"multiply",this).call(this,e,t)}},{key:"divide",value:function(e,t){return Object(w.a)(Object(k.a)(n.prototype),"divide",this).call(this,e,t)}},{key:"add_impl",value:function(e,t,n,a,i){return _n(e,t,n,a,i)}},{key:"subtract_impl",value:function(e,t,n,a,i){return Rn(e,t,n,a,i)}},{key:"multiply_impl",value:function(e,t,n,a){return En(e,t,n,a)}},{key:"divide_impl",value:function(e,t,n,a){return Gn(e,t,n,a)}},{key:"power_impl",value:function(e,t,n){throw new Error("Method not implemented.")}},{key:"gemm_impl",value:function(e,t,n,a,i,r){throw new Error("Method not implemented.")}},{key:"sum",value:function(e,t){return Object(w.a)(Object(k.a)(n.prototype),"sum",this).call(this,e,t)}},{key:"sum_impl",value:function(e,t){return Vn(this,e,t)}},{key:"sumSquare_impl",value:function(e,t){return Dn(this,e,t)}},{key:"product_impl",value:function(e,t){return Sn(this,e,t)}},{key:"max_impl",value:function(e,t){return On(this,e,t)}},{key:"min_impl",value:function(e,t){return jn(this,e,t)}},{key:"reduceMean_impl",value:function(e,t){return In(this,e,t)}},{key:"reduceMeanSquare_impl",value:function(e,t){return Tn(this,e,t)}},{key:"reduceLogSum_impl",value:function(e,t){return An(this,e,t)}},{key:"reduceLogSumExp_impl",value:function(e,t){return Mn(this,e,t)}},{key:"conv_impl",value:function(e,t,n,a,i,r,s){throw new Error("Method not implemented.")}},{key:"convTranspose_impl",value:function(e,t,n,a,i){throw new Error("Method not implemented.")}},{key:"pad_impl",value:function(e,t,n){throw new Error("Method not implemented.")}},{key:"averagePool_impl",value:function(e,t,n,a){throw new Error("Method not implemented.")}},{key:"transpose_impl",value:function(e){throw new Error("Method not implemented.")}},{key:"slice_impl",value:function(e,t,n,a){throw new Error("Method not implemented.")}}],[{key:"fromDense",value:function(e){for(var t=0,a=[],i=[],r=0;r<e.size;r++)if(0!==e.get(r)){t++;for(var s=A(r,e.strides),o=0;o<e.shape.length;o++)a.push(s[o]);i.push(e.get(r))}var u=new B([t,e.shape.length],a,"uint32");return new n(new B([t],i,e.dtype),u,e.shape)}}]),n}(D),Jn=function(e,t,n,a){return new(n||(n=Promise))((function(i,r){function s(e){try{u(a.next(e))}catch(t){r(t)}}function o(e){try{u(a.throw(e))}catch(t){r(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}u((a=a.apply(e,t||[])).next())}))};function Kn(e){return Jn(this,void 0,void 0,c.a.mark((function t(){var n;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(e instanceof li)){t.next=17;break}return t.t0=li,t.next=4,Kn(e.value);case 4:if(t.t1=t.sent,void 0===e.grad){t.next=11;break}return t.next=8,Kn(e.grad);case 8:t.t2=t.sent,t.next=12;break;case 11:t.t2=void 0;case 12:return t.t3=t.t2,t.t4={grad:t.t3},t.abrupt("return",new t.t0(t.t1,t.t4));case 17:if(!(e instanceof Yn)){t.next=28;break}return t.t5=Yn,t.next=21,Kn(e.values);case 21:return t.t6=t.sent,t.next=24,Kn(e.indices);case 24:return t.t7=t.sent,t.t8=e.shape,t.t9=e.denseDims,t.abrupt("return",new t.t5(t.t6,t.t7,t.t8,t.t9));case 28:if(!(e instanceof B)){t.next=30;break}return t.abrupt("return",e);case 30:return t.next=32,e.getValues();case 32:return n=t.sent,t.abrupt("return",new B(e.getShape(),n,e.dtype));case 34:case"end":return t.stop()}}),t)})))}function Qn(e){return Jn(this,void 0,void 0,c.a.mark((function t(){var n;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("float16"!==e.dtype){t.next=2;break}throw new Error("Cant represent float16 tensor on Wasm backend");case 2:if(!(e instanceof li)){t.next=19;break}return t.t0=li,t.next=6,Qn(e.value);case 6:if(t.t1=t.sent,void 0===e.grad){t.next=13;break}return t.next=10,Qn(e.grad);case 10:t.t2=t.sent,t.next=14;break;case 13:t.t2=void 0;case 14:return t.t3=t.t2,t.t4={grad:t.t3},t.abrupt("return",new t.t0(t.t1,t.t4));case 19:if(!(e instanceof Yn)){t.next=30;break}return t.t5=Yn,t.next=23,Qn(e.values);case 23:return t.t6=t.sent,t.next=26,Qn(e.indices);case 26:return t.t7=t.sent,t.t8=e.shape,t.t9=e.denseDims,t.abrupt("return",new t.t5(t.t6,t.t7,t.t8,t.t9));case 30:if(!(e instanceof bn)){t.next=32;break}return t.abrupt("return",e);case 32:return t.next=34,e.getValues();case 34:if(n=t.sent,!(e instanceof B&&n instanceof Int32Array)){t.next=37;break}return t.abrupt("return",e);case 37:return t.abrupt("return",new bn(Array.from(n),new Uint32Array(e.getShape()),e.dtype));case 38:case"end":return t.stop()}}),t)})))}function $n(e){return Jn(this,void 0,void 0,c.a.mark((function t(){var n;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("float64"!==e.dtype){t.next=2;break}throw new Error("Cant represent float64 tensor on WebGL backend");case 2:if(!(e instanceof li)){t.next=19;break}return t.t0=li,t.next=6,$n(e.value);case 6:if(t.t1=t.sent,void 0===e.grad){t.next=13;break}return t.next=10,$n(e.grad);case 10:t.t2=t.sent,t.next=14;break;case 13:t.t2=void 0;case 14:return t.t3=t.t2,t.t4={grad:t.t3},t.abrupt("return",new t.t0(t.t1,t.t4));case 19:if(!(e instanceof Yn)){t.next=30;break}return t.t5=Yn,t.next=23,$n(e.values);case 23:return t.t6=t.sent,t.next=26,$n(e.indices);case 26:return t.t7=t.sent,t.t8=e.shape,t.t9=e.denseDims,t.abrupt("return",new t.t5(t.t6,t.t7,t.t8,t.t9));case 30:if(!(e instanceof ot)){t.next=32;break}return t.abrupt("return",e);case 32:return t.next=34,e.getValues();case 34:if(n=t.sent,!(e instanceof B&&n instanceof Int32Array)){t.next=37;break}return t.abrupt("return",e);case 37:return t.abrupt("return",new ot(Array.from(n),e.getShape(),e.dtype));case 38:case"end":return t.stop()}}),t)})))}var ea=n(32),ta=n.n(ea),na=(n(62),function(e,t,n,a){return new(n||(n=Promise))((function(i,r){function s(e){try{u(a.next(e))}catch(t){r(t)}}function o(e){try{u(a.throw(e))}catch(t){r(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}u((a=a.apply(e,t||[])).next())}))}),aa=function(){function e(){Object(f.a)(this,e),this.backend="CPU",this.mode="train"}return Object(d.a)(e,[{key:"getSubModules",value:function(){for(var t=[],n=0,a=Object.keys(this);n<a.length;n++){var i=a[n];this[i]instanceof e&&t.push(this[i])}return t}},{key:"getParameters",value:function(){for(var e=[],t=0,n=Object.keys(this);t<n.length;t++){var a=n[t];this[a]instanceof li&&e.push(this[a])}var i,r=this.getSubModules(),s=Object(b.a)(r);try{for(s.s();!(i=s.n()).done;){var o=i.value.getParameters();e=e.concat(o)}}catch(u){s.e(u)}finally{s.f()}return e}},{key:"toBackend",value:function(e){return"CPU"===e?this.toCPU():"WASM"===e?this.toWASM():this.toGPU()}},{key:"toCPU",value:function(){return na(this,void 0,void 0,c.a.mark((function e(){var t,n,a,i,r,s,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.getSubModules(),n=Object(b.a)(t),e.prev=2,n.s();case 4:if((a=n.n()).done){e.next=10;break}return i=a.value,e.next=8,i.toCPU();case 8:e.next=4;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),n.e(e.t0);case 15:return e.prev=15,n.f(),e.finish(15);case 18:r=0,s=Object.keys(this);case 19:if(!(r<s.length)){e.next=28;break}if(!(this[o=s[r]]instanceof D)){e.next=25;break}return e.next=24,Kn(this[o]);case 24:this[o]=e.sent;case 25:r++,e.next=19;break;case 28:this.backend="CPU";case 29:case"end":return e.stop()}}),e,this,[[2,12,15,18]])})))}},{key:"toWASM",value:function(){return na(this,void 0,void 0,c.a.mark((function e(){var t,n,a,i,r,s,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.getSubModules(),n=Object(b.a)(t),e.prev=2,n.s();case 4:if((a=n.n()).done){e.next=10;break}return i=a.value,e.next=8,i.toWASM();case 8:e.next=4;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),n.e(e.t0);case 15:return e.prev=15,n.f(),e.finish(15);case 18:r=0,s=Object.keys(this);case 19:if(!(r<s.length)){e.next=28;break}if(!(this[o=s[r]]instanceof D)){e.next=25;break}return e.next=24,Qn(this[o]);case 24:this[o]=e.sent;case 25:r++,e.next=19;break;case 28:this.backend="WASM";case 29:case"end":return e.stop()}}),e,this,[[2,12,15,18]])})))}},{key:"toGPU",value:function(){return na(this,void 0,void 0,c.a.mark((function e(){var t,n,a,i,r,s,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.getSubModules(),n=Object(b.a)(t),e.prev=2,n.s();case 4:if((a=n.n()).done){e.next=10;break}return i=a.value,e.next=8,i.toGPU();case 8:e.next=4;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),n.e(e.t0);case 15:return e.prev=15,n.f(),e.finish(15);case 18:r=0,s=Object.keys(this);case 19:if(!(r<s.length)){e.next=28;break}if(!(this[o=s[r]]instanceof D)){e.next=25;break}return e.next=24,$n(this[o]);case 24:this[o]=e.sent;case 25:r++,e.next=19;break;case 28:this.backend="GPU";case 29:case"end":return e.stop()}}),e,this,[[2,12,15,18]])})))}}]),e}(),ia=function(e,t,n,a){return new(n||(n=Promise))((function(i,r){function s(e){try{u(a.next(e))}catch(t){r(t)}}function o(e){try{u(a.throw(e))}catch(t){r(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}u((a=a.apply(e,t||[])).next())}))},ra=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i,r,s,o){var u;Object(f.a)(this,n),(u=t.call(this)).attributes={},u.mode=o;for(var c=0;c<e.length;c++)u.attributes[e[c].name]=e[c];u.inputs=a,u.outputs=i,u.onnxVersion=s,u.variableInputs=0;for(var h=0;h<u.inputs.length;h++)void 0===r[u.inputs[h]]&&u.variableInputs++;return u}return Object(d.a)(n,[{key:"initialize",value:function(e){}},{key:"getAttribute",value:function(e){return this.attributes[e]}},{key:"getAttributeString",value:function(e){var t=this.attributes[e];if(void 0!==t){var n=t.s;return void 0!==n&&null!==n?new TextDecoder("utf-8").decode(n):void 0}}},{key:"getAttributeInts",value:function(e){if(void 0!==this.attributes[e]){var t=this.attributes[e].ints;if(void 0!==t&&null!==t){for(var n=0;n<t.length;n++)ta.a.isLong(t[n])&&(t[n]=t[n].toNumber());return t}}}},{key:"getAttributeInt",value:function(e){var t=this.attributes[e];if(void 0!==t){var n=t.i;return ta.a.isLong(n)&&(n=n.toNumber()),n}}},{key:"getAttributeFloat",value:function(e){var t=this.attributes[e];if(void 0!==t)return t.f}},{key:"getAttributeFloats",value:function(e){var t=this.attributes[e];if(void 0!==t)return t.floats}},{key:"getAttributeTensor",value:function(e){var t=this.attributes[e];if(void 0!==t)return t.t}},{key:"toValues",value:function(e){return ia(this,void 0,void 0,c.a.mark((function t(){var n,a,i;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e instanceof B){t.next=5;break}return console.warn("Tensor for values not on CPU, need to transfer!"),t.next=4,Kn(e);case 4:e=t.sent;case 5:for(n=e,a=new Array(n.size),i=0;i<n.size;i++)a[i]=n.get(i);return t.abrupt("return",a);case 9:case"end":return t.stop()}}),t)})))}},{key:"toCPU",value:function(){return ia(this,void 0,void 0,c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))}},{key:"toWASM",value:function(){return ia(this,void 0,void 0,c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))}},{key:"toGPU",value:function(){return ia(this,void 0,void 0,c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))}}]),n}(aa);var sa=function(e,t,n,a){return new(n||(n=Promise))((function(i,r){function s(e){try{u(a.next(e))}catch(t){r(t)}}function o(e){try{u(a.throw(e))}catch(t){r(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}u((a=a.apply(e,t||[])).next())}))},oa=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i,r,s,o,u,c,h){var l;if(Object(f.a)(this,n),void 0!==(l=t.call(this,e,a,i,r,s,o)).getAttributeString("autoPad"))throw new Error("Autopad in conv not supported yet");return void 0===h&&(h="id"),l.activation=h,l.group=l.getAttributeInt("group")||1,l.dilations=l.getAttributeInts("dilations"),l.pads=l.getAttributeInts("pads"),l.strides=l.getAttributeInts("strides"),l.kernel=u,l.bias=c,"train"===o&&void 0!==l.kernel&&(l.kernel=new li(l.kernel)),"train"===o&&void 0!==l.bias&&(l.bias=new li(l.bias)),l}return Object(d.a)(n,[{key:"forward",value:function(e){return sa(this,void 0,void 0,c.a.mark((function t(){var n,a,i;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e[0],a=void 0!==this.kernel?this.kernel:e[1],i=e.length>2?e[2]:this.bias,t.abrupt("return",[n.conv(a,i,this.dilations,this.group,this.pads,this.strides,this.activation)]);case 4:case"end":return t.stop()}}),t,this)})))}},{key:"getDilations",value:function(e){return void 0!==this.dilations?this.dilations:new Array(e).fill(1)}},{key:"getPads",value:function(e){return void 0!==this.pads?this.pads:new Array(2*e).fill(0)}},{key:"getStrides",value:function(e){return void 0!==this.strides?this.strides:new Array(e).fill(1)}},{key:"getType",value:function(){return"Conv"}},{key:"toCPU",value:function(){return sa(this,void 0,void 0,c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===this.kernel){e.next=4;break}return e.next=3,Kn(this.kernel);case 3:this.kernel=e.sent;case 4:if(void 0===this.bias){e.next=8;break}return e.next=7,Kn(this.bias);case 7:this.bias=e.sent;case 8:case"end":return e.stop()}}),e,this)})))}},{key:"toWASM",value:function(){return sa(this,void 0,void 0,c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===this.kernel){e.next=4;break}return e.next=3,Qn(this.kernel);case 3:this.kernel=e.sent;case 4:if(void 0===this.bias){e.next=8;break}return e.next=7,Qn(this.bias);case 7:this.bias=e.sent;case 8:case"end":return e.stop()}}),e,this)})))}},{key:"toGPU",value:function(){return sa(this,void 0,void 0,c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===this.kernel){e.next=4;break}return e.next=3,$n(this.kernel);case 3:this.kernel=e.sent;case 4:if(void 0===this.bias){e.next=8;break}return e.next=7,$n(this.bias);case 7:this.bias=e.sent;case 8:case"end":return e.stop()}}),e,this)})))}},{key:"delete",value:function(){void 0!==this.kernel&&this.kernel.delete(),void 0!==this.bias&&this.bias.delete()}}]),n}(ra),ua=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e){var a;return Object(f.a)(this,n),(a=t.call(this)).nodeTypes=e,a}return Object(d.a)(n,[{key:"findApplications",value:function(e){var t=[],n=e.getNodes();for(var a in Object.keys(n)){var i=n[a];if(void 0!==i&&i.getType()===this.nodeTypes[0]){var r=this.checkApplication(e,a);void 0!==r&&t.push(r)}}return t}},{key:"checkApplication",value:function(e,t){for(var n=e.getNodes(),a=[t],i=n[t],r=[i],s=1;s<this.nodeTypes.length;s++){var o=e.getNodeWithInput(i.outputs[0]);if(void 0===o)return;var u=n[o];if(u.getType()!==this.nodeTypes[s])return;a.push(o),i=u,r.push(i)}return this.canApply(r)?a:void 0}},{key:"canApply",value:function(e){return!0}}]),n}((function e(){Object(f.a)(this,e)})),ca=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.call(this,["Conv","BatchNormalization"])}return Object(d.a)(n,[{key:"apply",value:function(e,t,n,a){var i=e[0],r=e[1],s=t(i.inputs[1]),o=t(i.inputs[2]),u=t(r.inputs[1]),c=t(r.inputs[2]),l=t(r.inputs[3]),p=t(r.inputs[4]).add(r.epsTensor).sqrt(),f=u.divide(p);p.delete();var d=c.subtract(l.multiply(f)),v=[].concat(Object(h.a)(f.getShape()),Object(h.a)(new Array(s.getShape().length-f.getShape().length).fill(1))),m=s.multiply(f.reshape(v,!1)),y=d;if(void 0!==o){var g=o.multiply(f);y=y.add(g),g.delete()}return new oa(Object.entries(i.attributes).map((function(e){return e[1]})),[i.inputs[0]],r.outputs,n,a,i.mode,m,y)}}]),n}(ua),ha=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.call(this,["Conv","Relu"])}return Object(d.a)(n,[{key:"apply",value:function(e,t,n,a){var i=e[0],r=e[1];return new oa(Object.entries(i.attributes).map((function(e){return e[1]})),i.inputs,r.outputs,n,a,i.mode,i.kernel,i.bias,"relu")}}]),n}(ua),la=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.call(this,["Conv","Clip"])}return Object(d.a)(n,[{key:"apply",value:function(e,t,n,a){var i=e[0],r=e[1];return new oa(Object.entries(i.attributes).map((function(e){return e[1]})),i.inputs,r.outputs,n,a,i.mode,i.kernel,i.bias,"relu6")}},{key:"canApply",value:function(e){var t=e[1];return 0===t.min&&6===t.max}}]),n}(ua),pa=(new ca,new ha,new la,function(){function e(t){Object(f.a)(this,e),this.model=t,this.parameters=t.getParameters()}return Object(d.a)(e,[{key:"zeroGrads",value:function(){var e,t=Object(b.a)(this.parameters);try{for(t.s();!(e=t.n()).done;){var n=e.value;void 0!==n.grad&&(n.grad.delete(),n.grad=void 0)}}catch(a){t.e(a)}finally{t.f()}}}]),e}()),fa=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,e,a,i)).maxIterations=1e6,r}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("beta1")," float beta1;\n    ").concat(this.getVarModifier("beta2")," float beta2;\n    ").concat(this.getVarModifier("t")," int t;\n    ")}},{key:"getFragmentShader",value:function(e){return"\n    void main() {\n      initVars();\n\n      int pos = coordinateToPos(uv, widthOutput, heightOutput);\n\n      float m1 = getValueAtPos(pos, widthMoments, heightMoments, Moments);\n      float m2 = getValueAtPos(pos+2, widthMoments, heightMoments, Moments);\n      float grad = getValueAtPos(pos/4, widthGrad, heightGrad, Grad);\n\n      m1 = beta1*m1 + (1.0-beta1)*grad;\n      m2 = beta2*m2 + (1.0-beta2)*grad*grad;\n\n      float m1Corr = m1/(1.0-pow(beta1, float(t)));\n      float m2Corr = m2/(1.0-pow(beta2, float(t)));\n\n      gl_FragColor = vec4(m1,m1Corr,m2,m2Corr);\n    }\n    "}},{key:"getTextureNames",value:function(){return["Grad","Moments"]}},{key:"getUniformAttrs",value:function(){return[{name:"beta1",type:"float"},{name:"beta2",type:"float"},{name:"t",type:"int"}]}},{key:"calc",value:function(e){return this.compute(e.Moments.shape,{Grad:e.Grad,Moments:e.Moments},{beta1:e.beta1,beta2:e.beta2,t:e.t})}},{key:"getOutputShape",value:function(e){return e.Moments.shape}},{key:"compile",value:function(e){void 0!==e.shapeMoments&&(this.maxRank=e.shapeMoments.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeGrad:e.Grad.shape,widthGrad:e.Grad.memory.width,heightGrad:e.Grad.memory.height,shapeMoments:e.Moments.shape,widthMoments:e.Moments.memory.width,heightMoments:e.Moments.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,beta1:e.beta1,beta2:e.beta2}}},{key:"getInputInfoString",value:function(e){return"".concat(e.Grad.shape,"-").concat(e.Moments.shape,"-").concat(e.beta1,"-").concat(e.beta2)}}]),n}(ee),da=new Ue((function(e){return new fa(ut,e)})),va=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;return Object(f.a)(this,n),(r=t.call(this,e,a,i)).maxIterations=1e6,r}return Object(d.a)(n,[{key:"getVariables",value:function(){return"\n    ".concat(this.getVarModifier("alpha")," float alpha;\n    ").concat(this.getVarModifier("epsilon")," float epsilon;\n    ")}},{key:"getFragmentShader",value:function(e){return"\n    float newVal(float m1Corr, float m2Corr, float value) {\n      return value - alpha*(m1Corr/(sqrt(m2Corr)+epsilon));\n    }\n\n    void main() {\n      initVars();\n\n      int pos = coordinateToPos(uv, widthOutput, heightOutput);\n\n      vec4 result = vec4(0,0,0,0);\n\n      float m1Corr = getValueAtPos(pos*4+1, widthMoments, heightMoments, Moments);\n      float m2Corr = getValueAtPos(pos*4+3, widthMoments, heightMoments, Moments);\n      float value = getValueAtPos(pos, widthValue, heightValue, Value);\n      result.r = newVal(m1Corr, m2Corr, value);\n\n      pos++;\n      m1Corr = getValueAtPos(pos*4+1, widthMoments, heightMoments, Moments);\n      m2Corr = getValueAtPos(pos*4+3, widthMoments, heightMoments, Moments);\n      value = getValueAtPos(pos, widthValue, heightValue, Value);\n      result.g = newVal(m1Corr, m2Corr, value);\n\n      pos++;\n      m1Corr = getValueAtPos(pos*4+1, widthMoments, heightMoments, Moments);\n      m2Corr = getValueAtPos(pos*4+3, widthMoments, heightMoments, Moments);\n      value = getValueAtPos(pos, widthValue, heightValue, Value);\n      result.b = newVal(m1Corr, m2Corr, value);\n\n      pos++;\n      m1Corr = getValueAtPos(pos*4+1, widthMoments, heightMoments, Moments);\n      m2Corr = getValueAtPos(pos*4+3, widthMoments, heightMoments, Moments);\n      value = getValueAtPos(pos, widthValue, heightValue, Value);\n      result.a = newVal(m1Corr, m2Corr, value);\n\n\n      gl_FragColor = result;\n    }\n    "}},{key:"getTextureNames",value:function(){return["Value","Moments"]}},{key:"getUniformAttrs",value:function(){return[{name:"alpha",type:"float"},{name:"epsilon",type:"float"}]}},{key:"calc",value:function(e){return this.compute(e.Value.shape,{Value:e.Value,Moments:e.Moments},{alpha:e.alpha,epsilon:e.epsilon})}},{key:"getOutputShape",value:function(e){return e.Value.shape}},{key:"compile",value:function(e){void 0!==e.shapeMoments&&(this.maxRank=e.shapeMoments.length),Object(w.a)(Object(k.a)(n.prototype),"compile",this).call(this,e)}},{key:"getCompilationInfo",value:function(e){var t=this.getOutputShape(e),n=J.getAllocationDimensions(O(t),this.dtype);return{shapeValue:e.Value.shape,widthValue:e.Value.memory.width,heightValue:e.Value.memory.height,shapeMoments:e.Moments.shape,widthMoments:e.Moments.memory.width,heightMoments:e.Moments.memory.height,shapeOutput:t,widthOutput:n.width,heightOutput:n.height,alpha:e.alpha,epsilon:e.epsilon}}},{key:"getInputInfoString",value:function(e){return"".concat(e.Value.shape,"-").concat(e.Moments.shape,"-").concat(e.alpha,"-").concat(e.epsilon)}}]),n}(ee),ma=new Ue((function(e){return new va(ut,e)})),ya=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e){var a,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.001,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.9,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.999,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e-7;Object(f.a)(this,n),(a=t.call(this,e)).lr=i,a.beta1=r,a.beta2=s,a.epsilon=o,a.t=0;var u=a.parameters;if(u[0].value instanceof ot){a.moments=new Array(u.length);for(var c=0;c<u.length;c++)a.moments[c]=new ot(new Array(4*u[c].value.size).fill(0),[].concat(Object(h.a)(u[c].getShape()),[4]),u[c].value.dtype)}else a.moment1=new Array(u.length).fill(void 0),a.moment2=new Array(u.length).fill(void 0);return a}return Object(d.a)(n,[{key:"step",value:function(){if(this.t++,void 0!==this.moment1&&void 0!==this.moment2)for(var e=0;e<this.parameters.length;e++){var t=this.parameters[e];if(void 0!==t.grad){var n=t.value,a=this.paramStep(t.value,t.grad,this.moment1[e],this.moment2[e]),i=a.newValue,r=a.moment1,s=a.moment2;t.value=i,this.moment1[e]=r,this.moment2[e]=s,n.delete()}}else if(void 0!==this.moments)for(var o=0;o<this.parameters.length;o++){var u=this.parameters[o];if(void 0!==u.grad){var c=u.value,h=this.gpuParamStep(u.value,u.grad,this.moments[o]),l=h.newValue,p=h.moments;u.value=l,this.moments[o]=p,c.delete()}}}},{key:"updateMoments",value:function(e,t,n){var a,i;if(void 0===t)a=e.multiplyScalar(1-this.beta1);else{var r=t;a=t.add(e,this.beta1,1-this.beta1),r.delete()}if(void 0===n)i=e.multiply(e,1-this.beta2);else{var s=e.multiply(e),o=n;i=n.add(s,this.beta2,1-this.beta2),s.delete(),o.delete()}return{moment1New:a,moment2New:i}}},{key:"getCorrectedMoments",value:function(e,t){return{correctMoment1:e.addMultiplyScalar(1/(1-Math.pow(this.beta1,this.t)),0),correctMoment2:t.addMultiplyScalar(1/(1-Math.pow(this.beta2,this.t)),0)}}},{key:"paramStep",value:function(e,t,n,a){var i=this.updateMoments(t,n,a),r=i.moment1New,s=i.moment2New.addMultiplyScalar(1/(1-Math.pow(this.beta2,this.t)),this.epsilon),o=s.sqrt();s.delete();var u=r.divide(o,-this.lr/(1-Math.pow(this.beta1,this.t)));o.delete();var c=e.add(u);return u.delete(),{newValue:c,moment1:n,moment2:a}}},{key:"gpuParamStep",value:function(e,t,n){var a=da.calc({Grad:t,Moments:n,beta1:this.beta1,beta2:this.beta2,t:this.t},e.dtype);return n.delete(),{newValue:ma.calc({Value:e,Moments:a,alpha:this.lr,epsilon:this.epsilon},e.dtype),moments:a}}}]),n}(pa),ga=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e){var a,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.001;return Object(f.a)(this,n),(a=t.call(this,e)).lr=i,a}return Object(d.a)(n,[{key:"step",value:function(){var e,t=Object(b.a)(this.parameters);try{for(t.s();!(e=t.n()).done;){var n=e.value;if(void 0!==n.grad){var a=n.value;n.value=n.value.subtract(n.grad,1,this.lr),a.delete()}}}catch(i){t.e(i)}finally{t.f()}}}]),n}(pa);var wa=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getOp",value:function(e,t){return"".concat(t," == 1.0 ? -1.0/").concat(e," : 1.0/(1.0-").concat(e,")")}}]),n}(oe);new Ue((function(e){return new wa(ut,e)}));var ka=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){return Object(f.a)(this,n),t.call(this,e,a,i)}return Object(d.a)(n,[{key:"getOp",value:function(e,t){return"".concat(t," == 1.0 ? -log(").concat(e,") : -log(1.0-").concat(e,")")}}]),n}(oe);new Ue((function(e){return new ka(ut,e)}));var ba=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.sign(),n=e.multiply(t);t.delete(),this.input.backward(n)||n.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),xa=function(){function e(t,n){Object(f.a)(this,e),this.input=t,this.exp=n}return Object(d.a)(e,[{key:"backward",value:function(e){var t=e.multiply(this.exp);this.input.backward(t)||t.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Oa=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=e.divide(this.input.value);this.input.backward(t)||t.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),ja=function(){function e(t,n){Object(f.a)(this,e),this.a=t,this.b=n}return Object(d.a)(e,[{key:"backward",value:function(e){if(!this.b.noGrad){var t=this.a.value.gemm(e,!0,!1);this.b.backward(t)||t.delete()}if(!this.a.noGrad){var n=e.gemm(this.b.value,!1,!0);this.a.backward(n)||n.delete()}}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete(),this.b.isLeaf()||this.b.delete()}}]),e}(),Sa=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=e.negate();this.input.backward(t)||t.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Aa=function(){function e(t,n){Object(f.a)(this,e),this.input=t,this.sqrt=n}return Object(d.a)(e,[{key:"backward",value:function(e){var t=e.divide(this.sqrt,.5);this.input.backward(t)||t.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Ma=function(){function e(t,n,a){Object(f.a)(this,e),this.a=t,this.b=n,this.axis=a}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.axis;if(t<0&&(t+=this.a.getShape().length),!this.a.noGrad){var n=e.slice([0],[this.a.getShape()[t]],[t]);this.a.backward(n)||n.delete()}if(!this.b.noGrad){var a=e.slice([this.a.getShape()[t]],[e.getShape()[t]],[t]);this.b.backward(a)||a.delete()}}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete(),this.b.isLeaf()||this.b.delete()}}]),e}(),Ia=function(){function e(t,n,a){Object(f.a)(this,e),this.input=t,this.min=n,this.max=a}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.clipBackward(e,this.min,this.max);this.input.backward(t)||t.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Ta=function(){function e(t,n){Object(f.a)(this,e),this.a=t,this.repeats=n}return Object(d.a)(e,[{key:"backward",value:function(e){for(var t=this.a.getShape(),n=[],a=[],i=0;i<t.length;i++)n.push(this.repeats[i],t[i]),a.push(2*i);var r=e.reshape(n,!1).sum(a,!1);this.a.backward(r)||r.delete()}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete()}}]),e}(),Va=function(){function e(t,n){Object(f.a)(this,e),this.a=t,this.shape=n}return Object(d.a)(e,[{key:"backward",value:function(e){for(var t=this.a.value.alignShapes(this.a.getShape(),this.shape),n=Object(x.a)(t,3),a=n[0],i=n[1],r=(n[2],[]),s=0;s<a.length;s++)a[s]<i[s]&&r.push(s);var o=e.sum(r).reshape(this.a.getShape());this.a.backward(o)||o.delete()}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete()}}]),e}(),Da=function(){function e(t){Object(f.a)(this,e),this.a=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.a.getShape();if(!this.a.noGrad){var n=e.reshape(t);this.a.backward(n)||n.delete()}}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete()}}]),e}(),Xa=function(){function e(t,n,a,i,r){Object(f.a)(this,e),this.a=t,this.b=n,this.shape=a,this.alpha=i,this.beta=r}return Object(d.a)(e,[{key:"backward",value:function(e){for(var t=this.a.getShape(),n=this.b.getShape(),a=[],i=[],r=0;r<this.shape.length;r++)t[r]<this.shape[r]&&a.push(r),n[r]<this.shape[r]&&i.push(r);if(!this.a.noGrad){var s;if(0===a.length)s=1===this.alpha?e.reshape(t):e.multiplyScalar(this.alpha).reshape(t,!1);else if(1===this.alpha)s=e.sum(a).reshape(t,!1);else{var o=e.sum(a),u=o.multiplyScalar(this.alpha);o.delete(),s=u.reshape(t,!1)}this.a.backward(s)||s.delete()}if(!this.b.noGrad){var c;if(0===i.length)c=1===this.beta?e.reshape(n):e.multiplyScalar(this.beta).reshape(n,!1);else if(1===this.beta)c=e.sum(i).reshape(n,!1);else{var h=e.sum(i),l=h.multiplyScalar(this.beta);h.delete(),c=l.reshape(n,!1)}this.b.backward(c)||c.delete()}}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete(),this.b.isLeaf()||this.b.delete()}}]),e}(),Ca=function(){function e(t,n,a,i,r){Object(f.a)(this,e),this.a=t,this.b=n,this.shape=a,this.alpha=i,this.beta=r}return Object(d.a)(e,[{key:"backward",value:function(e){for(var t=this.a.getShape(),n=this.b.getShape(),a=[],i=[],r=0;r<this.shape.length;r++)t[r]<this.shape[r]&&a.push(r),n[r]<this.shape[r]&&i.push(r);if(!this.a.noGrad){var s;if(0===a.length)s=1===this.alpha?e.reshape(t):e.multiplyScalar(this.alpha).reshape(t,!1);else if(1===this.alpha)s=e.sum(a).reshape(t,!1);else{var o=e.sum(a),u=o.multiplyScalar(this.alpha);o.delete(),s=u.reshape(t,!1)}this.a.backward(s)||s.delete()}if(!this.b.noGrad){var c;if(0===i.length)c=e.multiplyScalar(-this.beta).reshape(n,!1);else{var h=e.sum(i),l=h.multiplyScalar(-this.beta);h.delete(),c=l.reshape(n,!1)}this.b.backward(c)||c.delete()}}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete(),this.b.isLeaf()||this.b.delete()}}]),e}(),_a=function(){function e(t,n,a,i){Object(f.a)(this,e),this.a=t,this.b=n,this.shape=a,this.alpha=i}return Object(d.a)(e,[{key:"backward",value:function(e){for(var t=this.a.getShape(),n=this.b.getShape(),a=[],i=[],r=0;r<this.shape.length;r++)t[r]<this.shape[r]&&a.push(r),n[r]<this.shape[r]&&i.push(r);if(!this.a.noGrad){var s;if(0===a.length)s=e.multiply(this.b.value,this.alpha).reshape(t,!1);else{var o=e.multiply(this.b.value,this.alpha),u=o.sum(a);o.delete(),s=u.reshape(t,!1)}this.a.backward(s)||s.delete()}if(!this.b.noGrad){var c;if(0===i.length)c=e.multiply(this.a.value,this.alpha).reshape(n,!1);else{var h=e.multiply(this.a.value,this.alpha),l=h.sum(i);h.delete(),c=l.reshape(n,!1)}this.b.backward(c)||c.delete()}}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete(),this.b.isLeaf()||this.b.delete()}}]),e}(),Ga=function(){function e(t,n,a,i,r,s,o){Object(f.a)(this,e),this.x=t,this.w=n,this.strides=a,this.padding=i,this.dilations=r,this.group=s,this.b=o}return Object(d.a)(e,[{key:"backward",value:function(e){if(!this.w.noGrad){var t=this.x.value.conv(e,void 0,this.strides,this.group,this.padding,this.dilations);this.w.backward(t)||t.delete()}if(void 0!==this.b&&!this.b.noGrad){for(var n=[0],a=0;a<this.dilations.length;a++)n.push(a+2);var i=e.sum(n);this.b.backward(i)||i.delete()}if(!this.x.noGrad){for(var r=this.w.getShape(),s=[],o=0;o<this.dilations.length;o++)s.push(r[o+2]-this.padding[o]+this.dilations[o]-2);s=[].concat(Object(h.a)(s),Object(h.a)(s));var u=e.convTranspose(this.w.value,this.dilations,this.group,s,this.strides);this.x.backward(u)||u.delete()}}},{key:"delete",value:function(){this.x.isLeaf()||this.x.delete(),this.w.isLeaf()||this.w.delete(),void 0===this.b||this.b.isLeaf()||this.b.delete()}}]),e}(),Ea=function(){function e(t,n,a,i,r){Object(f.a)(this,e),this.a=t,this.b=n,this.divResult=a,this.shape=i,this.alpha=r}return Object(d.a)(e,[{key:"backward",value:function(e){for(var t=this.a.getShape(),n=this.b.getShape(),a=[],i=[],r=0;r<this.shape.length;r++)t[r]<this.shape[r]&&a.push(r),n[r]<this.shape[r]&&i.push(r);if(!this.a.noGrad){var s;if(0===a.length)s=e.divide(this.b.value,this.alpha).reshape(t,!1);else{var o=e.divide(this.b.value,this.alpha),u=o.sum(a);o.delete(),s=u.reshape(t,!1)}this.a.backward(s)||s.delete()}if(!this.b.noGrad){var c;if(0===i.length){var h=e.multiply(this.divResult),l=h.divide(this.b.value,-this.alpha);h.delete(),c=l.reshape(n,!1)}else{var p=e.multiply(this.divResult),f=p.divide(this.b.value,-this.alpha);p.delete();var d=f.sum(i);f.delete(),c=d.reshape(n,!1)}this.b.backward(c)||c.delete()}}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete(),this.b.isLeaf()||this.b.delete()}}]),e}(),Ra=function(){function e(t,n,a,i){Object(f.a)(this,e),this.a=t,this.b=n,this.powerResult=a,this.shape=i}return Object(d.a)(e,[{key:"backward",value:function(e){for(var t=this.a.getShape(),n=this.b.getShape(),a=[],i=[],r=0;r<this.shape.length;r++)t[r]<this.shape[r]&&a.push(r),n[r]<this.shape[r]&&i.push(r);if(!this.a.noGrad){var s;if(0===a.length){var o=this.powerResult.multiply(this.b.value),u=o.divide(this.a.value);o.delete();var c=e.multiply(u);u.delete(),s=c.reshape(t,!1)}else{var h=this.powerResult.multiply(this.b.value),l=h.divide(this.a.value);h.delete();var p=e.multiply(l);l.delete();var f=p.sum(a);p.delete(),s=f.reshape(t,!1)}this.a.backward(s)||s.delete()}if(!this.b.noGrad){var d;if(0===i.length){var v=this.a.value.log(),m=this.powerResult.multiply(v);v.delete(),d=e.multiply(m),m.delete(),d=d.reshape(n,!1)}else{var y=this.a.value.log(),g=this.powerResult.multiply(y);y.delete();var w=e.multiply(g);g.delete();var k=w.sum(i);w.delete(),d=k.reshape(n,!1)}this.b.backward(d)||d.delete()}}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete(),this.b.isLeaf()||this.b.delete()}}]),e}(),Pa=function(){function e(t,n,a,i,r,s,o){Object(f.a)(this,e),this.a=t,this.b=n,this.transA=a,this.transB=i,this.alpha=r,this.beta=s,this.c=o}return Object(d.a)(e,[{key:"backward",value:function(e){var t,n;this.b.noGrad||(t=this.transB?e.gemm(this.a.value,!0,this.transA,this.alpha):this.a.value.gemm(e,!this.transA,!1,this.alpha),this.b.backward(t)||t.delete());this.a.noGrad||(n=this.transA?this.b.value.gemm(e,this.transB,!0,this.alpha):e.gemm(this.b.value,!1,!this.transB,this.alpha),this.a.backward(n)||n.delete());if(void 0!==this.c&&!this.c.noGrad){for(var a=e.getShape(),i=this.c.getShape(),r=[],s=0;s<a.length;s++)i[s]<a[s]&&r.push(s);var o=e.sum(r).reshape(i,!1);if(1!==this.beta){var u=o;o=o.multiplyScalar(this.beta),u.delete()}this.c.backward(o)||o.delete()}}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete(),this.b.isLeaf()||this.b.delete(),void 0===this.c||this.c.isLeaf()||this.c.delete()}}]),e}(),Ua=function(){function e(t,n){Object(f.a)(this,e),this.a=t,this.permutation=n}return Object(d.a)(e,[{key:"backward",value:function(e){for(var t=new Array(this.permutation.length),n=0;n<this.permutation.length;n++)t[this.permutation[n]]=n;var a=e.transpose(t);this.a.backward(a)||a.delete()}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete()}}]),e}(),za=function(){function e(t,n,a){Object(f.a)(this,e),this.input=t,this.sumDims=n,this.keepDims=a}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.getShape();if(!this.keepDims){for(var n=[],a=0,i=0;i<t.length;i++)a<this.sumDims.length&&this.sumDims[a]===i?(n.push(1),a++):n.push(t[i]);e=e.reshape(n,!1)}e=e.expand(t),this.input.backward(e)||e.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Ba=function(){function e(t,n,a){Object(f.a)(this,e),this.input=t,this.sumDims=n,this.keepDims=a}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.getShape();if(!this.keepDims){for(var n=[],a=0,i=0;i<t.length;i++)a<this.sumDims.length&&this.sumDims[a]===i?(n.push(1),a++):n.push(t[i]);e=e.reshape(n,!1)}var r=e.expand(t),s=r.multiply(this.input.value,2);r.delete(),this.input.backward(s)||s.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Wa=function(){function e(t,n){Object(f.a)(this,e),this.input=t,this.scalar=n}return Object(d.a)(e,[{key:"backward",value:function(e){var t=e.multiplyScalar(this.scalar);this.input.backward(t)||t.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),La=function(){function e(t,n,a){Object(f.a)(this,e),this.input=t,this.sumDims=n,this.keepDims=a}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.getShape();if(!this.keepDims){for(var n=[],a=0,i=0;i<t.length;i++)a<this.sumDims.length&&this.sumDims[a]===i?(n.push(1),a++):n.push(t[i]);e=e.reshape(n,!1)}for(var r=1,s=0;s<this.sumDims.length;s++)r*=t[this.sumDims[s]];var o=e.multiplyScalar(1/r),u=o.expand(t);o.delete,this.input.backward(u)||e.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Fa=function(){function e(t,n,a){Object(f.a)(this,e),this.input=t,this.sumDims=n,this.keepDims=a}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.getShape();if(!this.keepDims){for(var n=[],a=0,i=0;i<t.length;i++)a<this.sumDims.length&&this.sumDims[a]===i?(n.push(1),a++):n.push(t[i]);e=e.reshape(n,!1)}for(var r=1,s=0;s<this.sumDims.length;s++)r*=t[this.sumDims[s]];var o=e.expand(t),u=o.multiply(this.input.value,2/r);o.delete(),this.input.backward(u)||u.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Na=function(){function e(t,n,a,i,r){if(Object(f.a)(this,e),this.a=t,this.starts=n,this.ends=a,this.axes=i,this.steps=r,void 0!==r.find((function(e){return 1!==e})))throw new Error("Slice backward pass only supports step size of 1")}return Object(d.a)(e,[{key:"backward",value:function(e){if(!this.a.noGrad){for(var t=this.a.getShape(),n=t.length,a=new Array(2*n).fill(0),i=0;i<this.axes.length;i++)a[this.axes[i]]=this.starts[i],a[n+this.axes[i]]=t[this.axes[i]]-this.ends[i];var r=e.pad(a,"constant",0);this.a.backward(r)||r.delete()}}},{key:"delete",value:function(){this.a.isLeaf()||this.a.delete()}}]),e}(),qa=function(){function e(t,n,a,i,r){Object(f.a)(this,e),this.x=t}return Object(d.a)(e,[{key:"backward",value:function(e){throw new Error("Backward pass not implemented for average pool")}},{key:"delete",value:function(){this.x.isLeaf()||this.x.delete()}}]),e}(),Ha=function(){function e(t,n,a,i){Object(f.a)(this,e),this.x=t,this.pads=n,this.mode=a,this.value=i}return Object(d.a)(e,[{key:"backward",value:function(e){throw new Error("Backward pass not implemented for pad")}},{key:"delete",value:function(){this.x.isLeaf()||this.x.delete()}}]),e}(),Za=function(){function e(t,n,a,i){Object(f.a)(this,e),this.input=t,this.product=n,this.sumDims=a,this.keepDims=i}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.getShape(),n=e.multiply(this.product);if(!this.keepDims){for(var a=[],i=0,r=0;r<t.length;r++)i<this.sumDims.length&&this.sumDims[i]===r?(a.push(1),i++):a.push(t[r]);n=n.reshape(a,!1)}var s=n.expand(t);n.delete();var o=s.divide(this.input.value);s.delete(),this.input.backward(o)||o.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Ya=function(){function e(t,n){Object(f.a)(this,e),this.input=t,this.sigmoid=n}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.sigmoid.addMultiplyScalar(-1,1),n=this.sigmoid.multiply(t);t.delete();var a=n.multiply(e);n.delete(),this.input.backward(a)||a.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Ja=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.cos(),n=e.multiply(t);t.delete(),this.input.backward(n)||n.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Ka=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.multiply(this.input.value),n=t.addMultiplyScalar(-1,1);t.delete();var a=n.sqrt();n.delete();var i=e.divide(a);a.delete(),this.input.backward(i)||i.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),Qa=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.cosh(),n=e.multiply(t);t.delete(),this.input.backward(n)||n.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),$a=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.multiply(this.input.value),n=t.addMultiplyScalar(1,1);t.delete();var a=n.sqrt();n.delete();var i=e.divide(a);a.delete(),this.input.backward(i)||i.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),ei=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.sin(),n=e.multiply(t,-1);t.delete(),this.input.backward(n)||n.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),ti=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.multiply(this.input.value),n=t.addMultiplyScalar(-1,1);t.delete();var a=n.sqrt();n.delete();var i=e.divide(a,-1);a.delete(),this.input.backward(i)||i.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),ni=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.sinh(),n=e.multiply(t);t.delete(),this.input.backward(n)||n.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),ai=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.multiply(this.input.value),n=t.addMultiplyScalar(1,-1);t.delete();var a=n.sqrt();n.delete();var i=e.divide(a);a.delete(),this.input.backward(i)||i.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),ii=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.cos(),n=t.multiply(t);t.delete();var a=e.divide(n);n.delete(),this.input.backward(a)||a.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),ri=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.multiply(this.input.value),n=t.addMultiplyScalar(1,1);t.delete();var a=e.divide(n);n.delete(),this.input.backward(a)||a.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),si=function(){function e(t,n){Object(f.a)(this,e),this.input=t,this.tanH=n}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.tanH.multiply(this.tanH),n=t.addMultiplyScalar(-1,1);t.delete();var a=e.multiply(n);n.delete(),this.input.backward(a)||a.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),oi=function(){function e(t){Object(f.a)(this,e),this.input=t}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.multiply(this.input.value),n=t.addMultiplyScalar(-1,1);t.delete();var a=e.divide(n);n.delete(),this.input.backward(a)||a.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),ui=function(){function e(t,n,a){Object(f.a)(this,e),this.input=t,this.sumDims=n,this.keepDims=a}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.getShape(),n=this.input.value.sum(this.sumDims,this.keepDims),a=e.divide(n);if(n.delete(),!this.keepDims){for(var i=[],r=0,s=0;s<t.length;s++)r<this.sumDims.length&&this.sumDims[r]===s?(i.push(1),r++):i.push(t[s]);a=a.reshape(i,!1)}var o=a.expand(t);a.delete(),this.input.backward(o)||o.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),ci=function(){function e(t,n,a){Object(f.a)(this,e),this.input=t,this.sumDims=n,this.keepDims=a}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.getShape(),n=this.input.value.exp(),a=n.sum(this.sumDims,!0),i=n.divide(a);if(n.delete(),a.delete(),!this.keepDims){for(var r=[],s=0,o=0;o<t.length;o++)s<this.sumDims.length&&this.sumDims[s]===o?(r.push(1),s++):r.push(t[o]);e=e.reshape(r,!1)}var u=e.expand(t),c=u.multiply(i);u.delete(),this.input.backward(c)||c.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),hi=function(){function e(t,n,a){Object(f.a)(this,e),this.input=t,this.power=n,this.factor=a}return Object(d.a)(e,[{key:"backward",value:function(e){var t=this.input.value.powerScalar(this.power-1,this.factor*this.power),n=e.multiply(t);t.delete(),this.input.backward(n)||n.delete()}},{key:"delete",value:function(){this.input.isLeaf()||this.input.delete()}}]),e}(),li=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a){var i;return Object(f.a)(this,n),(i=t.call(this,e.dtype)).value=e,void 0===a&&(a={}),i.grad=a.grad,void 0!==a.backEdge&&(i.backEdge=a.backEdge),i.noGrad=a.noGrad||!1,i}return Object(d.a)(n,[{key:"cast",value:function(e){throw new Error("Method not implemented.")}},{key:"backward",value:function(e){if(void 0===e){var t=this.value.getShape();if(1!==t.length||1!==t[0])throw new Error("Backward without an input gradient can only be done for tensors with shape [1]");e=this.value}var n=!1;if(void 0!==this.grad){var a=this.grad;this.grad=this.grad.add(e),a.delete()}else this.grad=e,n=!0;return void 0!==this.backEdge&&this.backEdge.backward(e),n}},{key:"isLeaf",value:function(){return void 0===this.backEdge}},{key:"constantLike",value:function(e){return new n(this.value.constantLike(e),{noGrad:!0})}},{key:"singleConstant",value:function(e){return new n(this.value.singleConstant(e),{noGrad:!0})}},{key:"getValues",value:function(){return this.value.getValues()}},{key:"getShape",value:function(){return this.value.getShape()}},{key:"delete",value:function(){this.value.delete(),void 0!==this.grad&&this.grad.delete(),void 0!==this.backEdge&&this.backEdge.delete()}},{key:"reshape_impl",value:function(e,t){return new n(this.value.reshape(e),{backEdge:this.noGrad?void 0:new Da(this),noGrad:this.noGrad})}},{key:"exp",value:function(){var e=this.value.exp();return new n(e,{backEdge:this.noGrad?void 0:new xa(this,e),noGrad:this.noGrad})}},{key:"log",value:function(){return new n(this.value.log(),{backEdge:this.noGrad?void 0:new Oa(this),noGrad:this.noGrad})}},{key:"sqrt",value:function(){var e=this.value.sqrt();return new n(e,{backEdge:this.noGrad?void 0:new Aa(this,e),noGrad:this.noGrad})}},{key:"abs",value:function(){return new n(this.value.abs(),{backEdge:this.noGrad?void 0:new ba(this),noGrad:this.noGrad})}},{key:"sin",value:function(){return new n(this.value.sin(),{backEdge:this.noGrad?void 0:new Ja(this),noGrad:this.noGrad})}},{key:"cos",value:function(){return new n(this.value.cos(),{backEdge:this.noGrad?void 0:new ei(this),noGrad:this.noGrad})}},{key:"tan",value:function(){return new n(this.value.tan(),{backEdge:this.noGrad?void 0:new ii(this),noGrad:this.noGrad})}},{key:"asin",value:function(){return new n(this.value.asin(),{backEdge:this.noGrad?void 0:new Ka(this),noGrad:this.noGrad})}},{key:"acos",value:function(){return new n(this.value.acos(),{backEdge:this.noGrad?void 0:new ti(this),noGrad:this.noGrad})}},{key:"atan",value:function(){return new n(this.value.atan(),{backEdge:this.noGrad?void 0:new ri(this),noGrad:this.noGrad})}},{key:"sinh",value:function(){return new n(this.value.sinh(),{backEdge:this.noGrad?void 0:new Qa(this),noGrad:this.noGrad})}},{key:"cosh",value:function(){return new n(this.value.cosh(),{backEdge:this.noGrad?void 0:new ni(this),noGrad:this.noGrad})}},{key:"tanh",value:function(){var e=this.value.tanh();return new n(e,{backEdge:this.noGrad?void 0:new si(this,e),noGrad:this.noGrad})}},{key:"asinh",value:function(){return new n(this.value.asinh(),{backEdge:this.noGrad?void 0:new $a(this),noGrad:this.noGrad})}},{key:"acosh",value:function(){return new n(this.value.acosh(),{backEdge:this.noGrad?void 0:new ai(this),noGrad:this.noGrad})}},{key:"atanh",value:function(){return new n(this.value.atanh(),{backEdge:this.noGrad?void 0:new oi(this),noGrad:this.noGrad})}},{key:"sigmoid",value:function(){var e=this.value.sigmoid();return new n(e,{backEdge:this.noGrad?void 0:new Ya(this,e),noGrad:this.noGrad})}},{key:"hardSigmoid",value:function(e,t){throw new Error("Method not implemented.")}},{key:"sign",value:function(){return new n(this.value.sign())}},{key:"negate",value:function(){return new n(this.value.negate(),{backEdge:this.noGrad?void 0:new Sa(this),noGrad:this.noGrad})}},{key:"addMultiplyScalar",value:function(e,t){return new n(this.value.addMultiplyScalar(e,t),{backEdge:this.noGrad?void 0:new Wa(this,e),noGrad:this.noGrad})}},{key:"powerScalar",value:function(e,t){return new n(this.value.powerScalar(e,t),{backEdge:this.noGrad?void 0:new hi(this,e,t),noGrad:this.noGrad})}},{key:"setValues",value:function(e,t){throw new Error("Method not implemented.")}},{key:"matMul",value:function(e){if(!(e instanceof n))throw new Error("MatMul can only be done with another variable");var t=this.noGrad&&e.noGrad;return new n(this.value.matMul(e.value),{backEdge:t?void 0:new ja(this,e),noGrad:t})}},{key:"concat",value:function(e,t){if(!(e instanceof n))throw new Error("Concat can only be done with another variable");var a=this.noGrad&&e.noGrad;return new n(this.value.concat(e.value,t),{backEdge:a?void 0:new Ma(this,e,t),noGrad:a})}},{key:"clip",value:function(e,t){return new n(this.value.clip(e,t),{backEdge:this.noGrad?void 0:new Ia(this,e,t),noGrad:this.noGrad})}},{key:"clipBackward",value:function(e,t,n){throw new Error("Clip backward not implemented for Variable")}},{key:"repeat",value:function(e){return new n(this.value.repeat(e),{backEdge:this.noGrad?void 0:new Ta(this,e),noGrad:this.noGrad})}},{key:"expand",value:function(e){return new n(this.value.expand(e),{backEdge:this.noGrad?void 0:new Va(this,e),noGrad:this.noGrad})}},{key:"copy",value:function(){return new n(this.value.copy(),{grad:void 0!==this.grad?this.grad.copy():void 0})}},{key:"gather",value:function(e,t){throw new Error("Method not implemented.")}},{key:"floor",value:function(){return new n(this.value.floor())}},{key:"ceil",value:function(){return new n(this.value.ceil())}},{key:"round",value:function(){return new n(this.value.round())}},{key:"upsample",value:function(e){throw new Error("Method not implemented.")}},{key:"normalize",value:function(e,t,n,a,i){throw new Error("Method not implemented.")}},{key:"add_impl",value:function(e,t,a,i,r){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only add Variable tensor to Variable tensor");var s=e.noGrad&&t.noGrad;return new n(e.value.add_impl(e.value,t.value,a,i,r),{backEdge:s?void 0:new Xa(e,t,a,i,r),noGrad:s})}},{key:"subtract_impl",value:function(e,t,a,i,r){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only add Variable tensor to Variable tensor");var s=e.noGrad&&t.noGrad;return new n(e.value.subtract_impl(e.value,t.value,a,i,r),{backEdge:s?void 0:new Ca(e,t,a,i,r),noGrad:s})}},{key:"multiply_impl",value:function(e,t,a,i){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only add Variable tensor to Variable tensor");var r=e.noGrad&&t.noGrad;return new n(e.value.multiply_impl(e.value,t.value,a,i),{backEdge:r?void 0:new _a(e,t,a,i),noGrad:r})}},{key:"divide_impl",value:function(e,t,a,i){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only divide Variable tensor by Variable tensor");var r=e.value.divide_impl(e.value,t.value,a,i),s=e.noGrad&&t.noGrad;return new n(r,{backEdge:s?void 0:new Ea(e,t,r,a,i),noGrad:s})}},{key:"power_impl",value:function(e,t,a){if(!(t instanceof n)||!(e instanceof n))throw new Error("Can only take Variable tensor to power of Variable tensor");var i=e.value.power_impl(e.value,t.value,a),r=e.noGrad&&t.noGrad;return new n(i,{backEdge:r?void 0:new Ra(e,t,i,a),noGrad:r})}},{key:"gemm_impl",value:function(e,t,a,i,r,s){if(!(e instanceof n)||void 0!==s&&!(s instanceof n))throw new Error("Can only do gemm with variable tensors");var o=this.noGrad&&e.noGrad&&(void 0===s||s.noGrad);return new n(this.value.gemm_impl(e.value,t,a,i,r,void 0!==s?s.value:void 0),{backEdge:o?void 0:new Pa(this,e,t,a,i,r,s),noGrad:o})}},{key:"sum_impl",value:function(e,t){return new n(this.value.sum(e,t),{backEdge:this.noGrad?void 0:new za(this,e,t),noGrad:this.noGrad})}},{key:"sumSquare_impl",value:function(e,t){return new n(this.value.sumSquare(e,t),{backEdge:this.noGrad?void 0:new Ba(this,e,t),noGrad:this.noGrad})}},{key:"product_impl",value:function(e,t){var a=this.value.product(e,t);return new n(a,{backEdge:this.noGrad?void 0:new Za(this,a,e,t),noGrad:this.noGrad})}},{key:"max_impl",value:function(e,t){throw new Error("Method not implemented.")}},{key:"min_impl",value:function(e,t){throw new Error("Method not implemented.")}},{key:"reduceMean_impl",value:function(e,t){return new n(this.value.reduceMean(e,t),{backEdge:this.noGrad?void 0:new La(this,e,t),noGrad:this.noGrad})}},{key:"reduceMeanSquare_impl",value:function(e,t){return new n(this.value.reduceMeanSquare(e,t),{backEdge:this.noGrad?void 0:new Fa(this,e,t),noGrad:this.noGrad})}},{key:"reduceLogSum_impl",value:function(e,t){return new n(this.value.reduceLogSum(e,t),{backEdge:this.noGrad?void 0:new ui(this,e,t),noGrad:this.noGrad})}},{key:"reduceLogSumExp_impl",value:function(e,t){return new n(this.value.reduceLogSumExp(e,t),{backEdge:this.noGrad?void 0:new ci(this,e,t),noGrad:this.noGrad})}},{key:"conv_impl",value:function(e,t,a,i,r,s,o){if(!(e instanceof n)||void 0!==o&&!(o instanceof n))throw new Error("Can only do convolution with variable as kernel and bias");if("id"!==s)throw new Error("Activation has to be ID for convolution with variables");var u=this.noGrad&&e.noGrad&&(void 0===o||o.noGrad);return new n(this.value.conv(e.value,void 0!==o?o.value:void 0,t,a,i,r),{backEdge:u?void 0:new Ga(this,e,r,i,t,a,o),noGrad:u})}},{key:"convTranspose_impl",value:function(e,t,n,a,i){throw new Error("Method not implemented.")}},{key:"pad_impl",value:function(e,t,a){return new n(this.value.pad(e,t,a),{backEdge:this.noGrad?void 0:new Ha(this,e,t,a),noGrad:this.noGrad})}},{key:"averagePool_impl",value:function(e,t,a,i){return new n(this.value.averagePool(e,t,a,i),{backEdge:this.noGrad?void 0:new qa(this,e,t,a,i),noGrad:this.noGrad})}},{key:"transpose_impl",value:function(e){return new n(this.value.transpose(e),{backEdge:this.noGrad?void 0:new Ua(this,e),noGrad:this.noGrad})}},{key:"slice_impl",value:function(e,t,a,i){return new n(this.value.slice(e,t,a,i),{backEdge:this.noGrad?void 0:new Na(this,e,t,a,i),noGrad:this.noGrad})}}],[{key:"create",value:function(e,t,a,i,r){return void 0===r&&(r="float32"),new n("CPU"===a?new B(e,t):"WASM"===a?new bn(t,new Uint32Array(e),r):new ot(t,e,r),i)}},{key:"fromData",value:function(e,t){return new n(ot.fromData(e),t)}}]),n}(D),pi=function(e,t,n,a){return new(n||(n=Promise))((function(i,r){function s(e){try{u(a.next(e))}catch(t){r(t)}}function o(e){try{u(a.throw(e))}catch(t){r(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}u((a=a.apply(e,t||[])).next())}))},fi=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e,a,i){var r;Object(f.a)(this,n),r=t.call(this),i=void 0===i||i;var s=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,a=[],i=0;i<e;i+=2){var r=H(),s=Object(x.a)(r,2),o=s[0],u=s[1];a.push(o*n+t),i<e-1&&a.push(u*n+t)}return a}(e*a,0,2/(e+a)),o=new B([e,a],s);if(r.weights=new li(o),i){var u=new Array(a).fill(0),c=new B([1,a],u);r.bias=new li(c)}return r}return Object(d.a)(n,[{key:"forward",value:function(e){return pi(this,void 0,void 0,c.a.mark((function t(){return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",[e[0].gemm(this.weights,!1,!1,1,this.bias)]);case 1:case"end":return t.stop()}}),t,this)})))}}]),n}(aa),di=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(){return Object(f.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"forward",value:function(e){return pi(this,void 0,void 0,c.a.mark((function t(){return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",[e[0].clip(0)]);case 1:case"end":return t.stop()}}),t)})))}}]),n}(aa),vi=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e){var a;return Object(f.a)(this,n),(a=t.call(this)).modules=e,a}return Object(d.a)(n,[{key:"forward",value:function(e){return pi(this,void 0,void 0,c.a.mark((function t(){var n,a,i,r;return c.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=e,a=0;case 2:if(!(a<this.modules.length)){t.next=11;break}return i=n,t.next=6,this.modules[a].forward(n);case 6:if(n=t.sent,"inference"===this.mode&&a>0)for(r=0;r<i.length;r++)i[r].delete();case 8:a++,t.next=2;break;case 11:return t.abrupt("return",n);case 12:case"end":return t.stop()}}),t,this)})))}},{key:"getSubModules",value:function(){return Object(w.a)(Object(k.a)(n.prototype),"getSubModules",this).call(this).concat(this.modules)}}]),n}(aa),mi=n(131),yi=n(136),gi=n(137),wi=n(140),ki=n(139),bi=n(141),xi=n(138),Oi=n(142),ji=n(135),Si=[{name:"Cosine",start:0,end:2*Math.PI,f:function(e){return Math.cos(e)}},{name:"Cubic Polynomial",start:-2*Math.PI,end:2*Math.PI,f:function(e){return 3*e*e*e-2*e*e}},{name:"Sine",start:0,end:2*Math.PI,f:function(e){return Math.sin(e)}}],Ai=function(e){Object(v.a)(n,e);var t=Object(m.a)(n);function n(e){var a;return Object(f.a)(this,n),(a=t.call(this,e)).state={curves:[],losses:[],noise:.01,optimizer:"Adam",numSamples:100,numIterations:1e3,function:0},a}return Object(d.a)(n,[{key:"uniform",value:function(e,t,n){for(var a=[],i=0;i<n;i++){var r=i/n*(t-e)+e;a.push(r)}return a}},{key:"random",value:function(e,t,n){for(var a=[],i=0;i<n;i++){var r=Math.random()*(t-e)+e;a.push(r)}return a=a.sort()}},{key:"getFunctionValue",value:function(e){return Si[this.state.function].f(e)}},{key:"getFunctionRange",value:function(){return{start:Si[this.state.function].start,end:Si[this.state.function].end}}},{key:"generateYs",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;console.log(t);for(var n=[],a=0;a<e.length;a++){var i=this.getFunctionValue(e[a])+Math.random()*t-t/2;n.push(i)}return n}},{key:"doStuff",value:function(){var e=Object(p.a)(c.a.mark((function e(){var t,n,a,i,r,s,o,u,p,f,d,v,m,y,g,w,k,b,x,O,j,S,A,M,I,T,V,D,X,C,_,G,E,R,P,U,z,B,W,L,F;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setState(Object(l.a)(Object(l.a)({},this.state),{},{curves:[],trainData:void 0})),t=new fi(1,128),n=new di,a=new fi(128,128),i=new di,r=new fi(128,64),s=new di,o=new fi(64,1),u="GPU",p=new vi([t,n,a,i,r,s,o]),e.next=12,p.toBackend(u);case 12:return f="Adam"===this.state.optimizer?new ya(p):new ga(p,.5),d=this.getFunctionRange(),v=d.start,m=d.end,y=this.state.numSamples,g=this.uniform(v,m,y),w=this.generateYs(g),k=this.state.curves||[],this.setState(Object(l.a)(Object(l.a)({},this.state),{},{curves:[].concat(Object(h.a)(k),[{name:"Ground truth",xs:g,ys:w}])})),b=this.random(v,m,y),x=this.generateYs(b,this.state.noise),5,O=this.random(v,m,y/5),j=this.generateYs(O,this.state.noise),this.setState(Object(l.a)(Object(l.a)({},this.state),{},{trainData:{name:"Train Data",xs:b,ys:x},valData:{name:"Validation Data",xs:O,ys:j}})),S=li.create([y,1],b,u,{noGrad:!0}),A=li.create([y,1],x,u,{noGrad:!0}),M=li.create([y/5,1],O,u,{noGrad:!0}),I=li.create([y/5,1],j,u,{noGrad:!0}),e.next=31,new Promise((function(e,t){setTimeout((function(){e(0)}),1e3)}));case 31:T=Date.now(),V=[],D=[],X=[],C=20,_=0;case 37:if(!(_<this.state.numIterations)){e.next=71;break}return e.next=40,p.forward([S]);case 40:if(G=e.sent[0],E=G.subtract(A),(R=E.reduceMeanSquare()).backward(),f.step(),_%C!==0){e.next=51;break}return e.next=48,R.value.getValues();case 48:P=e.sent[0],D.push(P),V.push(_);case 51:if(R.delete(),f.zeroGrads(),_%C!==0){e.next=68;break}return e.next=56,p.forward([M]);case 56:return U=e.sent[0],z=U.subtract(I),B=z.reduceMeanSquare(),e.next=61,B.value.getValues();case 61:return W=e.sent[0],X.push(W),B.delete(),f.zeroGrads(),this.setState(Object(l.a)(Object(l.a)({},this.state),{},{trainProgress:_/this.state.numIterations*100})),e.next=68,new Promise((function(e,t){setTimeout((function(){e(0)}),50)}));case 68:_++,e.next=37;break;case 71:return L=Date.now(),console.log("Done, took ".concat(L-T,"ms")),this.setState(Object(l.a)(Object(l.a)({},this.state),{},{trainProgress:void 0,losses:[{name:"Train loss",xs:V,ys:D},{name:"Validation loss",xs:V,ys:X}]})),e.next=76,p.forward([S]);case 76:return e.next=78,e.sent[0].getValues();case 78:F=e.sent,this.setState(Object(l.a)(Object(l.a)({},this.state),{},{curves:[].concat(Object(h.a)(this.state.curves),[{name:"Predicition",xs:g,ys:Array.from(F)}])}));case 80:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this;return Object(a.jsxs)("div",{className:"App",children:[Object(a.jsx)("h1",{children:"Training visualization"}),this.renderSettings(),Object(a.jsx)(mi.a,{color:"primary",onClick:function(){return e.doStuff()},children:"Run training"}),Object(a.jsx)("br",{}),void 0!==this.state.trainProgress?Object(a.jsx)(ji.a,{value:this.state.trainProgress,variant:"determinate"}):Object(a.jsx)(a.Fragment,{}),Object(a.jsx)(yi.a,{item:!0,xs:12,children:Object(a.jsxs)(yi.a,{container:!0,justify:"center",spacing:2,children:[Object(a.jsx)(yi.a,{item:!0,children:this.renderValuePlot()}),Object(a.jsx)(yi.a,{item:!0,children:this.renderLossPlot()})]})})]})}},{key:"renderValuePlot",value:function(){var e=this.state.curves.map((function(e){return{x:e.xs,y:e.ys,type:"scatter",mode:"lines",name:e.name}}));return void 0!==this.state.trainData&&e.push({x:this.state.trainData.xs,y:this.state.trainData.ys,type:"scatter",mode:"markers",name:"Training data"}),void 0!==this.state.valData&&e.push({x:this.state.valData.xs,y:this.state.valData.ys,type:"scatter",mode:"markers",name:"Validation data"}),Object(a.jsx)(g.a,{data:e,layout:{width:600,height:400,title:"Ground truth and learned curve"},config:{showTips:!1,displaylogo:!1,modeBarButtons:!1}})}},{key:"renderLossPlot",value:function(){var e=this.state.losses.map((function(e){return{x:e.xs,y:e.ys,type:"scatter",mode:"lines",name:e.name}}));return Object(a.jsx)(g.a,{data:e,layout:{width:600,height:400,title:"Losses",xaxis:{autorange:!0},yaxis:{type:"log",autorange:!0}},config:{showTips:!1,displaylogo:!1,modeBarButtons:!1}})}},{key:"renderSettings",value:function(){var e=this,t=this.state.noise;return Object(a.jsxs)(yi.a,{container:!0,spacing:2,children:[Object(a.jsx)(yi.a,{item:!0,xs:!0,children:Object(a.jsxs)(gi.a,{children:[Object(a.jsx)(wi.a,{id:"label-function",children:"Function"}),Object(a.jsx)(ki.a,{labelId:"label-function",id:"select-function",value:this.state.function,onChange:function(t,n){return e.setState(Object(l.a)(Object(l.a)({},e.state),{},{function:t.target.value}))},children:Si.map((function(e,t){return Object(a.jsx)(bi.a,{value:t,children:e.name},t)}))})]})}),Object(a.jsxs)(yi.a,{item:!0,xs:!0,children:[Object(a.jsx)(xi.a,{id:"slide-noise",gutterBottom:!0,children:"Noise in training data"}),Object(a.jsx)(Oi.a,{value:t,onChange:function(t,n){return e.setState(Object(l.a)(Object(l.a)({},e.state),{},{noise:n}))},"aria-labelledby":"slider-noise",min:0,max:.4,step:.01,marks:!0,valueLabelDisplay:"auto"})]}),Object(a.jsxs)(yi.a,{item:!0,xs:!0,children:[Object(a.jsx)(xi.a,{id:"slide-n-samples",gutterBottom:!0,children:"Number of samples"}),Object(a.jsx)(Oi.a,{value:this.state.numSamples,onChange:function(t,n){return e.setState(Object(l.a)(Object(l.a)({},e.state),{},{numSamples:n}))},"aria-labelledby":"slider-n-samples",min:50,max:400,step:50,marks:!0,valueLabelDisplay:"auto"})]}),Object(a.jsxs)(yi.a,{item:!0,xs:!0,children:[Object(a.jsx)(xi.a,{id:"slide-n-iterations",gutterBottom:!0,children:"Number of iterations for training"}),Object(a.jsx)(Oi.a,{value:this.state.numIterations,onChange:function(t,n){return e.setState(Object(l.a)(Object(l.a)({},e.state),{},{numIterations:n}))},"aria-labelledby":"slider-n-samples",min:200,max:2e3,step:200,marks:!0,valueLabelDisplay:"auto"})]}),Object(a.jsx)(yi.a,{item:!0,xs:!0,children:Object(a.jsxs)(gi.a,{children:[Object(a.jsx)(wi.a,{id:"label-optimizer",children:"Optimizer"}),Object(a.jsxs)(ki.a,{labelId:"label-optimizer",id:"demo-simple-select-helper",value:this.state.optimizer,onChange:function(t,n){return e.setState(Object(l.a)(Object(l.a)({},e.state),{},{optimizer:t.target.value}))},children:[Object(a.jsx)(bi.a,{value:"Adam",children:"Adam"}),Object(a.jsx)(bi.a,{value:"SGD",children:"SGD"})]})]})})]})}}]),n}(r.a.Component),Mi=function(e){e&&e instanceof Function&&n.e(4).then(n.bind(null,147)).then((function(t){var n=t.getCLS,a=t.getFID,i=t.getFCP,r=t.getLCP,s=t.getTTFB;n(e),a(e),i(e),r(e),s(e)}))};o.a.render(Object(a.jsx)(r.a.StrictMode,{children:Object(a.jsx)(Ai,{})}),document.getElementById("root")),Mi()},77:function(e,t,n){},79:function(e,t,n){}},[[101,1,2]]]);
//# sourceMappingURL=main.a811a158.chunk.js.map